name: API Validation (Dispatch)

on:
  workflow_dispatch:

jobs:
  manual-stateful-api-check:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: tea_shop
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y netcat-openbsd jq

      - name: Build tea-api
        working-directory: tea-api
        run: |
          go mod download
          go build -o tea-api

      - name: Start tea-api server
        working-directory: tea-api
        env:
          TEA_DATABASE_HOST: 127.0.0.1
          TEA_DATABASE_PORT: 3306
          TEA_DATABASE_USERNAME: root
          TEA_DATABASE_PASSWORD: root
          TEA_DATABASE_DBNAME: tea_shop
          REDIS_ADDR: 127.0.0.1:6379
          TEA_AUTO_MIGRATE: "1"
        run: |
          mkdir -p ../build-ci-logs
          ./tea-api > ../build-ci-logs/tea-api.out 2>&1 & echo $! > ../build-ci-logs/tea-api.pid
          # wait for health endpoint
          for i in $(seq 1 30); do
            if curl -sS http://127.0.0.1:9292/api/v1/health | grep -q '"status"\s*:\s*"ok"'; then
              echo "API healthy"; break; fi; sleep 2; done
          curl -sS http://127.0.0.1:9292/api/v1/health || true

      - name: Seed minimal data via HTTP (admin login + create defaults)
        env:
          BASE_URL: http://127.0.0.1:9292
        run: |
          set -euo pipefail
          echo "HTTP seeding minimal data: category/store/product"
          mkdir -p build-ci-logs
          RESP_FILE="build-ci-logs/admin_login_response.json"
          # Attempt unified admin login
          curl -sS -H 'Content-Type: application/json' -d '{"username":"admin","password":"pass"}' "$BASE_URL/api/v1/auth/login" -o "$RESP_FILE" || true
          TOKEN=$(jq -r '.data.token // .token // empty' "$RESP_FILE" 2>/dev/null || echo "")
          if [[ -z "$TOKEN" ]]; then
            # Fallback legacy user/login
            curl -sS -H 'Content-Type: application/json' -d '{"username":"admin","password":"pass"}' "$BASE_URL/api/v1/user/login" -o "$RESP_FILE" || true
            TOKEN=$(jq -r '.data.token // .token // empty' "$RESP_FILE" 2>/dev/null || echo "")
          fi
          if [[ -z "$TOKEN" ]]; then
            # Fallback dev-login
            curl -sS -H 'Content-Type: application/json' -d '{"openid":"admin_openid"}' "$BASE_URL/api/v1/user/dev-login" -o "$RESP_FILE" || true
            TOKEN=$(jq -r '.data.token // .token // empty' "$RESP_FILE" 2>/dev/null || echo "")
          fi
          AUTH_HEADER=""
          if [[ -n "$TOKEN" ]]; then AUTH_HEADER="Authorization: Bearer $TOKEN"; fi
          echo "Seed auth: ${AUTH_HEADER:+token-present}"

          # Categories: create default if empty
          CATS=$(curl -sS -X GET "$BASE_URL/api/v1/categories" || echo '{}')
          TOTAL=$(echo "$CATS" | jq -r '.total // ( .data|length ) // 0' 2>/dev/null || echo 0)
          if [[ "$TOTAL" == "0" || -z "$TOTAL" ]]; then
            echo "Creating default category"
            curl -sS -X POST -H 'Content-Type: application/json' ${AUTH_HEADER:+-H "$AUTH_HEADER"} -d '{"name":"默认分类","description":"","image":"","sort":0,"status":1}' "$BASE_URL/api/v1/categories" | tee build-ci-logs/seed_category_resp.json || true
          else
            echo "Categories already present: $TOTAL"
          fi

          # Stores: create default if empty
          STORES=$(curl -sS -X GET "$BASE_URL/api/v1/stores?page=1&size=10" || echo '{}')
          ST_TOTAL=$(echo "$STORES" | jq -r '.total // ( .data|length ) // 0' 2>/dev/null || echo 0)
          if [[ "$ST_TOTAL" == "0" || -z "$ST_TOTAL" ]]; then
            echo "Creating default store"
            curl -sS -X POST -H 'Content-Type: application/json' ${AUTH_HEADER:+-H "$AUTH_HEADER"} -d '{"name":"测试门店","address":"上海某路1号","phone":"12345678","latitude":31.2304,"longitude":121.4737,"business_hours":"09:00-21:00","images":[]}' "$BASE_URL/api/v1/stores" | tee build-ci-logs/seed_store_resp.json || true
          else
            echo "Stores already present: $ST_TOTAL"
          fi

          # Products: create default if empty
          PRODS=$(curl -sS -X GET "$BASE_URL/api/v1/products?page=1&size=10" || echo '{}')
          PD_TOTAL=$(echo "$PRODS" | jq -r '.total // ( .data|length ) // 0' 2>/dev/null || echo 0)
          CAT_ID=$(echo "$CATS" | jq -r '.data[0].id // empty' 2>/dev/null || echo "")
          if [[ -z "$CAT_ID" ]]; then
            CAT_ID=$(curl -sS -X GET "$BASE_URL/api/v1/categories" | jq -r '.data[0].id // empty' 2>/dev/null || echo "")
          fi
          if [[ "$PD_TOTAL" == "0" || -z "$PD_TOTAL" ]]; then
            echo "Creating default product (category_id=${CAT_ID:-1})"
            BODY=$(jq -n --argjson cid "${CAT_ID:-1}" '{name:"测试商品",description:"自动化测试用商品",images:[],price:19.99,original_price:19.99,stock:100,status:1,category_id:($cid|tonumber)}')
            curl -sS -X POST -H 'Content-Type: application/json' ${AUTH_HEADER:+-H "$AUTH_HEADER"} -d "$BODY" "$BASE_URL/api/v1/products" | tee build-ci-logs/seed_product_resp.json || true
          else
            echo "Products already present: $PD_TOTAL"
          fi

          echo "HTTP seeding completed."

      - name: Run stateful API validation
        env:
          BASE_URL: http://127.0.0.1:9292
        run: |
          bash scripts/local_api_check.sh | tee build-ci-logs/api-validation-stateful-$(date +%Y%m%d%H%M%S).log

      - name: Admin login (token for assertions)
        run: |
          mkdir -p build-ci-logs
          RESP_FILE="build-ci-logs/admin_login_response.json"
          curl -sS -H 'Content-Type: application/json' -d '{"username":"admin","password":"pass"}' "http://127.0.0.1:9292/api/v1/auth/login" -o "$RESP_FILE" || true

      - name: Sprint A verification assertions (non-blocking)
        continue-on-error: true
        run: |
          make verify-sprint-a-strict

      - name: Archive validation logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-validation-logs
          retention-days: 7
          path: |
            build-ci-logs/api_validation/**
            build-ci-logs/api_validation_stateful/**
            build-ci-logs/api-validation-*.log
            build-ci-logs/api-validation-stateful-*.log
            build-ci-logs/tea-api.out
            build-ci-logs/admin_login_response.json
            build-ci-logs/order_detail_*_checked.json
            build-ci-logs/order_detail_*.json
            build-ci-logs/order_amounts_summary.json
            build-ci-logs/local_api_summary.txt

      - name: Stop tea-api
        if: always()
        run: |
          if [[ -f build-ci-logs/tea-api.pid ]]; then kill $(cat build-ci-logs/tea-api.pid) || true; fi
