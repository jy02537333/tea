name: Standardize PR footer links after merge

on:
  pull_request:
    types: [closed]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  update-footer:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Prepare variables
        shell: bash
        run: |
          set -e
          REPO="${{ github.repository }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "REPO=$REPO" >> "$GITHUB_ENV"
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"

      - name: Check docs exist on master
        shell: bash
        env:
          REPO: ${{ env.REPO }}
        run: |
          set -e
          DOC_URL="https://api.github.com/repos/${REPO}/contents/docs/ci/minimal-integration.md?ref=master"
          CONTRIB_URL="https://api.github.com/repos/${REPO}/contents/CONTRIBUTING.md?ref=master"
          DOC_STATUS=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "$DOC_URL" -o /dev/null -w "%{http_code}")
          CONTRIB_STATUS=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "$CONTRIB_URL" -o /dev/null -w "%{http_code}")
          echo "DOC_EXISTS=$([ "$DOC_STATUS" = "200" ] && echo 1 || echo 0)" >> "$GITHUB_ENV"
          echo "CONTRIB_EXISTS=$([ "$CONTRIB_STATUS" = "200" ] && echo 1 || echo 0)" >> "$GITHUB_ENV"

      - name: Fetch PR body
        shell: bash
        env:
          REPO: ${{ env.REPO }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
        run: |
          set -e
          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}" | jq -r .body > body.md
          awk '/^### PR 描述固定尾注/{exit} {print}' body.md > body_prefix.md

      - name: Build standardized footer
        shell: bash
        env:
          REPO: ${{ env.REPO }}
          DOC_EXISTS: ${{ env.DOC_EXISTS }}
          CONTRIB_EXISTS: ${{ env.CONTRIB_EXISTS }}
        run: |
          set -e
          : > footer.md
          if [ "${DOC_EXISTS}" = "1" ]; then
            printf "\n---\n\n### PR 描述固定尾注\n- [CI 临时开启严格模式指引](docs/ci/minimal-integration.md)\n" >> footer.md
            if [ "${CONTRIB_EXISTS}" = "1" ]; then
              printf "- 更多 CI 与联调指南见 [CONTRIBUTING.md](CONTRIBUTING.md)\n" >> footer.md
            fi
          else
            # Fallback: point to CI docs directory on master if file not found
            printf "\n---\n\n### PR 描述固定尾注\n- [CI 临时开启严格模式指引](https://github.com/${REPO}/tree/master/docs/ci)\n" >> footer.md
          fi
          cat body_prefix.md footer.md > new_body.md
          jq -Rs '{body: .}' < new_body.md > payload.json

      - name: Patch PR body
        shell: bash
        env:
          REPO: ${{ env.REPO }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
        run: |
          set -e
          curl -s -X PATCH -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            -d @payload.json "https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}" | jq -r .body | grep -q "PR 描述固定尾注"

      - name: Verify footer links
        shell: bash
        env:
          REPO: ${{ env.REPO }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
        run: |
          set -e
          curl -s -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.html+json" \
            "https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}" | jq -r .body_html > body.html
          REL_CI_OK=0
          REL_CONTRIB_OK=0
          grep -q 'href="docs/ci/minimal-integration.md"' body.html && REL_CI_OK=1 || true
          grep -q 'href="CONTRIBUTING.md"' body.html && REL_CONTRIB_OK=1 || true
          echo "REL_CI_OK=$REL_CI_OK" >> "$GITHUB_ENV"
          echo "REL_CONTRIB_OK=$REL_CONTRIB_OK" >> "$GITHUB_ENV"

      - name: Comment result to PR
        shell: bash
        env:
          REPO: ${{ env.REPO }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
          REL_CI_OK: ${{ env.REL_CI_OK }}
          REL_CONTRIB_OK: ${{ env.REL_CONTRIB_OK }}
        run: |
          set -e
          CI_STATUS=$([ "$REL_CI_OK" = "1" ] && echo "✅ CI 文档相对链接有效 (docs/ci/minimal-integration.md)" || echo "⚠️ CI 文档相对链接未检测到，已回退为目录链接或需补文档")
          CONTRIB_STATUS=$([ "$REL_CONTRIB_OK" = "1" ] && echo "✅ CONTRIBUTING 相对链接有效 (CONTRIBUTING.md)" || echo "ℹ️ CONTRIBUTING 链接未添加（master 不存在或暂不恢复）")
          COMMENT=$(cat << 'EOF'
合并后自动验证结果：

- ${CI_STATUS}
- ${CONTRIB_STATUS}

说明：本工作流在合并后统一将“PR 描述固定尾注”链接改为相对路径，若 master 上缺少对应文件，则临时回退为目录链接避免 404。若需恢复 CONTRIBUTING，请先在 master 添加该文件。
EOF
)
          jq -n --arg body "$COMMENT" '{body: $body}' > comment.json
          curl -s -X POST -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            -d @comment.json "https://api.github.com/repos/${REPO}/issues/${PR_NUMBER}/comments" | jq -r .id > /dev/null
