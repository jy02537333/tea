# 茶心阁小程序 — 开发计划（PRD）

- MySQL: `root:gs963852@tcp(127.0.0.1:3308)/tea_shop?charset=utf8mb4&parseTime=True&loc=Local`
- Redis: `127.0.0.1:6379` 密码 `123456`
- RabbitMQ: `amqp://guest:guest@127.0.0.1:5672/`

## Git 推送方式约定（统一使用 Token）

- 推荐：所有开发者统一使用 HTTPS+GitHub Personal Access Token（PAT）进行推送，避免 SSH key 配置差异导致 push 失败。
- 远程地址形态示例：`https://github.com/jy02537333/tea.git`（而非 `git@github.com:jy02537333/tea.git`）。
- 首次推送：执行 `git push` 时，Git 会提示输入用户名和密码：
  - 用户名：填写你的 GitHub 用户名。
  - 密码：填写 PAT（注意不要使用真实登录密码）。
- 建议：在本地 Git Credential Helper 中缓存 PAT，避免每次输入；如需旋转或撤销 PAT，可在 GitHub "Settings → Developer settings → Personal access tokens" 中管理。
- 若 push 因 push protection / secret scan 被阻断，请参考 `tea-api/README.md` 中“开发者注意事项 / 遇到 Push Protection 阻塞时的自助处理”小节，使用 `scripts/remove-secrets.sh` 自助修复后再使用 HTTPS+Token 方式强推。


## 一、概述

- **项目名称**: 茶心阁 小程序及公众号
- **目标**: 构建集商城、门店点单（堂食/外卖）、分销与会员管理于一体的茶文化平台，首版对标「瑞幸咖啡」小程序的 UI 与交互体验，优先保证核心下单和会员/分销功能可用。
- **目标用户**: 普通消费者、会员、合伙人、门店管理员、平台超级管理员

### 1.1 环境与端口配置

- **数据库**：MySQL `root:gs963852@tcp(127.0.0.1:3308)/tea_shop?charset=utf8mb4&parseTime=True&loc=Local`
- **缓存**：Redis `127.0.0.1:6379`（密码 `123456`）
- **消息队列**：RabbitMQ `amqp://guest:guest@127.0.0.1:5672/`
- **服务端口约定**：
  - `tea-api`：HTTP 服务监听 `9292`
  - `admin-fe`：管理后台前端开发服务 `9094`
  - `wx-fe`：小程序 H5/模拟环境开发服务 `9093`

## 二、目标与成功指标

- **上线可用指标**: 小程序首版实现商品浏览、门店点单、在线支付、订单管理、会员开通与基本分销记账。
- **业务指标**: 首月用户注册量、首月有效订单数、合伙人报名数、首月 GMV（建议上线前设定具体目标）。

## 三、范围说明（MVP 与非MVP）

- **MVP（必须交付）**:
  - 商品浏览/分类/详情/搜索
  - 门店列表、门店点单（堂食/外卖）与购物车
  - 订单创建/支付/查看（包括订单状态流转）
  - 用户注册/登录/个人中心（钱包/优惠券/积分/订单）
  - 简单后台：商品管理、订单管理、门店管理、会员管理
  - 基础分销：分享带上推荐人 ID、佣金累积到钱包
- **非MVP（后续迭代）**:
  - 复杂的分销结算自动化（分账到第三方账户、发票规则）
  - 完整合伙人等级自动升级与复杂奖励规则（可在 Phase 2 完成）
  - 高阶营销活动、A/B 测试、个性化推荐

## 四、用户角色（从需求文档摘录）

- **超级管理员**：平台全量管理权限
- **门店管理员**：单门店商品、订单与店员管理
- **店员**：接单、核销、打印
- **用户/会员**：购买、充值、使用优惠、成为合伙人
- **合伙人**：不同等级拿货折扣与推广佣金

## 五、主要功能拆分（按开发模块）

- **前端（小程序）**:
  - 首页：轮播、金刚区、推荐、广告位
  - 商城：分类、筛选、商品详情、分享海报
  - 门店：按距离展示、门店详情、门店点单
  - 购物车与结算：优惠券/茶币/积分应用
  - 我的：订单、会员入口、钱包、积分、客服
- **后台（平台端）**:
  - 商品/分类/库存/运费模板管理
  - 订单管理（发货/退货/售后）
  - 门店管理、会员与合伙人管理
  - 营销：轮播、广告位、优惠券、积分规则
  - 财务与提现管理（基础记录）
- **门店后台（网页版）**:
  - 门店接单/打印/桌码管理/店员管理
  - 店内商品上架（堂食/外卖）
- **分销系统**:
  - 分享链路与推荐关系记录
  - 佣金计算逻辑（见需求文档公式）
  - 钱包/提现（基础规则）

## 四、关联文档索引

为便于研发、测试和运营在阅读本 PRD 时快速跳转到更细的技术说明，相关设计与协作文档汇总如下（路径以仓库根目录为准）：

- **业务/协作类文档**：
  - `docs/features/store-order-link.md`：门店订单入口与跳转链路设计说明（用于对齐小程序与门店/后台的入口关系）。
  - `docs/enable_claude_sonnet45_no_git.md`：本项目在不依赖 Git 操作下使用 AI 助手（Claude/GitHub Copilot 等）的说明，属于团队协作与工具接入文档。
  - `docs/frontend-backend-checklist.md`：前后端联调检查清单，用于在提测/联调前核对 API、字段、状态枚举等是否与 PRD 与 API 文档一致。
  - `docs/migration_instructions_for_dba.md`：DBA 执行数据库迁移的操作指南（包括顺序、回滚策略、注意事项），与 `doc/db_schema.md`、`tea-api/migrations` 配合使用。
  - `docs/ops_login_note.md`：运维/排障过程中关于登录和环境配置的注意事项，主要面向运维与后端同学。
  - `docs/PR-draft-store-order-integration.md`：门店订单相关联动（如门店后台、小程序门店点单）的 Draft 级设计说明，用于补充本 PRD 在门店订单集成上的细节。

- **PRD/需求相关文档**：
  - `doc/prd_feature_checklist.md`：需求文档 5.x 功能清单与本 PRD 各章节的一一映射及完成度标记（[x]/[]），用于评审和排期。
  - `doc/prd_sprints.md`：基于本 PRD 的迭代拆分与 Sprint 规划，说明每个版本的交付范围与优先级。
  - `docs/prd-open-points.md`：本 PRD 中标记为 `[]` 的未完备功能点和后续建议动作（Backlog 视图）。

- **数据与接口设计文档**：
  - `doc/db_schema.md`：核心数据库表结构设计与字段说明（面向后端/DBA），与 API 文档及业务流程对齐。
  - `tea-api/docs/api-orders.md`：订单相关 API（用户端 + 后台端）。
  - `tea-api/docs/api-cart-store-coupon.md`：购物车 / 门店 / 优惠券 API。
  - `tea-api/docs/order-flow-and-states.md`：订单端到端流程与状态机说明。

- **进度与任务状态视图**：
  - `doc/prd.md`（当前文档）：整体产品需求与开发计划的总入口，用于从业务视角把握项目范围与里程碑。
  - `doc/prd_sprints.md`：按 Sprint 拆解的前后端/测试任务列表，并给出关键 API 草案，是迭代排期与执行的主要依据。
  - `doc/prd_feature_checklist.md`：需求文档功能点 ↔ 本 PRD 章节的一一映射表，包含 `[x]/[]/✅` 状态字段，用于评审「设计是否覆盖到位」与粗粒度完成度。
  - `tea-api/docs/progress-report.md`：后端 API 维度的开发进度报告（已完成/进行中/待测试/下一阶段计划），适合后端同学汇报与跟踪实现状态。
  - `docs/features/store-order-link.md`：门店面板 ↔ 订单列表 ↔ 订单操作区的联动设计文档，文末有开发步骤清单，是 M4 方向下门店与订单联动的执行指南。
  - `docs/prd-open-points.md`：PRD 中尚未完全敲定或标记为 `[]` 的开放问题与后续建议动作，可视为产品侧 Backlog 视图。
  - `docs/frontend-backend-checklist.md`：前后端联调与提测前的检查清单，帮助在认为「一个功能已完成」前，从接口、字段、状态枚举等角度做最后一轮自检。
  - Git 分支快照规则：当需要为「某一天的项目整体进度」打快照时，从主开发分支当前提交创建只读分支，命名为 `YYYYMMDD`（例如 `20251209`），该分支仅用于归档当天进度，不在其上继续开发。

> 说明：
> 1）本 PRD 主要聚焦业务与交互层面的「做什么」和「大致怎么做」，具体字段、接口入参与状态流转细节，请以上述技术文档为准，并保持两侧同步维护。
> 2）后续新增任意与本项目相关的设计/运维/协作文档，建议在创建后同步在本节按类别添加一行说明，保持「文档地图」完整，方便新成员快速上手。

## 五、系统流程（文字版）

本节以文字形式描述核心业务流程，串联前端、后端与门店后台在「下单 → 支付 → 履约 → 分销/合伙人结算」中的关键节点，便于研发、测试和运营对齐整体业务路径。

### 5.1 用户下单流程

适用于商城商品和门店商品（堂食/外卖）的一般下单流程，对应需求文档中的「用户进入小程序 → 选择商品/服务 → 选择门店/商城 → 确认订单 → 支付 → 门店接单/发货 → 完成」。

流程步骤：

1. 进入小程序

- 用户打开小程序首页，浏览轮播图、金刚区入口、推荐商品和附近门店列表。

1. 选择商品/服务

- 商城下单：在商城分类/列表页选择商品，加入购物车或直接购买。
- 门店下单：在门店列表选择门店，进入门店点单页（堂食/外卖），选择门店商品/服务加入购物车。

1. 选择门店或确认销售渠道

- 堂食/外卖：必须选择具体门店；支持按定位推荐最近门店或用户手动切换门店。
- 商城：不依赖门店，直接走仓配/平台发货路径。

1. 确认订单

- 进入确认订单页，展示：商品明细、单价、小计、运费/打包费、优惠券可用情况、茶币/积分可用情况。
- 用户可在此选择：
  - 使用优惠券（满减/折扣券等）；
  - 使用茶币/积分抵扣（受规则限制）；
  - 填写收货地址（外卖/商城）；
  - 选择配送方式（自取/配送）和备注。

1. 创建订单

- 前端提交下单请求，后端根据当前价格、库存和优惠规则计算应付金额：
  - 校验库存、商品状态（是否上架）、门店营业状态；
  - 应用优惠券、茶币/积分、满减活动等；
  - 生成订单记录，状态为 `pending_payment`（待支付），并生成唯一 `order_no`。

1. 支付

- 前端拉起微信支付（预留支付宝等扩展），用户完成支付或取消：
  - 支付成功：支付渠道异步回调后端，后端基于 `order_no` 做幂等处理，将订单状态更新为 `paid`（已支付），记录支付流水。
  - 支付失败/取消：订单可保持待支付状态并在超时后自动关闭。

1. 门店接单 / 仓配发货

- 门店订单：
  - 已支付订单自动出现在门店后台「待处理订单」列表；
  - 门店确认接单（状态 `store_accepted`），并根据业务类型：
    - 堂食：制作完成后生成取餐码/二维码，门店在核销页面扫码/输入取餐码完成核销；
    - 外卖：制作完成后选择配送方式（自配送/第三方骑手），录入配送信息，更新订单状态为 `shipped/delivering`。
- 商城订单：
  - 平台仓配或指定门店发货，录入快递公司和运单号，状态更新为 `shipped`。

1. 收货 / 核销

- 堂食：用户到店出示取餐码，门店扫码核销成功后，订单状态更新为 `completed`。
- 外卖/商城：
  - 平台或门店发货后，物流同步签收或用户手动确认收货；
  - 无售后申请/售后完成后，订单状态更新为 `completed`。

1. 后续联动

- 订单完成后触发：
  - 会员积分/茶币发放；
  - 分销佣金冻结入账（见 4.2 和分销结算设计）；
  - 门店/平台数据看板更新（订单量、销售额等）。

状态流转摘要：

- 典型状态：`pending_payment` → `paid` → `store_accepted`（门店单）/`shipped` → `completed` 或 `closed/canceled`。
- 关键节点需有操作日志与时间戳（下单、支付、接单、发货/核销、完成、关闭）。

### 4.2 分销流程

本流程对应需求文档中的「用户 A 分享商品/门店服务 → 用户 B 通过 A 的分享链接购买 → 系统记录关系 → 订单完成后计算佣金给 A → 佣金进入 A 的钱包余额，可提现」，与本 PRD 中的「3.4 分销系统」和「分销结算设计」章节联动。

流程步骤：

1. 发起分享

  - 用户 A 在商品详情页、门店详情页或「我的 → 分享/推广中心」点击分享按钮：
    - 系统生成包含推荐人标识的链接或海报二维码（携带推荐人 user_id 或推广码）。

1. 新用户访问并绑定关系

  - 用户 B 通过 A 的分享链接/海报进入小程序：
    - 未登录/未注册：先完成注册/授权登录，系统在首单或首次有效访问时将 B 与 A 绑定为直推关系；
    - 已有账号但无上级：可按业务规则决定是否允许绑定（一般只允许首次绑定且不可修改）。
  - 系统在推荐关系表中记录 A 与 B 的关系，并可进一步通过闭包表记录上级链路。

1. 下单与支付

  - 用户 B 正常浏览和下单（商城或门店订单），下单时：
    - 订单记录中写入推荐人 ID/推广渠道信息；
    - 支付完成后订单进入已支付状态（参考 4.1）。

1. 订单完成与佣金生成

  - 订单完成（且通过退货/售后风控期）后，由结算任务计算并生成佣金记录：
    - 结算基数 = 商品原价总和 - 优惠券 - 运费 - 各类折扣；
    - 按推荐人当前等级对应的直推比例（10%/30%/40%/45% 等）计算直推佣金；
    - 若存在上级合伙人，则按 10% 的团队管理奖在直推佣金基础上计算间接佣金。
  - 系统在 `commissions` 表写入佣金明细，初始状态为 `frozen`（冻结）。

1. 冻结期与解冻

  - 系统根据配置的风控期（如 7 天）定期扫描达到解冻条件的佣金记录：
    - 未发生退款/退货：状态从 `frozen` 改为 `available`，同时更新到账时间；
    - 若订单发生部分/全额退款：对应佣金标记为 `reversed` 或按比例冲销。

1. 钱包展示与提现入口

  - 用户 A 在「我的 → 钱包/分销中心」可查看：
    - 累计佣金、可提现金额、冻结金额；
    - 佣金明细（订单号、类型：直推/团队/升级、金额、状态）。
  - 满足提现门槛后，用户可发起提现申请，进入佣金结算的提现子流程（详见分销结算设计与财务管理）。

### 4.3 合伙人升级流程

本流程对应需求文档中的「用户申请成为合伙人 → 购买对应等级的礼包 → 支付成功 → 升级为合伙人，获得对应的茶币和权益 → 开始推广」，与本 PRD 中的「会员/合伙人管理」及「分销结算设计」中的升级奖励逻辑联动。

流程步骤：

1. 提交升级/开通申请

  - 用户在「我的 → 开通 VIP/合伙人」中选择目标等级（初级/中级/高级合伙人），查看该等级对应的价格、茶币赠送、拿货折扣、直推佣金比例和团队奖励等权益说明。

1. 生成合伙人礼包订单

  - 用户确认开通或升级后，系统为所选等级生成一笔「合伙人礼包订单」：
    - 订单类型标记为 membership/partner_package；
    - 金额为对应等级礼包价格；
    - 若存在推荐人，则在订单中记录推荐关系，用于后续升级奖励计算。

1. 支付与订单完成

  - 用户通过微信支付完成礼包订单的支付：
    - 支付回调成功后，订单状态更新为 `paid` → `completed`（无需实际发货）；
    - 回调处理逻辑需幂等，避免重复升级或多次发放权益。

1. 升级为合伙人并发放权益

  - 支付成功后，系统执行升级逻辑：
    - 更新用户的 `partner_level` 为对应等级；
    - 按礼包配置发放茶币、优惠券或其它权益；
    - 记录一条等级变更流水（旧等级、新等级、时间、操作来源）。

1. 计算升级奖励（如有）

  - 若用户存在推荐人，且规则允许升级差价奖励：
    - 按「新等级礼包价 - 旧等级礼包价」计算差价基数；
    - 按配置比例为推荐人生成升级奖励佣金记录，写入 `commissions` 表（类型为 `upgrade`）。
  - 升级奖励遵循与普通佣金相同的冻结/解冻与提现规则。

1. 升级后推广与运营展示

  - 用户升级后，在「我的」页面展示新的合伙人等级、拿货折扣和推广收益入口；
  - 分享海报与分销结算逻辑按新等级对应的佣金比例生效；
  - 后台合伙人管理列表中同步展示最新等级与升级时间。

### 3.1.1 首页（产品需求细化） [x]

目标：为用户提供首屏触达的商业内容与转化入口，兼顾运营位与个性化展示，降低用户路径至下单/购买会员/成为合伙人的成本。

功能点：

- 轮播图（Carousel） [x]
  - 支持后台管理：图片、跳转类型（内部页面/商品/门店/外链）、展示时长、启用/停用、投放条件（用户等级/地域/时间段）。
  - 数据模型建议：`id, image_url, target_type, target_id, priority, start_at, end_at, enabled`。
  - 验收：轮播图片能在后台新增/编辑/上下线；点击跳转目标正确。

- 会员/合伙人展示区（Membership Banner） [x]
  - 未登录时显示引导登录/注册按钮；已登录但非会员显示会员权益介绍与开通 CTA；已为合伙人显示等级与推广入口（提现/邀请统计）。
  - 支持按用户等级显示差异化内容（operational banners）。
  - 验收：不同登录/等级状态下展示逻辑正确；会员 CTA 能跳转购买会员页。

- 金刚区（Quick Actions） [x]
  - 固定四格或六格入口：`堂食买单、外卖、商城、门店优惠`（可配置）
  - 后台支持调整顺序与图标文案。
  - 验收：入口跳转正确、可在后台配置顺序/显示开关。

- 商城入口/聚合（Marketplace Preview） [x]
  - 展示分区（推荐商品、热销、新品、本地特色、健康茶叶）和快捷筛选卡片。
  - 推荐商品位支持手动运营配置与自动算法（未来迭代）。
  - 验收：展示数据来源正确，点击商品进入详情页且可发起分享（包含推荐人 ID）。

- 广告位（Ad Slots） [x]
  - 支持多种广告模板（横幅、卡片、角标），可关联优惠券或活动落地页。
  - 广告点击需要支持 UTM 或来源埋点，便于运营转化分析。
  - 验收：广告在设定时间段展示，点击带参数跳转并记录事件。

- 推荐产品（Curated/运营位） [x]
  - 后台可配置的运营位，用于放置专题、礼包或合伙人礼包入口。
  - 验收：运营位可在后台新增/排序、且在前端按权重展示。

接口与后端要点（简要）：

- `GET /api/v1/home/carousels`：返回当前用户可见的轮播集合（支持 filter by user_level/region）
- `GET /api/v1/home/quick-actions`：金刚区入口定义
- `GET /api/v1/home/recommendations`：推荐商品分区（支持运营配置或算法开关）
- `GET /api/v1/home/ads`：首页广告位配置
- 所有写接口由后台管理端提供（Admin 权限），并支持缓存/预渲染以降低首页首屏延迟。

埋点与监控建议：

- 事件：`home_view`、`carousel_click`（包括 `target_type/target_id`）、`quick_action_click`、`ad_click`、`membership_cta_click`、`recommend_product_click`。
- KPI： 首页首屏转化率（点击进入商品详情/下单/会员购买）、轮播点击率、金刚区点击率。

展示与交互注意事项：

- 首屏首要保证首屏渲染性能：将轮播与金刚区数据优先返回，次要位异步加载。
- 视觉规范需与设计稿（Figma）一致：保证轮播图与运营位的安全留白与可点击区域。
- 登录态影响展示内容，应尽量避免阻塞首屏渲染（eg. 弹窗提示登录可延后呈现）。

验收标准（首页）：

- 首屏可见率：95% 用户能在 1s 内看到首屏主要内容（受网络影响参考值）。
- 功能正确性：轮播/金刚区/推荐位在后台配置后生效；不同用户等级看到的 banner 与 CTA 正确。
- 可追踪性：关键事件埋点到位且在 BI 报表中可查询。

### 3.1.2 产品分类（商城产品） [x]

目标：构建清晰的商品分层与筛选体系，便于用户按茶类/产区/用途快速找到目标商品，并支持运营位、标签与品牌/包装等多维筛选。

主要维度： [x]

- 茶类（主分类）：绿茶、红茶、乌龙茶、黑茶、白茶、黄茶、养生茶、花茶、其他茶、茶周边。
- 产区（过滤维度）：云南、福建、浙江、贵州、湖南、四川等（支持省/市/县层级）。
- 用途/场景（标签维度）：送礼、收藏、口粮、散茶、礼盒、礼品套装。

商品属性与筛选项： [x]

- 价格区间（`min_price_cents`, `max_price_cents`）
- 包装类型（散装、礼盒、罐装、袋装等）
- 品牌/产商
- 重量/规格（50g/100g/250g/自定义）
- 工艺/口味（烘焙程度、发酵类型、调味等）
- 是否包邮 / 是否门店自取 / 库存状态
- 标签（手工、古树、野生、有机等，可扩展）

数据模型建议：

- `categories`：`id, name, parent_id, type, slug, sort_order, visible, metadata`（支持树形结构与运营位标记）
- `products`：`id, title, summary, default_image, brand_id, default_price_cents, category_id, tags`
- `product_skus`：`sku_id, product_id, price_cents, stock, weight_grams, spec_json`
- `product_attributes`：`product_id, attr_key, attr_value`（用于灵活扩展包装/产地/工艺等）

前端展示与交互建议：

- 分类页布局：移动端优先使用顶部筛选 + 卡片式商品网格；支持二级/三级分类的面包屑导航。
- 筛选交互：支持多选筛选、可组合筛选（如同时选择多个产区与包装类型），并在页面显示当前筛选条件。支持清除单项/全部筛选。
- 排序选项：综合、销量、价格（升/降）、上新、评价。支持「智能排序」将运营位/推荐位置顶。
- 筛选结果计数：可选地在筛选项显示当前结果数量以提升交互可预期性（受性能限制可异步计算）。

关键接口（示例与参数）：

- `GET /api/v1/categories` — 返回分类树（支持 `include_operational=true` 返回首页/专题绑定信息）
- `GET /api/v1/products` — 支持 query: `category_id`, `tea_type`, `origin`, `use_case`, `min_price_cents`, `max_price_cents`, `packaging`, `brand`, `tags`, `sort`, `page`, `size`
- `GET /api/v1/products/{id}` — 返回商品详情（含 sku 列表、属性、运费模板、门店售卖信息）
- `GET /api/v1/filters/meta` — 返回当前查询条件下可用的筛选项（产区/品牌/包装等），便于前端动态渲染筛选面板

后台/运营支持：

- 运营位（专题/栏目）管理：支持将若干商品或规则（标签/销量/上新）绑定到专题（如“本地特色”、“健康茶叶”），并支持排序/上下线。
- 分类管理：支持树形编辑（增删改）、排序、是否展示到前端、SEO 字段（title/description）与关联图片。

埋点与指标建议：

- 事件：`category_view`, `filter_apply`, `product_list_click`, `product_fav`, `sort_change`
- 指标：分类页转化率（浏览->商品页->下单）、筛选转化率、不同维度（茶类/产区）热度排行

验收标准：

- 分类树接口 `GET /api/v1/categories` 正确返回父子层级与运营位标记。
- `GET /api/v1/products` 在常见查询组合下响应时间 < 500ms（启用缓存/分页场景下测得）。
- 筛选和排序逻辑经过测试用例验证（包括多选、范围查询与边界值）。

### 3.1.3 门店（产品需求细化） [x]

目标：为用户提供附近门店搜索与门店点单入口，支持门店信息展示、联系方式、导航链接，并区分堂食/外卖售卖能力。

功能点：

- 门店列表（按距离/评分/营业状态排序） [x]
  - 支持传入用户定位（lat/lng）返回最近门店并计算距离（米/公里），支持分页与范围过滤（radius）。
- 门店详情 [x]
  - 展示门店信息：门店名称、门头图片、地址、联系电话、营业时间、门店描述、服务标签（堂食/外卖/自取）、店内活动与营业状态（营业/休息/临时关闭）。
  - 显示门店可售商品/门店专属商品、门店自提和门店配送覆盖范围（当为外卖时）。
- 导航与电话联系
  - 支持一键导航（跳转到高德/百度/腾讯地图等，或返回坐标供小程序内侧边导航插件使用）和一键拨号（弹窗确认）。
- 门店点单入口
  - 点击门店进入门店点单页：可选择堂食（到店结账/取餐码）或外卖（配送地址/运费计算）；门店商品/库存与门店营业时间校验。

数据模型建议：

- `stores`：`id, name, lat, lng, address, phone, open_hours, cover_image, tags, status, delivery_radius_meters, store_settings_json`
- `store_products`：门店可售商品映射（含 price_cents, stock, sku_id, is_store_only）

关键接口（示例）：

- `GET /api/v1/stores` — 支持 query: `lat, lng, radius, sort(distance|rating|open), page, size, open_only`，返回 `distance_m` 与 `estimated_travel_time`（可选）。
- `GET /api/v1/stores/{store_id}` — 返回门店详情与门店商品分类（支持 `include_products=true`）。
- `POST /api/v1/stores/{store_id}/order` — 门店点单下单接口（与商城订单模型复用，需校验门店营业时间与商品库存）。

前端/交互注意事项：

- 定位权限：首次使用需提示并获取用户地理位置信息，并在 UI 提示定位变更对结果的影响。
- 门店距离计算：后端返回距离以避免前端差异；同时在前端做轻量排序以提升交互响应速度。
- 异常状态：若门店临时关店或不支持所选配送地址，需在点单页面明显提示并禁用下单按钮。

埋点与 KPI：

- 事件：`store_list_view`, `store_card_click`, `store_nav_click`, `store_call_click`, `store_order_initiate`
- 指标：门店转化率（浏览->到店下单/外卖下单）、平均到店距离、门店营业时段下单热度

验收标准：

- `GET /api/v1/stores` 在带定位请求下返回正确排序并附带 `distance_m` 字段；近 5km 内门店优先显示。
- 门店详情页显示完整门店信息与商品（when `include_products=true`），并能正确发起门店点单请求。
- 导航与拨号按钮可正常触发对应客户端行为（跳转地图或发起拨号）并记录事件埋点。

### 3.1.4 我的（个人中心） [x]

目标：承接用户账号与资产相关能力的统一入口，覆盖登录注册、会员与合伙人入口、订单列表、钱包/积分/优惠券、客服与分享、门店管理和设置等，支撑日常运营与售后。

核心功能映射（与需求文档 3.1.4 对齐）：

- 注册登录/登录信息 [x]
  - 支持手机号 + 验证码登录、微信一键登录；展示当前账号手机号/昵称/头像、会员等级/合伙人等级。
- 会员入口 [x]
  - 展示“申请会员、合伙人”入口，点击进入会员/合伙人购买或升级页面。
- 订单中心 [x]
  - Tab：全部、待付款、待发货、待收货、待评价、售后中/已完成，对应后端订单状态映射。
- 钱包 [x]
  - 展示余额、茶币（1:1 人民币，可消费不可提现）、账单列表、提现入口、银行卡/提现账户管理入口。
- 积分中心 [x]
  - 展示积分余额、积分记录、积分商品（积分可兑换）、积分获得规则（购买商品/外卖/服务/活动累计）。
- 优惠券 [x]
  - Tab：待使用、已使用/已过期；列表展示优惠券名称、门槛、有效期、适用范围。
  - 后续增强（与门店券联动，规划中）：在「待使用」下按来源拆分子 Tab（平台券/门店券），平台券在全局符合适用范围的订单中可用；门店券仅在对应门店相关的订单（如门店点单/该门店外卖订单）中展示和可用，结算时后端按 `store_id` 与订单维度做二次过滤，确保不同来源优惠券不会误用。
- 客服 [x]
  - 展示客服电话，支持一键拨打；「意见反馈」入口（文本 + 图片，可简化为文本首版）与常见问题列表；
  - 小程序端意见反馈与订单投诉统一落地为客服工单（Ticket）：
    - 通用意见反馈：在「我的-客服-意见反馈」中提交，来源标记为 `miniapp_feedback`；
    - 订单投诉：在订单详情页的投诉入口提交，来源标记为 `miniapp_order` 并携带 `order_id`；
    - 后端通过 `POST /api/v1/tickets` 为当前登录用户创建 Ticket 记录（类型如 `consult`/`order`/`complaint`），平台客服在后台「客服工单」中统一查看和处理。
- 分享 [x]
  - 展示分享用户的推广数据：绑定人数、合伙人数量、累计佣金等；提供分享海报/链接入口。
- 门店管理入口 [x]
  - 仅门店管理员可见，跳转门店后台（H5）或小程序内门店管理页面。
- 设置 [x]
  - 账户管理（修改手机号、修改密码、注销）、隐私协议/用户协议、关于我们等静态内容。

### 3.1.5 购物车（补充说明） [x]

目标：承接「首页/分类/商品详情」中的加购动作，对应需求文档 5.1 中的购物车分组展示规则，确保不同业务来源的商品在结算前被清晰区分。

核心规则（与 5.1 功能清单对齐）：

- 购物车分组维度
  - 按业务来源分组：商城商品、门店商品服务（堂食）、门店外卖、积分商城商品；
  - 对于门店相关商品，还需在上述分组下按门店维度再次分组（同一门店的堂食/外卖商品合并展示，不同门店分开展示）。
- 展示内容
  - 每个分组显示：分组标题（如「某某门店-堂食点单」「某某门店-外卖」「商城商品」「积分商城」）、可勾选勾选框、分组内商品列表；
  - 商品行字段：主图、名称、规格、单价、数量、当前小计金额、是否参与优惠券/积分抵扣；
  - 支持在行内进行数量增减、删除商品、勾选/取消参与结算。
- 业务约束
  - 不同门店的商品不能在一次门店订单中混合结算：
    - 同一结算单仅允许来自同一门店的堂食/外卖商品；
    - 商城商品可以与其他商城商品合并结算，但与门店堂食/外卖订单分开结算；
  - 若用户在一个门店分组中选择了外卖结算，则需在结算页强制填写收货地址并校验配送范围；
  - 积分商城商品需单独结算，结算时按积分规则校验积分余额与兑换条件。

关键接口（示例）：

- `GET /api/v1/cart` — 返回当前用户的购物车分组结构，数据结构建议：`groups[] -> { group_type, store_id, store_name, items[] }`；
- `POST /api/v1/cart/items` — 向购物车新增商品项（参数包括业务类型、门店 ID、商品/sku ID、数量、来源渠道等）；
- `PUT /api/v1/cart/items/{id}` — 更新购物车项数量/选中状态；
- `DELETE /api/v1/cart/items/{id}` — 删除购物车项；
- `POST /api/v1/cart/checkout` — 从指定分组（或若干分组）发起结算请求，后端根据分组规则拆单为「商城订单」「门店订单」「积分订单」等。

验收要点：

- 不同门店、不同业务来源的商品在购物车中分组展示清晰，用户可以直观看到「这是哪个门店、什么渠道」的商品；
- 从购物车发起结算时，后端根据业务类型与门店自动拆单，不允许跨门店混合成单；
- 购物车中的数量变更、删除、勾选在前后端保持一致，并在下单前进行一次库存与有效性校验。

关键数据与模型建议：

- `users`：`id, nickname, avatar_url, phone, member_level, partner_level`
- `wallets`：`user_id, balance_cents, tea_coins, frozen_amount_cents`
- `wallet_transactions`：记录余额、茶币明细
- `points_accounts` / `points_transactions`
- `coupons`：与用户绑定的优惠券实例
- `withdrawal_requests` / `user_bank_accounts`

关键接口（示例）：

- `GET /api/v1/users/me` — 返回当前用户基础信息（头像、昵称、会员/合伙人等级等）。
- `GET /api/v1/users/me/summary` — 汇总我的页头部数据：订单数量统计（按状态）、余额/茶币/积分、未使用优惠券数量等。
- `GET /api/v1/users/me/orders` — 订单列表，支持 `status, page, size` 过滤。
- `GET /api/v1/users/me/wallet` — 钱包详情与最近账单。
- `GET /api/v1/users/me/points` — 积分余额与近期记录。
- `GET /api/v1/users/me/coupons` — 我的优惠券列表，支持 `status=available|used|expired`。
- `GET /api/v1/users/me/share-stats` — 分享/推广统计信息（推广人数、累计佣金等）。
- `GET /api/v1/users/me/store-role` — 返回当前用户是否为门店管理员及其门店列表。

前端/交互注意项：

- 登录状态依赖：未登录时“我的”页需要优先引导登录，登录后展示完整信息。
- 订单 Tab 与后端状态码映射需在 PRD 中固定（如 `pending_payment`、`paid`、`shipped`、`completed`、`after_sale`）。
- 钱包与积分信息需在进入页面时拉取一次，并在关键操作后（下单、退款、提现）刷新。
- 门店管理入口仅在 `GET /api/v1/users/me/store-role` 返回有门店权限时显示。

埋点与 KPI：

- 事件：`profile_view`, `profile_login_click`, `profile_membership_entry_click`, `profile_order_tab_click`, `wallet_entry_click`, `points_entry_click`, `coupon_entry_click`, `service_call_click`, `feedback_submit`, `share_entry_click`, `store_admin_entry_click`。
- 指标：我的页访问率、从“我的”页进入订单详情/再次购买的转化率、提现发起率、会员/合伙人入口点击率。

验收标准：

- 未登录用户访问“我的”时，会被引导登录并在登录后正确回到“我的”页。
- 已登录用户可在“我的”页访问订单、钱包、积分、优惠券等模块，数据与后台一致。
- 门店管理员账号登录后能看到“门店管理”入口并可以正常跳转到门店后台。

### 3.2.1 后台商品管理（平台端） [x]

目标：为平台运营与商品管理员提供统一的商品管理能力，覆盖商品分类/品牌/属性管理、商品上下架与价格库存维护，以及商品详细信息与图片（对接阿里云 OSS）的配置。

功能范围（与需求文档 3.2.1 对齐）：

- 商品分类、品牌、属性管理 [x]
  - 分类管理：
    - 支持多级分类（如一级“茶叶/茶器/积分商品/门店特供”等，二级按茶类/用途等），可设置排序、启用/停用、是否在前端展示。
    - 支持区分“商城商品分类”和“门店服务商品分类”，并可在分类上标记用途（送礼/投资收藏/口粮茶/健康茶等）。
  - 品牌管理：
    - 品牌列表：品牌名称、品牌 LOGO、所属产区（可选）、品牌描述。
    - 品牌可在商品详情页展示，用于筛选和品牌页聚合展示。
  - 属性与规格管理：
    - 平台可配置属性模板（如：产地、品类、年份、包装、净含量等），并为不同类目配置不同属性集。
    - 支持设置规格/SKU 维度（如“规格：100g/250g/500g”，“包装：散装/礼盒/罐装”等）。

- 商品上下架、价格、库存管理 [x]
  - 商品生命周期状态：`草稿（draft）`、`待上架（pending）`、`已上架（on_sale）`、`已下架（off_sale）`，支持按状态筛选与批量操作。
  - 价格管理：
    - 商品基础售价（商城价），可区分不同 SKU 的价格。
    - 支持标记“门店特供商品”（原价无折扣），此类商品不参与会员折扣，仅按标价销售。
  - 库存管理：
    - 支持总库存与按 SKU 维度的库存；门店库存通过 `store_products` 维护，与平台总库存联动策略在技术方案中定义。
    - 支持库存预警阈值和库存锁定策略（如下单锁库存、支付失败或超时释放）。

- 商品信息字段（商品卡片与详情页所需） [x]
  - 类型：商城商品、门店服务商品、积分商品、门店特供商品（可多选标签或字段枚举）。
  - 用途：送礼、投资收藏、口粮茶、健康茶等（可多选，用于前台筛选）。
  - 类别/品类：对应分类树的分类 ID + 业务品类字段（如“普洱熟茶/乌龙茶/周边茶器”等）。
  - 产地：云南/福建/浙江/贵州等，建议与“产区”枚举表关联。
  - 品牌：关联品牌表。
  - 商品名称：商品展示主标题。
  - 商品生产信息：生产企业、生产许可证/执行标准等文本字段。
  - 包装：散装、礼盒、罐装等（可映射到包装类型枚举，用于筛选）。
  - 参数：可扩展参数列表，如年份、级别、茶树品种、原料等级等，自定义键值对或关联属性模板。
  - 规格：一组 SKU（如“100g/250g/500g”），每个 SKU 包含规格名、条码（可选）、售价、成本价（可选）、库存、是否启用。
  - 运费：绑定运费模板，模板中可以配置免邮条件（按金额或数量），支持“包邮/不包邮/满 X 元免邮”等规则。
  - 详情：图文详情（富文本），支持图文混排展示品牌故事、产地介绍、冲泡方式等。

图片与阿里云 OSS 对接： [x]

- 存储方案
  - 商品主图、详情图、品牌 LOGO、门头图等统一存储在对象存储（阿里云 OSS）中，访问通过 CDN 域名。
  - 文件命名建议：按业务类型和日期组织，如：`products/{yyyy}/{MM}/{product_id}/{uuid}.jpg`、`brands/{brand_id}/logo.png`。

- 上传流程（推荐）
  - 后台管理前端向后端请求上传凭证：`POST /api/v1/admin/storage/oss/policy`，传入业务类型（product_image/brand_logo/...）。
  - 后端生成带签名的 OSS Policy/STS 临时凭证，返回给前端。
  - 前端使用该凭证直接向 OSS 进行表单直传或 SDK 上传，上传成功后拿到文件 URL/key。
  - 前端将图片 URL/key 回填到商品/品牌表单并提交保存；后端只存储 OSS 对象 key 与访问 URL，不处理二次上传。

- 基本约束
  - 图片格式限制：`jpg/jpeg/png/webp`，单张大小上限（如 2MB，可配置）。
  - 主图建议比例统一（如 3:4 或 1:1），后台可在上传区域给出提示。
  - 支持设置主图与附图排序，前端按排序展示。

数据模型建议（与现有 schema 对齐）：

- `products`：`id, name, type, category_id, use_case, origin_region_id, brand_id, base_price_cents, is_store_only, is_point_product, is_special_supply, shipping_template_id, status, main_image_url, detail_rich_text, extra_attrs_json, created_at, updated_at`
- `product_skus`：`id, product_id, sku_name, barcode, price_cents, cost_price_cents, stock, status`
- `product_categories`：分类表，包含 `parent_id, name, sort_order, is_visible, use_case_flags`
- `brands`：品牌表，包含 `name, logo_url, origin_region_id, description`
- `product_attributes` / `product_attribute_values`：可选，用于结构化存放参数与属性模板。
- `shipping_templates`：运费模板表，包含免邮规则与区域设置。

关键后台操作接口（示例）：

- `GET /api/v1/admin/products` — 商品列表，支持按名称、ID、状态、分类、用途、品牌过滤。
- `POST /api/v1/admin/products` — 新增商品（含基础信息、分类、品牌、用途等）。
- `PUT /api/v1/admin/products/{id}` — 编辑商品信息（不直接修改库存，可分开接口）。
- `POST /api/v1/admin/products/{id}/publish` — 上架商品，将状态从 draft/pending 改为 on_sale。
- `POST /api/v1/admin/products/{id}/unpublish` — 下架商品，将状态改为 off_sale。
- `GET /api/v1/admin/products/{id}` — 获取商品详情（含 SKU 与图片信息）。
- `POST /api/v1/admin/products/{id}/skus` / `PUT /api/v1/admin/products/skus/{sku_id}` — 维护 SKU 信息与库存。
- `POST /api/v1/admin/storage/oss/policy` — 生成阿里云 OSS 上传凭证。

验收要点：

- 后台可以完成从“新建商品草稿”到“配置图片/详情/规格”再到“上架/下架”的完整流程。
- 商品列表可以按分类/用途/品牌/状态筛选，支持分页与关键字搜索。
- 前台商品列表与详情页展示的字段与后台配置一致（类型、用途、产地、品牌、包装、规格、价格、运费、详情等）。
- 图片上传流程稳定，失败有明确报错提示；上传成功后能在商品详情中正确展示对应 OSS 图。

## 3.2.0 后台首页与总览（平台端） [x]

目标：为平台运营和管理员提供统一的工作台与数据看板，对应需求文档 5.2 中首页板块的「菜单栏、导航栏、数据看板、订单动态、提现管理、意见反馈」等能力。

主要区域：

- 左侧菜单栏 [x]
  - 菜单项：商品管理、订单管理、门店管理、会员管理、合伙人管理、营销管理、财务管理、系统设置；
  - 要求与实际权限绑定：不同管理员账号根据角色仅看到有权限的菜单项。
- 顶部导航栏 [x]
  - 快捷导航入口（常用页面快捷方式）、全局搜索框（按订单号/用户/门店/商品 ID 等搜索）、消息通知中心（系统通知、审批待办）、账户中心（当前管理员信息、退出登录等）。
- 数据看板 [x]
  - 支持时间维度切换：今日、昨日、本周、上周、本月、上月；
  - 指标：订单数量（区分门店、外卖、商城、会员/合伙人礼包等）；销售总额（同样按渠道拆分）；总用户数量与新增用户数量（按用户类型统计）；
  - 衍生分析：商品销售排行、用户行为分析等可以先以简单列表或图表形式实现，后续再增强 BI；
  - 支持点击指标跳转到对应明细页（如点击「门店订单数」跳到带好筛选条件的订单列表页）。
- 订单动态与待办 [x]
  - 订单动态：展示代发货订单、预警订单（超过 48 小时未发货、超过 30 分钟未开始配送）、售后待处理订单数量和最近列表；
  - 提现管理：展示待处理的提现申请数量与列表入口；
  - 意见反馈：展示待处理意见反馈数量与列表入口；
  - 整体作为「工作台」聚合展示今日需要处理的事项，支持通过卡片快速跳转。

关键接口（示例）：

- `GET /api/v1/admin/dashboard/summary` — 返回按时间范围汇总的核心指标；
- `GET /api/v1/admin/dashboard/order-trends` — 返回订单量/销售额趋势数据；
- `GET /api/v1/admin/dashboard/todos` — 返回待办事项列表（代发货订单数、预警订单数、售后待处理数、提现待处理数、意见反馈待处理数等）。

当前落地说明（2025-12）：

- 已在 `tea-api` 中实现 `GET /api/v1/admin/dashboard/todos` 的首批待办项：
  - 客服工单：统计 Ticket 中 `status ∈ {new, pending, waiting_customer}` 的待处理数量，字段 `ticket_pending_count`，在 Admin-FE 首页「待办事项」卡片中以「待处理客服工单」形式展示，并支持一键跳转到「客服工单」列表页；
  - 订单待发货：统计订单中 `status = 2(已付款)` 且 `pay_status = 2(已付款)` 的数量，字段 `order_to_ship_count`，在首页待办中以「待发货订单」展示，并跳转到订单列表页；
  - 提现待处理：统计 `WithdrawRecord` 中 `status ∈ {1(申请中), 2(处理中)}` 的数量，字段 `withdraw_pending_count`，在首页待办中以「待处理提现」展示，并跳转到提现管理/财务页面。

验收要点：

- 管理员登录后台后，能在首页看到和需求文档 5.2 中描述一致的主导航与数据看板结构；
- 核心指标数据与订单/用户等业务数据一致，并能按时间维度正确切换与对比；
- 订单动态、提现管理、意见反馈的待办数量与各自模块中的实际待处理条目数量一致。

## 3.2.2 订单管理（平台端） [x]

目标：支持查看与处理所有类型订单（商城订单、门店订单、积分订单、门店特供订单），并提供审核、发货、退货/退款与售后流程管理能力。

功能点：

- 订单列表与筛选：支持按订单类型、状态、门店、用户、时间区间、关键词（订单号/支付单号/收件人）过滤与导出。 [x]
- 订单详情：展示订单基础信息、支付信息、商品明细（含 SKU）、门店信息、运单信息、售后历史、操作日志。 [x]
- 订单处理：接单/拒单（门店场景）、发货（录入快递公司与单号）、标记已送达/完成、客户确认收货、订单关闭。 [x]
- 售后与退换货：支持发起售后申请、客服/门店审核、退款处理（原路退款/余额退款）、换货出入库同步。
- 退款与财务回退：记录退款流水、与支付渠道对账、支持人工调整与备注。
- 批量操作：批量发货、批量打印面单、批量更新状态。

关键接口示例：

- `GET /api/v1/admin/orders` — 列表（支持多维度筛选/分页/导出）
- `GET /api/v1/admin/orders/{id}` — 详情
- `POST /api/v1/admin/orders/{id}/ship` — 发货（参数：快递公司、运单号、发货门店/发货人）
- `POST /api/v1/admin/orders/{id}/refund` — 退款（参数：退款金额、退款方式、备注）
- `POST /api/v1/admin/orders/{id}/close` — 关闭订单

验收要点：后台可完整处理从“下单”到“完成/关闭”的流程，售后流程留有审计记录并能正确触发退款与库存回滚。

## 3.2.3 门店管理 [x]

目标：集中管理门店信息、门店管理员、门店权限与门店相关业务数据（门店订单与业绩统计）。

功能点：

- 门店列表：展示门店基本信息（名称、地址、联系电话、营业状态、营业时间、负责人）；支持新增/编辑/删除/冻结。
- 门店管理员设置：支持为门店分配管理员账号与角色（店长/店员），并管理门店员工权限。
- 门店权限边界：门店管理员仅能管理本门店数据（订单、门店商品、门店财务报表）；平台管理员可跨门店管理。
- 查看门店订单与业绩：支持按门店维度查看当日/周/月订单量、销售额、退款额、客单价等指标，并导出报表。

关键接口示例：

- `GET /api/v1/admin/stores` — 门店列表
- `POST /api/v1/admin/stores` — 新增门店
- `PUT /api/v1/admin/stores/{id}` — 编辑门店
- `DELETE /api/v1/admin/stores/{id}` — 删除/下线门店
- `POST /api/v1/admin/stores/{id}/assign-admin` — 指派门店管理员
- `GET /api/v1/admin/stores/{id}/orders` — 查看门店订单

验收要点：门店信息可被完整管理，管理员分配生效并且门店级别的访问控制生效，门店业绩数据可按时间区间导出。

## 3.2.4 会员管理 [x]

目标：管理会员用户、会员等级与会员权益配置，并支持会员权益的调整与发放策略。

功能点：

- 会员列表与筛选：按等级、注册时间、消费金额、手机号等条件筛选；支持导出。
- 会员等级配置：设定各等级门槛、价格、赠送茶币/权益、折扣比例、权益描述。
- 手动/自动升级策略：支持基于消费/购买某项礼包自动升级或后台人工调整等级。
- 会员权益管理：优惠券发放、专属价格、积分发放规则、充值礼品设置。
- 黑名单/白名单管理（与 5.2 功能清单对齐）： [x]
  - 黑名单：禁止登录或禁止使用指定关键功能（如下单、提现、领取优惠券等），用于风控与违规用户处理； [x]
  - 白名单：在部分风控规则下豁免或享有全部权限的用户（如内部员工、测试账号），支持按账号标记并在关键操作中放宽限制； [x]
  - 需要在后台为每个用户展示其黑白名单状态，并提供加入/移出黑白名单的操作入口（操作需记录审计日志）。

关键接口示例：

- `GET /api/v1/admin/members` — 会员列表
- `PUT /api/v1/admin/members/{id}/level` — 设置/调整会员等级
- `POST /api/v1/admin/members/issue-coupon` — 批量发券

验收要点：能管理会员等级与权益，会员权益变更后在前端生效（折扣/专属价格/可见活动）。

## 3.2.5 合伙人管理（分销/合伙人） [x]

目标：管理合伙人账户、等级与佣金规则，并支持佣金结算与提现管理。

功能点：

- 合伙人列表与等级管理：查看合伙人资料（级别、入驻时间、邀请人数、业绩）、手动调整等级。
- 佣金规则配置：为不同等级配置直推佣金比例、团队提成、升级奖励规则。
- 佣金流水与结算：查看合伙人佣金流水、冻结/可提现金额、结算周期与自动结算设置。
- 提现审核：合伙人发起提现后，后台审核/打款并记录流水与手续费规则。

关键接口示例：

- `GET /api/v1/admin/partners` — 合伙人列表
- `GET /api/v1/admin/partners/{id}/commissions` — 佣金流水
- `POST /api/v1/admin/partners/{id}/withdrawals/{withdrawal_id}/approve` — 提现审核通过

验收要点：合伙人佣金数据可追溯，结算规则可配置，提现流程有审计与余额变更记录。

## 3.2.6 营销管理 [x]

目标：提供平台全局的营销内容管理能力，支持活动/优惠/展示位的配置与投放。

功能点：

- 轮播图与广告位管理：上传/配置轮播图/广告，设置跳转目标、投放时段、投放门店/渠道范围。
- 优惠券管理：创建、发放、领券规则、有效期、使用范围（全平台/指定门店/指定商品）。
- 积分规则配置：设置积分获取规则（消费/活动/签到）、积分抵扣规则、积分商品兑换规则。
- 活动管理：创建活动页面、报名管理、报名用户导出、活动数据统计。
- 充值管理与配置（对应 5.2 功能清单）：
  - 充值记录列表：支持按用户 ID、时间段、支付单号等维度筛选；
  - 充值管理操作：查看详情、冻结/解冻、人工加钱/扣钱（需严格权限和操作日志）；
  - 充值配置：配置「充值多少送哪些权益」的档位规则（赠送茶币、优惠券、指定产品/服务等），并在前端充值入口中展示对应档位说明；
  - 与会员/合伙人权益及分销结算逻辑联动，确保充值赠送部分不会干扰正常佣金计算口径。

关键接口示例：

- `GET /api/v1/admin/campaigns` — 活动/投放列表
- `POST /api/v1/admin/coupons` — 创建优惠券
- `PUT /api/v1/admin/banners/{id}` — 编辑轮播图

验收要点：营销素材可按规则投放并生效，优惠券/积分策略正确下发并能被订单结算逻辑识别。

### 3.2.6.1 小程序优惠券接口约定（平台券 / 门店券，规划中）

为支撑小程序「我的-优惠券」按来源拆分 Tab（平台券/门店券）、以及「仅在对应门店下单时才能使用门店券」的业务约束，统一约定如下接口与校验规则（在现有 `Coupon`/`UserCoupon` 模型基础上演进）：

- 模型约定：
  - `Coupon`：`id, name, type(1满减/2折扣/3免单), amount, discount, min_amount, start_time, end_time, status, store_id?, description...`
  - `UserCoupon`：`id, user_id, coupon_id, status, used_at?, order_id?`
  - 平台券：`coupon.store_id == null`；门店券：`coupon.store_id == 某个 store_id`。

- 「我的-优惠券」列表接口（按来源拆 Tab）：
  - `GET /api/v1/user/coupons`
  - Query 示例：
    - `status`: `pending | used | expired`（待使用/已使用/已过期）；
    - `source`: `platform | store | all`（前端「平台券/门店券」子 Tab）；
    - `store_id`（可选）：当 `source=store` 且用户在某门店上下文中（如从门店详情页进入）时，用于仅查看该门店券。
  - 响应：返回 `UserCoupon` 列表并内嵌 `coupon` 基本信息，供前端渲染名称/门槛/有效期/适用范围与来源；
  - 基础过滤规则：
    - 仅返回当前登录用户的 `user_coupons`；
    - 过滤掉 `coupon.status != 1` 或当前时间不在有效期内的记录；
    - 按 `source` 参数区分平台券（`store_id IS NULL`）与门店券（`store_id IS NOT NULL`，可选再限定某个 `store_id`）。

- 订单场景「查询当前订单可用优惠券」接口：
  - `POST /api/v1/orders/available-coupons`
  - 请求体示例：
    - `scene`: 下单场景（如 `mall`、`store_order`、`store_takeout` 等）；
    - `store_id`: 门店订单必填；商城订单可为空；
    - `order_amount`: 本次订单商品总额（未扣券前，字符串金额）；
    - `items`: 可选，包含 `product_id/sku_id/quantity/amount` 等，用于后续做适用商品/类目过滤。
  - 响应示例：
    - `available`: 当前订单可用的 `user_coupon` 列表；
    - `unavailable`: 当前订单不可用但仍在有效期内的 `user_coupon` 列表，附带 `reason` 字段说明原因（如“仅限门店 #102 使用”“未满足门槛金额”等）。
  - 核心校验规则：
    - 基础条件：`user_coupons.status = 未使用`、`coupon.status = 启用`、当前时间在有效期内；
    - 金额门槛：若 `coupon.min_amount > 0`，则要求 `order_amount ≥ min_amount`；
    - 门店约束：
      - 平台券：不看 `store_id`；
      - 门店券：仅当 `coupon.store_id = 请求中的 store_id` 时才能进入 `available` 集合，否则进入 `unavailable` 并给出原因，从而保证“门店券仅在对应门店下单时可用”。

- 创建订单时应用优惠券（在现有下单接口上扩展）：
  - `POST /api/v1/orders` 请求体中新增 `user_coupon_id` 字段，表示用户在确认页选择使用的那一张券；
  - 后端在真正创建订单前，复用 `available-coupons` 中的同一套校验逻辑进行兜底校验：
    - 若通过，则计算优惠金额、写入订单金额字段，并将对应 `UserCoupon` 标记为已使用且关联 `order_id`；
    - 若不通过，则返回 400 + 失败原因（如“门店不匹配/已过期/门槛不满足”），前端提示用户重新选择或不使用优惠券。

上述接口约定为小程序与订单结算层的演进预留方向，当前版本可以仅实现部分只读接口（如 `GET /api/v1/user/coupons`），待运营确定门店券在前台的具体玩法与投放节奏后，再逐步开放「按订单精算可用券」与「下单时应用券」的能力。

## 3.2.7 财务管理 [x]

目标：为平台与门店提供资金流水、提现与结算的可视化和操作能力，便于财务核算与对账。

功能点：

- 平台资金流水：记录所有订单收款、退款、活动补贴、手续费与分账流水；支持按时间/渠道/门店筛选与导出。
- 合伙人佣金提现管理：审核、支付与历史记录；支持手续费配置与批量打款导出表。
- 门店结算管理：门店对账单生成、结算周期设置、结算调整与结算单导出。

关键接口示例：

- `GET /api/v1/admin/finance/transactions` — 资金流水
- `POST /api/v1/admin/finance/withdrawals/{id}/pay` — 发起打款
- `GET /api/v1/admin/finance/store-settlements` — 门店结算单列表

验收要点：资金流水与订单/退款对应，提现有完整审核路径并能导出对账报表。

## 3.2.8 系统设置 [x]

目标：提供平台级配置与权限管理入口，保证安全与合规性（隐私/协议管理）。

功能点：

- 权限管理：角色与权限树配置（平台 admin、门店管理员、店员等），支持按页面/接口粒度授权。
- 协议与内容设置：隐私协议、用户协议、合伙人协议、关于我们等内容管理，支持富文本编辑与版本管理。
- 基础配置管理（对应 5.2 功能清单中的「基本管理、快递模板、内容管理」）：
  - 基本信息：平台 logo、客服电话、版权信息等基础配置；
  - 快递模板：运费模板与快递公司模板的维护，供商品运费规则与订单发货使用；
  - 内容管理：关于我们、帮助中心文档、各类协议内容等 CMS 化管理，支持上架/下架与多版本预览。
- 日志与审计：操作日志、敏感操作告警、管理员行为审计导出。

关键接口示例：

- `GET /api/v1/admin/roles` — 角色列表
- `POST /api/v1/admin/settings/protocols` — 上传/更新协议内容
- `GET /api/v1/admin/logs` — 操作日志查询

验收要点：权限体系可覆盖平台与门店场景，协议可在前端自动读取并展示，审计日志可用于安全合规检查。

## 3.2.9 客服与投诉管理（平台端） [x]

目标：为平台提供统一的客服与投诉工单管理能力，集中处理来自小程序前台、门店后台、客服电话等多渠道的咨询与投诉，保证有据可查、有流程可追踪。

### 3.2.9.1 工单模型与字段

工单采用统一 Ticket 模型管理，不区分渠道，仅通过字段表达来源和类型：

- 基础字段：
  - `id`：工单 ID（自增主键）；
  - `type`：工单类型（枚举），如：`consult` 咨询、`order` 订单问题、`refund` 退款问题、`recharge` 充值问题、`complaint` 投诉建议、`other` 其他；
  - `source`：工单来源（枚举），如：`miniapp_feedback` 小程序意见反馈、`miniapp_order` 订单页投诉、`store_staff` 门店员工反馈、`phone` 客服电话录入、`manual` 后台人工录入；
  - `user_id`：关联用户 ID（可为空，用于匿名电话等场景）；
  - `order_id`：关联订单 ID（可为空）；
  - `store_id`：关联门店 ID（可为空，用于门店相关投诉）；
  - `title`：简要标题（如「订单未收到货」「充值未到账」）；
  - `content`：详细描述（文本）；
  - `attachments`：附件信息（JSON 字符串，存储图片/录音等资源地址列表）；
  - `status`：工单状态（枚举，见下文状态机）；
  - `priority`：优先级（`low`/`normal`/`high`，默认 normal）；
  - `assignee_id`：当前负责人（平台客服/运营账号 ID，可为空）；
  - `created_by`：创建人（系统/用户/门店/后台账号 ID）；
  - `remark`：内部备注（仅后台可见）；
  - `reject_reason`：驳回/关闭原因（可为空）；
  - `created_at` / `updated_at`：创建与更新时间；
  - `resolved_at`：标记解决时间（可为空）；
  - `closed_at`：标记关闭时间（可为空）。

### 3.2.9.2 工单状态机

工单采用简单可落地的六态状态机，用于支撑最小可用流程：

- `new`：新建，待分配；
- `pending`：处理中（已分配给客服/运营，正在跟进）；
- `waiting_customer`：已回复用户，等待用户补充信息或确认；
- `resolved`：问题已解决（用户已确认或视为解决）；
- `rejected`：不予受理（如恶意投诉、无效工单），需填写 `reject_reason`；
- `closed`：已关闭（包括用户主动撤销、长期未响应自动关闭等）。

状态流转规则（最小版）：

- `new` → `pending`：客服/运营接单或被自动指派；
- `pending` ↔ `waiting_customer`：客服回复用户后可设为 `waiting_customer`，用户补充信息后可回到 `pending`；
- `pending`/`waiting_customer` → `resolved`：问题确认解决时由客服/运营标记；
- 任意非终态 → `rejected`：确认不予处理时（需要填写原因）；
- 任意非终态 → `closed`：用户主动撤销或系统超时关闭。

### 3.2.9.3 平台后台页面与操作

平台后台提供统一的「客服工单」菜单，包含列表与详情页：

- 工单列表：
  - 筛选条件：时间范围、类型、来源、状态、优先级、关联门店、关联用户、关键词（标题/内容/订单号）；
  - 列表字段：工单 ID、创建时间、类型、来源、关联用户/手机号、关联订单号、关联门店、当前状态、优先级、当前负责人、最近更新时间；
  - 操作：查看详情、接单（设置 `assignee_id` 并将状态置为 `pending`）、快速调整状态（resolved/rejected/closed）。

- 工单详情页：
  - 展示上述字段的完整信息，以及：
    - 工单操作日志（状态变更、负责人变更、备注记录等）；
    - 回复/备注记录（最小版可仅支持内部备注，不强制实现 IM/通知系统）；
  - 支持的操作：
    - 分配/转派负责人；
    - 更新状态（pending/waiting_customer/resolved/rejected/closed）；
    - 编辑优先级；
    - 添加内部备注；
    - 填写 `reject_reason`。

### 3.2.9.4 接口设计（平台端最小闭环）

- `GET /api/v1/admin/tickets` — 工单列表
  - 请求参数：`page, limit, status, type, source, priority, store_id, user_id, keyword`；
  - 返回：分页数据，包含工单基础字段与简要信息。

- `GET /api/v1/admin/tickets/{id}` — 工单详情
  - 返回：工单完整信息及操作日志列表（如后端已有通用操作日志表，可在后续对接；最小版可暂不返回日志，仅返回主记录）。

- `POST /api/v1/admin/tickets` — 创建工单（后台人工录入）
  - 请求体：`type, source, user_id, order_id, store_id, title, content, attachments, priority` 等；
  - 行为：创建一条 `status = new` 的工单，`created_by` 为当前管理员账号。

- `PUT /api/v1/admin/tickets/{id}` — 更新工单
  - 请求体：允许更新字段的子集：`status, assignee_id, priority, remark, reject_reason`；
  - 行为：根据请求体进行局部更新，并记录更新时间；若状态更新为 `resolved`/`closed`，自动写入 `resolved_at`/`closed_at`。

（如后续需要前台用户自助提交投诉，可新增公开接口 `POST /api/v1/tickets`，本次迭代不强制实现。）

### 3.2.9.5 与首页待办的联动（预留）

- 在 `GET /api/v1/admin/dashboard/todos` 中增加「待处理工单数量」指标：
  - 统计 `status IN ("new","pending","waiting_customer")` 的工单数量；
  - 返回字段如：`ticket_pending_count`；
- Admin-FE 工作台卡片中展示该数字并提供跳转至客服工单列表页的入口；
- 本次最小实现阶段，只需确保后台有可用接口与页面；与待办卡片的打通可作为后续迭代。

## 3.3 门店后台（网页版） [x]

目标：为门店运营人员（店长/店员）提供一个轻量、响应式的门店管理后台（H5/PC），支持门店日常运营的订单处理、门店商品管理、店员与门店设置、财务与会员查看，以及商家商城管理。

### 3.3.1 订单管理 [x]

- 订单提醒：实时/轮询提醒新订单（可选语音/桌面通知），支持未处理订单高亮与超时告警。
- 订单处理：接单/拒单、打印小票/后厨单/标签、标记制作完成、发货/配送/自取流程标记、订单备注与客户沟通记录。
- 售后处理：门店可发起退款/换货申请到平台后台或处理门店内售后（需同步库存与退款流水）。

关键接口示例：

- `GET /api/v1/stores/{store_id}/orders` — 门店订单列表（筛选：status、时间、关键字）
- `POST /api/v1/stores/{store_id}/orders/{id}/accept` — 接单
- `POST /api/v1/stores/{store_id}/orders/{id}/print` — 触发打印（返回打印任务或直接推送打印队列）
- `POST /api/v1/stores/{store_id}/orders/{id}/status` — 更新订单状态（制作完成/已发货/已取餐）

验收要点：门店能及时接收并处理新订单（低延迟提醒），打印与接单流畅，售后单与退款能触发正确的账务/库存变更。

### 3.3.2 商品管理 [x]

- 门店商品上架：支持门店在门店后台新增/编辑门店商品（标识堂食/外卖/仅门店售卖），设置价格、库存与可售时间段。
- 商品分类管理：门店可管理门店内部分类（映射平台分类或自定义分类）。
- 库存同步：门店商品库存与平台 `store_products` 表联动，支持库存预警与手动调整（记录操作人）。

- 商品分类（服务商品/外卖商品/其他） [x] — 门店商品业务类型：
  - 数据模型：在 `store_products` 表上为每条门店商品记录增加业务类型字段 `biz_type`（tinyint，默认 1），取值含义：`1=服务商品（堂食/到店服务）`、`2=外卖商品（外送/打包）`、`3=其他（如会员卡、虚拟权益、礼盒等非就餐类商品）`；
  - 门店后台编辑：在门店商品列表/编辑页中，运营可为每条门店商品选择对应业务类型（服务/外卖/其他），支持后续按类型筛选与统计；
  - 前台映射关系：堂食点单页默认展示 `biz_type IN (1,3)` 的商品，外卖点单页默认展示 `biz_type IN (2,3)` 的商品，后续如需更细粒度的展示规则（如仅在特定页展示「其他」类型）可在产品实现阶段再做补充说明。

关键接口示例：

- `GET /api/v1/stores/{store_id}/products` — 门店商品列表
- `POST /api/v1/stores/{store_id}/products` — 新增门店商品
- `PUT /api/v1/stores/{store_id}/products/{id}` — 编辑门店商品
- `POST /api/v1/stores/{store_id}/products/{id}/stock-adjust` — 库存调整（需记录 operator）

验收要点：门店能独立创建并管理门店商品，库存变更有审计记录且与订单出入库一致。

### 3.3.3 门店设置 [x]

- 基本信息管理：门店名称、地址、电话、门头图、营业时间、门店负责人、营业执照/资质上传（支持图片/PDF）。
- 餐桌/桌码管理：生成/删除桌码二维码、设置桌码对应的就餐区域与桌位信息。
- 店员管理：新增/删除店员账号、分配角色（店长/收银/后厨）、权限控制（接单、退款、打印权限）。

关键接口示例：

- `GET /api/v1/stores/{store_id}` — 门店详情
- `PUT /api/v1/stores/{store_id}` — 更新门店信息
- `POST /api/v1/stores/{store_id}/table-codes` — 生成桌码
- `GET /api/v1/stores/{store_id}/staff` — 门店店员列表
- `POST /api/v1/stores/{store_id}/staff` — 新增店员

验收要点：门店信息可被完整维护，桌码能生成并扫码进入点餐/核销流程，店员权限能按角色生效。

### 3.3.4 财务管理 [x]

- 收款账户设置：门店可配置结算账户（对账用途），支持导出结算单/流水。
- 账单查询：查看门店营收、退款、提现、手续费等流水，支持按时间范围导出 CSV/Excel。
- 对账与结算：平台生成门店结算单，支持查看结算周期和手动调整项；门店可申请结算查询。

- 财务提现（提现申请） [x] — 功能完成：门店侧已提供钱包汇总与提现申请/记录接口，并在后台提供「门店财务」页面（StoreFinance），支持按门店查看余额、提交提现申请及查看状态；审核与打款流程沿用平台提现管理规则，如后续引入独立结算单可在新版本扩展。

关键接口示例：

- `GET /api/v1/stores/{store_id}/finance/transactions` — 门店资金流水
- `GET /api/v1/stores/{store_id}/finance/settlements` — 门店结算单

验收要点：门店可导出对账单并核对每日/周/月流水，结算单与平台记录一致。

### 3.3.5 会员管理（门店维度） [x]

- 门店可查看本门店推广/注册的会员与合伙人（来源/绑定关系），查看会员消费历史与会员等级分布。
- 门店可发放店内专属优惠券/积分以推动门店复购（需平台审批或权限）。

关键接口示例：

- `GET /api/v1/stores/{store_id}/members` — 门店会员列表
- `GET /api/v1/stores/{store_id}/members/{id}/orders` — 指定会员在门店的订单记录

验收要点：门店能查看到归属会员明细，门店发券/积分操作受权限控制并可在平台端追溯。

### 3.3.6 商家商城（门店特供） [x]

- 商家特供商品：门店可上架仅在本门店售卖的“商家特供”商品，支持门店定价与库存管理。
- 门店商品与平台商品的关系：支持映射到平台 `products` 或作为独立 `store_products` 条目。

关键接口示例：

- `GET /api/v1/stores/{store_id}/exclusive-products` — 商家特供商品列表
- `POST /api/v1/stores/{store_id}/exclusive-products` — 新增门店特供商品

验收要点：门店特供商品仅在门店可见/购买，库存与销售数据能在门店后台与平台后台汇总展示。

### 3.3.7 门店首页与经营参谋（补充说明） [x]

目标：为门店管理人员提供类似需求文档 5.3 中「首页-经营参谋/工作台」的统一入口，聚合门店经营数据与待办事项，提升日常运营效率。

主要模块：

- 左侧菜单栏与顶部导航栏
  - 左侧菜单：订单管理、商品管理、门店设置、财务管理、会员管理、系统设置；与门店角色权限打通，不同角色看到的菜单不同；
  - 顶部导航：快捷入口（常用功能）、搜索（按订单号、用户手机号等）、消息通知（新订单提醒、提现结果、投诉/反馈等）、账户中心（当前登录门店账号信息）。
- 经营参谋（数据看板）
  - 时间维度：今日、昨日、本周、上周、本月、上月；
  - 指标：订单数量（按门店堂食/外卖/商城/会员礼包等渠道拆分）、销售总额（同样按渠道拆分）、客单价、退款率等；
  - 展示形式：图表 + 列表，支持点击指标跳转到对应明细列表（如订单列表、财务记录）。
- 工作台
  - 待处理订单列表：新订单、即将超时订单等，支持直接在列表中执行接单、打印小票/标签/后厨出货单、标记制作完成与发货；
  - 收银入口：支持在门店前台收银场景下快速添加商品和服务 → 选择会员（可选）→ 应用优惠券/优惠金额/折扣 → 收款（现金、扫码、刷卡、会员余额、组合支付、第三方订单券等）→ 打印收款小票与后厨小票/商品标签；
  - 将上述「收银」流程统一抽象为一类「线下订单」，最终落到订单与财务流水中，确保线上线下统一对账。

### 3.3.8 门店营销与活动管理（补充说明） [x]

目标：补齐门店后台在需求文档 5.3 中描述的「活动管理/优惠券」能力说明，并与当前已实现的门店券与门店活动最小闭环对齐，避免与平台营销引擎重复设计。

#### 3.3.8.1 门店优惠券（已实现 — 最小闭环）

- 模型与接口：在平台统一 `Coupon` 模型基础上增加 `store_id` 字段，区分平台券与门店券；tea-api 提供门店维度优惠券接口：
  - `GET /api/v1/stores/{id}/coupons` — 门店优惠券列表（支持按状态筛选）；
  - `POST /api/v1/stores/{id}/coupons` — 门店创建本店优惠券；
  - `PUT /api/v1/stores/{id}/coupons/{couponId}` — 门店编辑/禁用本店优惠券。
- 门店后台页面：Admin-FE 中提供「门店优惠券」（StoreCoupons）页面，支持：
  - 选择门店后查看本店券列表；
  - 创建/编辑本店券（满减/折扣/免单、门槛金额、总量、状态、有效期、描述等）；
  - 复制现有券新建与一键禁用操作。
- 能力边界：门店仅能在本店维度创建/管理优惠券，底层字段与校验逻辑由平台营销模块统一控制，避免规则分裂；如需更复杂人群/渠道规则，可在平台侧扩展字段并裁剪门店可见子集。

- 小程序端使用入口（规划中）：当前版本仅完成门店维度优惠券的配置与管理闭环，小程序前端暂不区分「平台券/门店券」展示；后续如需对外开放门店券，可在以下几个位置按需接入：
  - 「我的-优惠券」中按来源拆分 Tab（平台券/门店券），门店券仅在对应门店下单时可见；
  - 门店详情页展示本店可领取优惠券入口（如「进店领券」），调用统一发券接口；
  - 下单确认页在「可用优惠」区域增加门店券选择器（优先显示当前门店/当前订单可用的门店券），与平台券复用同一结算与核销规则。
  - 以上入口均复用统一 `Coupon/UserCoupon` 模型与校验逻辑，仅在展示与筛选维度上区分 `store_id` 与平台券，具体上线节奏与样式由运营侧视流量与玩法需求决定。

#### 3.3.8.2 门店活动（已实现 — 最小闭环）

- 模型与接口：在 `Activity` 模型上增加可选 `store_id` 字段，表示门店专属活动；tea-api 提供门店维度活动接口：
  - `GET /api/v1/stores/{id}/activities` — 门店活动列表（支持按状态筛选）；
  - `POST /api/v1/stores/{id}/activities` — 门店创建本店活动（名称、类型、起止时间、规则 JSON、状态、优先级、描述等）；
  - `PUT /api/v1/stores/{id}/activities/{activityId}` — 门店编辑本店活动（含启用/禁用）。
- 门店后台页面：Admin-FE 中提供「门店活动」（StoreActivities）页面，支持：
  - 选择门店并按状态筛选活动；
  - 查看活动基本信息（名称、类型、状态、优先级、起止时间、描述）；
  - 通过弹窗表单创建/编辑本店活动，填写基础字段与规则 JSON 字段（预留给后续复杂玩法）。
- 能力边界：当前版本只实现「门店自建/配置本店活动」的最小闭环，尚不包含报名列表、审核流与退费规则；如需上线报名/退费能力，可在后续版本中：
  - 统一由平台活动模块承载报名/支付/退费流程；
  - 门店仅在本节定义的活动基础信息上增补报名配置字段，提交平台审核后生效。

#### 3.3.8.3 与平台营销的关系

- 所有活动与优惠券底层规则与数据结构依然由平台「3.2.6 营销管理」统一控制，门店只是配置本店范围与基础字段；
- 平台可对门店活动/优惠券设置配额与权限（可创建的活动/券类型、最高补贴额度、是否允许自建活动等），相关控制逻辑在平台后台实现。

验收要点：

- 门店登录后台后，可在「门店优惠券」「门店活动」页面以门店维度自助创建、编辑和禁用本店优惠券与活动；
- 所有门店券与门店活动均严格绑定 `store_id`，平台可在统一视角下对其进行审核与统计；
- 后续如扩展报名/退费/高级人群规则时，可在不破坏现有最小闭环的前提下，向平台营销模块追加字段与流程。

## 3.4 分销系统

本节概述平台的分销/合伙人体系核心设计，将用户需求中的分销规则、佣金计算口径与结算流程做成工程可执行的规范（具体结算规则与风控在“分销结算设计”节中详细说明）。

### 3.4.1 分销规则

- 用户分销：普通用户/会员可分享商品或门店服务，成交后按配置比例获得推广佣金；推广关系通过分享链接或二维码记录。
- 合伙人分销：合伙人有等级划分（初级/中级/高级），不同等级享受不同的拿货折扣与直推佣金比例；合伙人晋级后可获得升级差价奖励。
- 关系维护：使用 `referrals` 与 `referrals_closure` 表记录直接/间接关系，支持 N 层分佣查询与历史回溯。

关键注意项：分销入口必须携带推荐人 ID（或推广码），下单时记录订单来源以便后续结算；禁止自我推荐与异常推广检测需列入风控策略。

### 3.4.2 佣金计算

- 计算口径：结算基数 = 订单项原价总和 - 优惠券分摊 - 快递运费 - 其他结算折扣。
- 百分比计算：直接佣金按 `direct_commission_rate` 计算（按用户/合伙人等级配置），间接佣金按 `team_commission_rate`（默认 10%）从直推毛佣中计算。
- 金额单位与舍入：全部以“分”为单位，整数计算并向下取整（floor）。

示例：订单结算基数 93000 分，直推比例 30% → 直推毛佣 = `floor(93000 * 0.30)` = 27900 分；团队管理奖 = `floor(27900 * 0.10)` = 2790 分。

### 3.4.3 佣金结算

- 状态机：佣金记录从 `frozen`（冻结）→ `available`（可提现）→ `paid`（已提现）或 `reversed`（回滚）。
- 解冻策略：默认在订单完成并通过 N 天风控期后由定时任务批量解冻；退款/退货会触发相应回滚或补扣流程。
- 提现规则：提现门槛、手续费、发票要求与人工审批流程在 `withdrawal_requests` 模块中实现，提现操作需有审计日志与外部流水对接。

关键接口（简要示例）：

- `GET /api/v1/admin/partners` — 合伙人列表与等级
- `GET /api/v1/admin/partners/{id}/commissions` — 某合伙人佣金流水
- `POST /api/v1/admin/commissions/settle` — 触发批量结算/解冻任务（管理员触发或定时任务）

验收要点：佣金计算结果可复现、佣金解冻与提现流程可追溯且退款回滚不会导致余额错算；财务能够导出对账明细。

## 六、里程碑与建议时间预估（示例）

说明：时间按工作日估算，视团队规模与并行能力调整。

- **阶段 0 — 需求确认与原型（1 周）**: 完成 UI 原型、接口约定、数据库主要表设计。
- **阶段 1 — 核心下单能力（3 周）**: 商品浏览、门店点单、购物车、支付接入、订单流转。
- **阶段 2 — 用户与会员体系（2 周）**: 注册/登录、个人中心、钱包/茶币、积分、优惠券。
- **阶段 3 — 后台与门店管理（2 周）**: 平台商品、订单管理、门店管理、门店后台基础功能。
- **阶段 4 — 分销与合伙人（2-3 周）**: 分享/推荐关系、佣金计算、钱包结算、合伙人礼包购买流程。
- **阶段 5 — 测试与上线准备（1-2 周）**: 集成测试、性能和安全检查、线上部署流程与回滚计划。

总体示例周期（并行开发且快速迭代）：10–13 周。

## 七、任务拆解（示例 Sprint 任务）

- **Sprint A（第1-3周）**
  - 接口：商品列表/详情、门店列表、下单/支付回调
  - 前端：商品列表、商品详情、门店页面、购物车
  - 后台：商品导入、上架/下架接口
- **Sprint B（第4-5周）**
  - 接口：用户/登录/钱包/优惠券
  - 前端：我的页面、登录/注册、支付流水
  - 后台：订单管理、会员管理
  - **自动化保护**：已建立会员购买路径完整的端到端自动化测试与验证体系
    - 集成测试脚本：`scripts/run_membership_integration.sh`（完整购买流程 + JSON 输出）
    - 断言验证脚本：`scripts/assert_membership_flow.sh`（支持普通/严格模式）
    - Makefile 目标：`make verify-sprint-b` 和 `make verify-sprint-b-strict`
    - CI 集成：自动运行会员流程测试并归档 JSON/日志到 artifacts
    - 详细文档见 `doc/prd_sprints.md` 中的"Sprint B — 会员购买路径自动化测试"章节
- **Sprint C（第6-8周）**
  - 分销相关接口与钱包结算逻辑
  - 合伙人礼包购买与升级流程
  - 门店后台接单/打印功能
- **Sprint D（第9-11周）**
  - QA 修复、性能优化、日志与监控配置
  - 上线前联调与小范围灰度

## 八、验收标准（每项功能应满足以下验收项）

- **功能正确性**：关键路径（下单—支付—发货/核销）无阻断，接口正确返回并记录日志
- **数据一致性**：订单、库存、佣金、钱包余额在常见并发场景下保持一致或给出明确补偿机制
- **安全性**：用户敏感操作需鉴权，提现与财务相关操作需审计日志
- **性能**：首页与商品列表首屏响应 < 1s（理想），下单承受并发峰值（按预估并发量进行压测）
- **可用性**：UI 与交互符合移动端体验、主要流程可在普通网络环境完成

## 九、技术与集成要点

- **小程序端**: 使用微信小程序 + vite/React（或 Taro / UniApp 视团队栈而定，项目中已有 `wx-fe` 可复用）
- **后端**: 复用现有 `tea-api` 服务，新增必要接口与鉴权中间件
- **支付**: 微信支付优先，保留支付宝扩展能力
- **分账/提现**: 初版走平台钱包模式，后续考虑微信分账或第三方清算
- **消息**: 订单/佣金/活动通过公众号与小程序推送（模板消息）

## 分销结算设计（佣金分配与结算）

说明：本节把需求文档 2.3 中的佣金规则写成可执行的 PRD 设计，覆盖“计算口径”“类型/比例”“冻结与解冻时机”“退款回滚”“提现与发票规则”以及后端实现注意事项。

- 计算口径（基础公式）：
  - 结算基数（calculation_basis） = 订单项金额总和（原价） - 优惠券分摊 - 快递运费 - 其它结算折扣
  - 直接佣金（gross）= floor(calculation_basis * direct_rate)
  - 间接佣金（team）= floor(direct_gross * team_rate)  （文档中默认 team_rate = 10%）
  - 净佣金 = gross - fee（手续费在提现或结算时处理，默认平台手续费 1% 可配置）

- 佣金类型与比例：
  - 直接推广（direct）：按用户/合伙人等级或购买的礼包定义的 `direct_commission_rate`（需求中范围 30%-45% 对应合伙人等级；普通用户/会员通常为 10%）。
  - 间接推广（indirect/team）：固定为 10%（对直接推荐人产生的直推佣金按 10% 发放给其上级），使用 `partner_levels.team_commission_rate` 或统一配置。
  - 升级奖励（upgrade）：合伙人升级时按“差价”计算差额奖励（由 `membership_packages.upgrade_reward_rate` 或运营规则决定），生成 `commission` 记录，类型标注为 `upgrade`。

- 四舍五入与金额单位：
  - 所有金额在 DB/传输使用“分”为单位保存，计算中采用整数算术并对小数部分向下取整（floor）以避免超额支付。

- 冻结/解冻（安全与纠纷处理）：
  - 新生成的佣金记录默认状态为 `frozen`（冻结），并在满足无退货期/订单完成并通过 N 天风控期后由定时任务释放为 `available`（可提现）。
  - 推荐默认风控期为 7 天（可配置），实际由产品与财务确认后写入 `platform_financial_settings`。

- 退款/退货回滚：
  - 若订单发生退款或退货，需对相关 `commission` 记录进行反向操作：若尚未解冻则直接作废/标记 `reversed` 并在 `commission_transactions` 记录原因；若已解冻并提现则需要走财务流程（扣款/账单调整）并记录审批流水。

- 提现与发票合规：
  - 平台提现规则（可配置，示例）：单次最小提现 `10000` 分（100 元），提现手续费 `withdrawal_fee_rate` 默认为 1%（可调整），每月累计提现> `500000` 分（5000 元）需上传营销服务发票。
  - 提现申请流：用户提交提现申请 -> 系统校验余额/最小值/发票要求 -> 创建 `withdrawal_requests` -> 管理员审批（approve/reject）-> 调用第三方打款（或平台内转账）-> 写入外部流水 `external_txn_id`。

- 数据模型（引用已设计的表）：
  - `commissions`：保存佣金明细（user_id, order_id, commission_type, rate, calculation_basis, gross_amount, fee, net_amount, status, available_at）
  - `commission_transactions`：记录佣金流水（release/withdraw/adjust/upgrade/fee）与凭证
  - `referrals_closure`：推荐闭包表，用于高效计算 N 层分佣
  - `membership_packages` / `partner_levels`：保存不同等级/礼包对应的佣金率与拿货折扣
  - `withdrawal_requests` / `user_bank_accounts`：提现申请与用户收款账户表

- 后端实现要点（工程注意项）：
  - 幂等：下单/支付回调必须支持幂等（通过 `order_no` 或 `Idempotency-Key`），避免重复生成佣金记录。所有生成佣金的接口应可重入且在数据库层具备去重约束。
  - 事务边界：创建订单、生成佣金、变更钱包余额等需在事务或补偿机制下保证一致性；建议：先在订单结算事务内写入 `commissions`（frozen），再异步解冻并转入可提现。
  - 性能：用 `referrals_closure` 预计算祖先链，避免在高并发下频繁递归查询；批量结算时使用索引扫描 `status='frozen' AND available_at<=now()`。
  - 审计：所有人工审批（提现拒绝/放款）需写 `admin_audit_logs` 并在 `commission_transactions` 中记录 `operator_id` 与 `external_txn_id`。

  - 典型场景示例（便于产品/测试验收）：
    - 示例：用户下单 1000.00 元，运费 20.00 元，优惠券 50.00 元 → 结算基数 = 1000 - 20 - 50 = 930 元（93000 分）。
      若直推比例为 30%，则直推毛佣 = `floor(93000 * 0.30)` = 27900 分（279.00 元）；
      团队管理奖 10% = `floor(27900 * 0.10)` = 2790 分（27.90 元）。

以上内容将作为 PRD 中的分销结算规范，供开发、测试与财务在实现时对齐。如需我把这些规范转为更详细的操作流程（审批表单字段、审批状态机、测试用例清单），我可以继续拆解并写入 `doc/prd.md` 或单独生成 `doc/ops/commission_playbook.md`。

## 十、风险与缓解

- **分销结算复杂度高**：先实现钱包累积与人工结算，逐步自动化分账。
- **门店与配送差异化**：门店与外卖商品逻辑分离，门店端实现独立配置与开关。
- **库存一致性**：下单前二次校验库存并使用库存锁/预占机制。
- **合规与财务审核**：提现规则需与财务沟通、上线前完成合规条款与发票策略。

## 十一、交付物

- `doc/prd.md`（本开发计划）
- UI 原型与设计稿（Figma/Sketch 链接）
- API 文档（OpenAPI/Swagger）
- 数据库 ER 与迁移脚本
- 部署与回滚手册

## 十二、下一步建议（待确认）

- 确认 MVP 与优先级（是否把分销基础纳入 MVP）
- 完成 UI 原型（首页、商品页、下单流程、我的页面、后台关键页面）
- 明确可用并发目标，安排一次压测
- 指派负责人（前端/后端/测试/产品/设计/运维）并确定迭代节奏

---

文档由需求文档整理生成，如需我把里程碑改成具体日期、生成 JIRA/任务板、或拆解更细的技术任务清单，请告知要使用的团队规模与每周可用人力，我将继续拆解并提交到 `doc/prd.md` 的更新版本。

## 项目进度与规划文档索引

> 说明：下列路径均以仓库根目录为基准，便于快速找到「现在项目做到哪一步了」「本迭代要做什么」以及「哪些需求还在 Backlog」。当出现新文档时，请同步在此处补充，保持索引完整。

- `doc/prd.md`：茶心阁小程序的主 PRD 文档，描述整体业务需求、角色、功能范围与高层开发计划，是所有进度/任务文档的总入口。
- `doc/prd_sprints.md`：基于 PRD 拆解的 Sprint 任务列表，按迭代列出前端/后端/测试/运维的具体工作项，并给出关键 REST API 草案。
- `doc/prd_feature_checklist.md`：需求文档功能点与 `doc/prd.md` 章节的一一映射表，通过 `[x]/[]/✅` 标记设计与实现完成度，用于评审“哪些功能已在 PRD 中落地”。
- `tea-api/docs/progress-report.md`：后端 `tea-api` 的开发进度报告，按模块列出「已完成 / 进行中 / 待测试 / 下一阶段计划」，适合作为后端开发的进度视图。
- `docs/features/store-order-link.md`：门店面板 ↔ 订单列表 ↔ 订单操作区联动的设计说明，文末包含建议的开发步骤，是门店与订单联动方向的实现指南。
  - 当前实现链路示例：后台导航「门店列表」→ 某门店「订单」进入「门店订单列表」，在表格行点击「在订单操作区打开」后，前端跳转到 `/orders?orderId={orderId}&storeId={storeId}`，全局订单页自动按门店过滤并在右侧打开对应订单的操作抽屉，可刷新复现。
- `docs/prd-open-points.md`：PRD 中尚未完全敲定的开放问题和后续建议动作清单，可视为产品侧 Backlog 与决策待办。
- `docs/frontend-backend-checklist.md`：前后端联调与提测前的检查清单，用于在提测/发布前核对 API、字段、状态枚举等是否与 PRD 和 API 文档保持一致。
