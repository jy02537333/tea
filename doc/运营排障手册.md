# 茶心阁运营排障手册（MVP 版）

> 本手册基于当前 Admin-FE 单页版（`Admin-FE/index.html`）的真实功能撰写，主要面向运营、测试和一线客服，用于快速排查订单与资金相关问题。
>
> 默认前提：已经可以正常登录 Admin-FE，并完成环境选择与接口检测。

---

## 一、使用前准备

- 登录 Admin-FE 后，确认右上角显示为正确的环境与账号。
- 在头部环境栏中选择当前要排查的环境（例如测试服/预发/生产）。
- 点击「检测接口」按钮，确认后端 API 状态正常，再开始后续操作。

---

## 二、路径一：门店投诉订单异常

**典型场景**：
- 门店反馈「顾客已经在小程序支付，但门店看不到订单」。
- 门店反馈「订单状态不对，比如门店看到已完成，但顾客还显示配送中」。

**排查目标**：
- 快速定位到这笔订单。
- 核实订单状态、门店、金额、配送信息是否正确。
- 必要时继续查看财务流水与用户信息。

**操作步骤**：

1. 在 Admin-FE 顶部标签中点击【门店】。
2. 在左侧「门店列表」中：
   - 使用门店名称搜索框，输入门店名称关键字。
   - 在列表中点击对应门店行，右侧会加载该门店的面板（订单统计、库存等）。
3. 在右侧面板找到「门店订单列表」区域：
   - 如果知道订单号：在订单ID输入框中输入门店提供的订单号；
   - 如果不知道订单号：先根据时间范围（开始/结束日期）和状态（例如「仅已付款」「配送中」）进行筛选，缩小候选列表。
4. 点击「查询」按钮，让列表刷新。
5. 在结果列表中：
   - 找到疑似订单所在行；
   - 可以直接**点击整行**，或点击操作列中的「带入并查看」按钮。
6. 确认订单详情：
   - 上方「订单操作工具」区域会自动带入订单ID；
   - 右侧「订单详情」区会自动拉取并展示该订单的信息（门店、金额、状态、支付方式、配送信息等）。
7. 如需要继续核实资金流向：
   - 在订单详情右上角点击「在财务页查看」；
   - 页面会自动跳转到【财务】标签页，并根据订单ID查询相关支付/退款操作日志。
8. 如怀疑为用户账号问题：
   - 在订单详情中找到「用户ID」一行；
   - 点击旁边的「查看用户」按钮，跳转到【用户管理】标签页；
   - 此时搜索框会获得焦点，运营可以根据手机号/昵称继续缩小范围，查看用户的整体历史订单与钱包情况。

**建议记录信息**：
- 门店名称、订单ID、顾客昵称或手机号。
- 小程序端展示的订单状态与时间。
- 后台订单详情中看到的订单状态、门店、金额。
- 若进入财务页：对应的支付流水号、退款流水号等。

---

## 三、路径二：财务对账差异

**典型场景**：
- 财务在对账时发现某个结算周期内门店收入与第三方对账单不一致。
- 某个支付渠道（如微信/支付宝）的汇总金额与内部统计不一致。

**排查目标**：
- 找出差异集中在哪些门店或订单。
- 核实每个门店的订单数、支付金额、退款金额是否合理。
- 找到可以解释差异的具体订单或流水记录。

**操作步骤**：

1. 在 Admin-FE 顶部标签中点击【财务】。
2. 在对账汇总相关区域：
   - 选择需要对账的日期范围；
   - 选择支付方式（如「全部」「微信」「支付宝」）；
   - 点击查询，观察整体汇总数据，与外部对账单对比差异的方向和量级。
3. 向下找到「按门店汇总」区域：
   - 同样选择日期范围和支付方式；
   - 可选择排序字段（例如按订单数、净额排序），方便快速发现异常门店；
   - 点击查询，查看每个门店的订单数、支付额、退款额、净额等指标。
4. 定位异常门店后：
   - 在门店汇总表的该门店行中，点击「查看门店详情」按钮；
   - 系统会自动切换到【门店】标签页，并选中对应门店，加载门店面板。
5. 在门店面板中：
   - 对比门店面板顶部的订单统计与刚才的门店汇总数据；
   - 在「门店订单列表」中，按照对账周期的日期范围和状态（例如「仅已完成」「仅已退款」）筛选出相关订单；
   - 如订单较多，可使用导出功能（CSV/XLSX），便于在 Excel 中与第三方对账单逐笔比对。
6. 如发现某些订单的资金记录异常：
   - 回到【财务】标签页，打开「支付流水」视图；
   - 根据订单ID、时间段或金额进行筛选；
   - 在记录行中使用「查看订单」「查看日志」按钮，进一步核查该订单的资金变动路径。
7. 如差异集中在个别用户上（例如频繁退款或多笔异常支付）：
   - 在支付流水、提现记录或操作日志列表中，找到相关记录；
   - 点击记录上的「查看用户」按钮，跳转到【用户管理】标签页，聚焦该用户，综合查看其订单与资金行为。

**建议记录信息**：
- 对账日期范围、支付方式。
- 存在差异的门店及其汇总数据（订单数、支付金额、退款金额、净额）。
- 对差异贡献最大的几笔订单及其支付流水号。

---

## 四、路径三：用户投诉资金问题

**典型场景**：
- 用户反馈「我付了钱但没有订单」。
- 用户反馈「余额/茶币/佣金对不上」。

**排查目标**：
- 确认用户身份（准确匹配到后台的用户记录）。
- 找出与用户描述匹配的订单或资金流水。
- 判定问题属于展示类、延迟类还是业务逻辑类。

**操作步骤**：

1. 与用户或客服确认尽可能完整的信息：
   - 手机号（优先）或微信昵称；
   - 涉及的金额（订单金额、充值金额、提现金额等）；
   - 发生的时间范围（例如今天 10:00-11:00 之间）。
2. 在 Admin-FE 顶部标签中点击【用户管理】。
3. 在用户列表上方的搜索框中：
   - 输入用户手机号或昵称；
   - 列表会在本地缓存的所有用户中进行过滤，缩小到少量候选记录。
4. 在列表中选择最符合的那条用户记录：
   - 根据注册时间、地区或备注等信息进行人工确认；
   - 记录下该用户的 user_id 和基础信息（手机号、昵称）。
5. 根据投诉类型进行深挖：
   - **如果是「支付了但没有订单」**：
     - 结合用户给出的时间范围和金额，在【门店】或订单相关视图中，用时间+金额+门店组合筛选订单；
     - 找到疑似订单后，通过「在财务页查看」确认支付流水是否成功，以及是否有退款。
   - **如果是「余额/茶币/佣金对不上」**：
     - 在【财务】标签页中，查看与该用户相关的「提现记录」「支付流水」「佣金/分润统计」等；
     - 在相关记录行使用「查看用户」按钮，随时跳回【用户管理】，保持对该用户整体资产情况的全局视图。
6. 将前台与后台信息对齐：
   - 前台：用户提供的时间、金额、支付方式、截图；
   - 后台：对应的订单ID、支付流水号、提现单号、当前账户余额等；
   - 判断问题原因（例如支付成功但回调延迟、用户看的是错误环境、小程序缓存等），并整理一份可以直接回复给用户的说明。

**建议记录信息**：
- 用户手机号、user_id、关联的订单ID/流水号/提现单号。
- 前端展示与后台数据的差异点及结论。

---

## 五、Admin-FE 用户管理页面联调记录

> 目标：验证 `GET /api/v1/admin/users` 相关接口是否与 Admin-FE 页面行为一致，并为后续排障提供示例请求/响应。

### 5.1 联调准备（环境）

- 已确认 Admin-FE 可以在浏览器访问，例如：`http://localhost:5173`。
- Admin-FE 配置的 API 基础地址（如 `VITE_API_BASE_URL`）与目标 `tea-api` 环境一致，例如：`http://api.test.xxx.com` 或 `http://localhost:8082`。
- 已使用具有管理员权限的账号登录 Admin-FE。

### 5.2 列表分页接口联调

1. 打开 Admin-FE 顶部导航中的【用户管理】页面。
2. 在浏览器开发者工具 Network 面板中筛选 `GET /api/v1/admin/users` 请求。
3. 正常加载列表时，记录一条成功请求：
    - 请求 URL 示例：
       - `GET /api/v1/admin/users?page=1&limit=20`
    - 请求头关键信息：
       - `Authorization: Bearer <token>`（如有）
    - 响应示例（可脱敏后粘贴部分）：
       - 状态码：`200`
       - 关键字段：`data`（用户数组）、`total`、`page`、`limit` 或等价字段。
4. 如发生异常（例如 401/403/500）：
    - 记录请求 URL、状态码与返回 `message` 文本；
    - 简要备注触发场景（例如「登录已过期重新刷新页面后恢复」）。

> 建议：将一条成功和一条失败的典型请求/响应粘贴到本小节下方，供日后参考。

### 5.2.1 本次抓取示例（运行时状态记录）

> 说明：以下记录基于 2025-12-05 在本地 dev 环境的真实请求，服务通过 `TEA_DSN=root:gs963852@tcp(127.0.0.1:3308)/tea_shop` 启动，日志保存在 `build-ci-logs/` 目录。旧版本的兼容登录接口会把 `role` 设置为 `"5"`，从而触发 `RequireRoles("admin")` 的 403。当前仓库已将 `/api/v1/auth/login` 的兼容模式改成发放 `role":"admin"`，确保联调顺利。

- 时间：2025-12-05 18:40（UTC+8，本机）

#### 获取 Token

```bash
curl -sS -H "Content-Type: application/json" \
   -d '{"username":"admin","password":"pass"}' \
   http://127.0.0.1:9292/api/v1/auth/login \
   -o build-ci-logs/admin_login_response.json
```

成功响应片段：

```json
{"data":{"token":"<JWT>","role":"admin","name":"超级管理员"}}
```


#### 列表请求

```bash
TOKEN=$(python3 - <<'PY'
import json, pathlib
data=json.loads(pathlib.Path('build-ci-logs/admin_login_response.json').read_text()).get('data',{})
print(data.get('token',''))
PY
) && curl -sS -H "Authorization: Bearer $TOKEN" \
   "http://127.0.0.1:9292/api/v1/admin/users?page=1&limit=20" \
   -o build-ci-logs/admin_users_response.json \
   -w "HTTP_STATUS:%{http_code}\n"
```

HTTP 状态码：`200`

响应示例（完整 JSON 见 `build-ci-logs/admin_users_response.json`）：

```json
{
   "code":0,
   "message":"success",
   "data":[
      {"id":3,"open_id":"admin_openid","role":"admin","last_login_at":"2025-12-05T16:20:01.576+08:00"},
      {"id":39,"open_id":"user_openid_cart","role":"user", ...}
   ],
   "total":24,
   "page":1,
   "size":20
}
```

> 如果再次出现 403，请优先确认 login 响应中的 `role` 是否为 `admin`，再检查 `Authorization` 是否正确附加到请求头。

### 5.3 user_id 精确查询联调

1. 在【用户管理】页面找到搜索/筛选区域，尝试按 `user_id` 查询：
    - 在搜索框或指定的 `user_id` 输入框中输入一个已知存在的用户 ID（可从订单详情或日志中获取）。
2. 观察 Network 面板中对应请求：
    - 请求 URL 应包含 `user_id` 参数，例如：
       - `GET /api/v1/admin/users?page=1&limit=20&user_id=12345`
3. 记录一条「命中」示例：
    - 状态码：`200`
    - 响应 `data` 中仅包含该 user_id 对应的一条或少量记录；
    - 若后端支持模糊/多条件查询，可在这里注明行为。
4. 记录一条「未命中」示例：
    - 使用一个不存在的 user_id（例如很大的数字或特殊 ID）；
    - 确认响应中 `data` 为空列表，`total` 为 0，状态码仍为 `200`；
    - 若后端对未命中返回 404 或其他格式，也在此注明。

#### 5.3.1 本次抓取示例（user_id 精确查询）

##### 命中示例

命令：

```bash
TOKEN=$(python3 - <<'PY'
import json, pathlib
data=json.loads(pathlib.Path('build-ci-logs/admin_login_response.json').read_text()).get('data',{})
print(data.get('token',''))
PY
) && curl -sS -H "Authorization: Bearer $TOKEN" \
   "http://127.0.0.1:9292/api/v1/admin/users?page=1&limit=20&user_id=3" \
   -o build-ci-logs/admin_users_response_user3.json \
   -w "HTTP_STATUS:%{http_code}\n"
```

HTTP 状态码：`200`

响应摘录（`build-ci-logs/admin_users_response_user3.json`）：

```json
{"code":0,"message":"success","data":{"data":[{"id":3,"open_id":"admin_openid","phone":"6d056c38c1475bc878e8","role":"admin"}]}}
```

##### 未命中示例

命令：

```bash
TOKEN=<同上> && curl -sS -H "Authorization: Bearer $TOKEN" \
   "http://127.0.0.1:9292/api/v1/admin/users?page=1&limit=20&user_id=999999" \
   -o build-ci-logs/admin_users_response_user999999.json \
   -w "HTTP_STATUS:%{http_code}\n"
```

HTTP 状态码：`200`

响应摘录：

```json
{"code":0,"message":"success","data":{"data":[]}}
```

以上两条记录可直接对照 Admin-FE 的搜索行为：命中时仅返回目标用户，未命中时 `data` 为空且状态依然为 200，便于前端提示“未找到用户”。

### 5.4 排障与回归建议

- 当运营反馈「某个用户在用户管理页搜不到」时：
   - 优先在 Network 中比对是否正确带上了 `user_id` 参数；
   - 比对返回数据中的 `user_id`、手机号、昵称等字段是否与投诉信息一致。
- 若后端接口有字段调整（例如分页字段名称或 data 包装层变化）：
   - 在本节更新最新的请求/响应示例；
   - 同时更新 `前端开发详细需求分析.md` 中的「用户管理」接口说明。

## 六、后续优化建议（给产品/研发）

> 以下内容是基于以上三条典型路径，在日常使用中可能遇到的「可以更顺手一点」的改进点，方便后续排期时参考。

- 【用户管理】支持按 user_id 精确搜索，以便从「查看用户」跳转后自动定位用户而不是仅聚焦搜索框。
- 在【财务】的支付流水、提现记录、操作日志列表上方，增加一行简短说明，提示可以通过「查看用户」「查看订单」按钮完成跨页排查。
- 在【门店】的「门店订单列表」区域，增加一个小提示文案，说明：
  - 点击行或「带入并查看」可快速跳转到订单操作区；
  - 订单详情中可以进一步跳转到【财务】或【用户管理】。
- 在对账与门店汇总导出结果中，考虑增加一列「排障链接」或「诊断备注」，方便将来与小程序端或客服系统联动。
