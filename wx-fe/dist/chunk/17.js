"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[17],{"6017":function(e,n,r){r.r(n),r.d(n,{"default":function(){return MembershipPage}});var t=r(8646),i=r(3561),a=r(6045),l=r(6673),o=r(9866),s=r(7378),c=r(4657),u=r(8785),d=r(9624),p=r(2489),f=r(6903),h=r(3312),m=r(7356);function listMembershipPackages(){return _listMembershipPackages.apply(this,arguments)}function _listMembershipPackages(){return _listMembershipPackages=(0,l.A)((0,t.A)().m(function _callee(){var e,n,r=arguments;return(0,t.A)().w(function(t){for(;;)switch(t.n){case 0:return e=r.length>0&&void 0!==r[0]?r[0]:{},t.n=1,m.Ay.get("/api/v1/membership-packages",{"params":e});case 1:return n=t.v,t.a(2,(0,m.Bm)(n))}},_callee)})),_listMembershipPackages.apply(this,arguments)}function createMembershipOrder(e){return _createMembershipOrder.apply(this,arguments)}function _createMembershipOrder(){return(_createMembershipOrder=(0,l.A)((0,t.A)().m(function _callee2(e){var n;return(0,t.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,m.Ay.post("/api/v1/membership-orders",e);case 1:return n=r.v,r.a(2,(0,m.Bm)(n))}},_callee2)}))).apply(this,arguments)}var g=r(5225),y=r(9918),_=r(6106),v=["未知","男","女"];function MembershipPage(){var e,n,r=(0,s.useState)(null),m=(0,o.A)(r,2),k=m[0],b=m[1],A=(0,s.useState)({"nickname":"","gender":0}),x=(0,o.A)(A,2),S=x[0],j=x[1],P=(0,s.useState)(!1),w=(0,o.A)(P,2),C=w[0],T=w[1],E=(0,s.useState)(!1),Y=(0,o.A)(E,2),I=Y[0],M=Y[1],O=(0,s.useState)(!1),U=(0,o.A)(O,2),z=U[0],B=U[1],W=(0,s.useState)([]),F=(0,o.A)(W,2),N=F[0],R=F[1],D=(0,s.useState)(null),$=(0,o.A)(D,2),J=$[0],q=$[1];(0,s.useEffect)(function(){loadProfile(),loadPackages()},[]),u.Ay.usePullDownRefresh(function(){loadProfile(),loadPackages()});var G=(0,s.useMemo)(function(){if(!k)return"访客";var e=k.points||0;return e>=2e3?"黑金会员":e>=1e3?"铂金会员":e>=500?"黄金会员":e>=200?"白银会员":"青铜会员"},[k]);function loadPackages(){return _loadPackages.apply(this,arguments)}function _loadPackages(){return(_loadPackages=(0,l.A)((0,t.A)().m(function _callee(){var e,n;return(0,t.A)().w(function(r){for(;;)switch(r.p=r.n){case 0:return B(!0),r.p=1,r.n=2,listMembershipPackages({"page":1,"limit":20,"type":"membership"});case 2:e=r.v,R(e.data||[]),r.n=4;break;case 3:r.p=3,n=r.v,console.error("load membership packages failed",n),(0,d.P0)({"title":"加载套餐失败","icon":"none"});case 4:return r.p=4,B(!1),r.f(4);case 5:return r.a(2)}},_callee,null,[[1,3,4,5]])}))).apply(this,arguments)}function loadProfile(){return _loadProfile.apply(this,arguments)}function _loadProfile(){return(_loadProfile=(0,l.A)((0,t.A)().m(function _callee2(){var e,n,r;return(0,t.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:return T(!0),t.p=1,t.n=2,(0,h.ug)();case 2:n=t.v,b(n),j({"nickname":n.nickname||"","gender":null!==(e=n.gender)&&void 0!==e?e:0}),t.n=4;break;case 3:t.p=3,r=t.v,console.error("load membership profile failed",r),(0,d.P0)({"title":"加载失败","icon":"none"});case 4:return t.p=4,T(!1),(0,p.r)(),t.f(4);case 5:return t.a(2)}},_callee2,null,[[1,3,4,5]])}))).apply(this,arguments)}function _handleOpenPackage(){return(_handleOpenPackage=(0,l.A)((0,t.A)().m(function _callee3(e){var n,r,i,l;return(0,t.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:if(e.id){t.n=1;break}return t.a(2);case 1:if(!J||J!==e.id){t.n=2;break}return t.a(2);case 2:return q(e.id),t.p=3,n=(0,y.j)({"requireStoreId":!1}),t.n=4,createMembershipOrder((0,a.A)({"package_id":e.id},n));case 4:return r=t.v,t.n=5,(0,g.v)(r.order_id);case 5:return i=t.v,t.n=6,(0,f.SY)({"timeStamp":String(i.timestamp||i.timeStamp),"nonceStr":i.nonce_str||i.nonceStr,"package":i.package,"signType":"MD5","paySign":i.sign});case 6:return(0,d.P0)({"title":"开通成功","icon":"success"}),t.n=7,loadProfile();case 7:return t.n=8,loadPackages();case 8:t.n=10;break;case 9:t.p=9,l=t.v,console.error("open membership package failed",l),(0,d.P0)({"title":"支付未完成，可稍后重试","icon":"none"});case 10:return t.p=10,q(null),t.f(10);case 11:return t.a(2)}},_callee3,null,[[3,9,10,11]])}))).apply(this,arguments)}function handleFieldChange(e,n){j(function(r){return(0,a.A)((0,a.A)({},r),{},(0,i.A)({},e,n))})}function _handleSave(){return(_handleSave=(0,l.A)((0,t.A)().m(function _callee4(){var e;return(0,t.A)().w(function(n){for(;;)switch(n.p=n.n){case 0:if(S.nickname.trim()){n.n=1;break}return(0,d.P0)({"title":"请输入昵称","icon":"none"}),n.a(2);case 1:return M(!0),n.p=2,n.n=3,(0,h.bu)({"nickname":S.nickname.trim(),"gender":S.gender});case 3:return(0,d.P0)({"title":"资料已更新","icon":"success"}),n.n=4,loadProfile();case 4:n.n=6;break;case 5:n.p=5,e=n.v,console.error("update membership info failed",e),(0,d.P0)({"title":"更新失败","icon":"none"});case 6:return n.p=6,M(!1),n.f(6);case 7:return n.a(2)}},_callee4,null,[[2,5,6,7]])}))).apply(this,arguments)}return(0,_.jsxs)(c.Ss,{"style":{"padding":16,"backgroundColor":"#f5f6f8","minHeight":"100vh"},"children":[(0,_.jsxs)(c.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":16},"children":[(0,_.jsx)(c.EY,{"style":{"fontSize":24,"fontWeight":"bold"},"children":G}),(0,_.jsxs)(c.EY,{"style":{"color":"#666","marginTop":4},"children":["UID：",(null==k?void 0:k.uid)||"-"]}),(0,_.jsxs)(c.EY,{"style":{"color":"#666","marginTop":4},"children":["角色：",(null==k?void 0:k.role)||"user"]}),(0,_.jsxs)(c.Ss,{"style":{"display":"flex","justifyContent":"space-around","marginTop":16},"children":[(0,_.jsxs)(c.Ss,{"style":{"textAlign":"center"},"children":[(0,_.jsx)(c.EY,{"style":{"fontSize":20,"fontWeight":"bold"},"children":null!==(e=null==k?void 0:k.points)&&void 0!==e?e:0}),(0,_.jsx)(c.EY,{"style":{"color":"#999","fontSize":12},"children":"成长积分"})]}),(0,_.jsxs)(c.Ss,{"style":{"textAlign":"center"},"children":[(0,_.jsx)(c.EY,{"style":{"fontSize":20,"fontWeight":"bold"},"children":null!==(n=null==k?void 0:k.balance)&&void 0!==n?n:0}),(0,_.jsx)(c.EY,{"style":{"color":"#999","fontSize":12},"children":"账户余额"})]})]})]}),(0,_.jsxs)(c.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":16,"marginTop":16},"children":[(0,_.jsx)(c.EY,{"style":{"fontSize":18,"fontWeight":"bold"},"children":"完善资料"}),(0,_.jsxs)(c.Ss,{"style":{"marginTop":12},"children":[(0,_.jsx)(c.EY,{"children":"昵称"}),(0,_.jsx)(c.pd,{"value":S.nickname,"onInput":function onInput(e){return handleFieldChange("nickname",e.detail.value)},"placeholder":"请输入昵称"})]}),(0,_.jsxs)(c.Ss,{"style":{"marginTop":12},"children":[(0,_.jsx)(c.EY,{"children":"性别"}),(0,_.jsx)(c.Ss,{"style":{"display":"flex","gap":8,"marginTop":8},"children":v.map(function(e,n){return(0,_.jsx)(c.$n,{"size":"mini","type":S.gender===n?"primary":void 0,"onClick":function onClick(){return handleFieldChange("gender",n)},"children":e},e)})})]}),(0,_.jsx)(c.$n,{"style":{"marginTop":16},"type":"primary","loading":I,"onClick":function handleSave(){return _handleSave.apply(this,arguments)},"children":I?"保存中...":"保存资料"})]}),(0,_.jsxs)(c.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":16,"marginTop":16},"children":[(0,_.jsx)(c.EY,{"style":{"fontSize":18,"fontWeight":"bold"},"children":"会员权益"}),(0,_.jsx)(c.EY,{"style":{"color":"#666","marginTop":8},"children":"· 订单积分：每成功支付 1 元累积 1 积分"}),(0,_.jsx)(c.EY,{"style":{"color":"#666","marginTop":4},"children":"· 冻结金额：售后退款中的订单会暂时影响积分"}),(0,_.jsx)(c.EY,{"style":{"color":"#666","marginTop":4},"children":"· 会员日：积分超过 1000 可在会员日享受折扣"})]}),(0,_.jsxs)(c.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":16,"marginTop":16},"children":[(0,_.jsx)(c.EY,{"style":{"fontSize":18,"fontWeight":"bold"},"children":"可开通的会员套餐"}),z&&(0,_.jsx)(c.EY,{"style":{"color":"#999","marginTop":8},"children":"加载中..."}),!z&&0===N.length&&(0,_.jsx)(c.EY,{"style":{"color":"#999","marginTop":8},"children":"暂未配置可用的会员套餐"}),!z&&N.length>0&&(0,_.jsx)(c.Ss,{"style":{"marginTop":12},"children":N.map(function(e){return(0,_.jsxs)(c.Ss,{"style":{"padding":12,"borderRadius":8,"borderWidth":1,"borderColor":"#eee","marginBottom":8,"display":"flex","flexDirection":"row","justifyContent":"space-between","alignItems":"center"},"children":[(0,_.jsxs)(c.Ss,{"children":[(0,_.jsx)(c.EY,{"style":{"fontSize":16,"fontWeight":"bold"},"children":e.name}),(0,_.jsx)(c.Ss,{"style":{"marginTop":4},"children":(0,_.jsxs)(c.EY,{"style":{"color":"#f56c6c","fontSize":16},"children":["￥",Number(e.price||0).toFixed(2)]})}),e.discount_rate&&(0,_.jsxs)(c.EY,{"style":{"color":"#666","fontSize":12,"marginTop":4},"children":["会员折扣约：",(100*Number(e.discount_rate)).toFixed(0)," 折"]}),e.tea_coin_award&&(0,_.jsxs)(c.EY,{"style":{"color":"#666","fontSize":12,"marginTop":2},"children":["开通赠送茶币：",Number(e.tea_coin_award)]})]}),(0,_.jsx)(c.$n,{"size":"mini","type":"primary","loading":J===e.id,"onClick":function onClick(){!function handleOpenPackage(e){return _handleOpenPackage.apply(this,arguments)}(e)},"children":J===e.id?"开通中...":"去开通"})]},e.id)})})]}),(0,_.jsx)(c.$n,{"style":{"marginTop":24},"loading":C||z,"onClick":function onClick(){loadProfile(),loadPackages()},"children":"重新加载"}),(0,_.jsx)(c.$n,{"style":{"marginTop":12},"onClick":function onClick(){u.Ay.navigateTo({"url":"/pages/membership-orders/index"})},"children":"查看我的会员订单"})]})}},"3312":function(e,n,r){r.d(n,{"bu":function(){return updateUserInfo},"iD":function(){return login},"ug":function(){return getUserInfo}});var t=r(8646),i=r(6673),a=r(7356);function login(e){return _login.apply(this,arguments)}function _login(){return(_login=(0,i.A)((0,t.A)().m(function _callee(e){var n,r,i,l;return(0,t.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,a.Ay.post("/api/v1/auth/login",e);case 1:return n=t.v,null!=(r=(0,a.Bm)(n))&&r.token&&(0,a.WG)(r.token),t.a(2,r);case 2:return t.p=2,t.v,t.n=3,a.Ay.post("/api/v1/user/login",e);case 3:return i=t.v,null!=(l=(0,a.Bm)(i))&&l.token&&(0,a.WG)(l.token),t.a(2,l)}},_callee,null,[[0,2]])}))).apply(this,arguments)}function getUserInfo(){return _getUserInfo.apply(this,arguments)}function _getUserInfo(){return(_getUserInfo=(0,i.A)((0,t.A)().m(function _callee2(){var e,n,r,i,l;return(0,t.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,a.Ay.get("/api/v1/users/me/summary");case 1:if(n=t.v,r=(0,a.Bm)(n),!(i=(null==r?void 0:r.user)||(null==r||null===(e=r.data)||void 0===e?void 0:e.user))){t.n=2;break}return t.a(2,i);case 2:t.n=4;break;case 3:t.p=3,t.v;case 4:return t.n=5,a.Ay.get("/api/v1/user/info");case 5:return l=t.v,t.a(2,(0,a.Bm)(l))}},_callee2,null,[[0,3]])}))).apply(this,arguments)}function updateUserInfo(e){return _updateUserInfo.apply(this,arguments)}function _updateUserInfo(){return(_updateUserInfo=(0,i.A)((0,t.A)().m(function _callee3(e){var n;return(0,t.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,a.Ay.put("/api/v1/user/info",e);case 1:return n=r.v,r.a(2,(0,a.Bm)(n))}},_callee3)}))).apply(this,arguments)}},"5225":function(e,n,r){r.d(n,{"e":function(){return mockPayCallback},"v":function(){return createUnifiedOrder}});var t=r(8646),i=r(6673),a=r(7356);function createUnifiedOrder(e){return _createUnifiedOrder.apply(this,arguments)}function _createUnifiedOrder(){return(_createUnifiedOrder=(0,i.A)((0,t.A)().m(function _callee(e){var n;return(0,t.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,a.Ay.post("/api/v1/payments/unified-order",{"order_id":e,"method":1,"trade_type":"JSAPI","notify_url":""});case 1:return n=r.v,r.a(2,(0,a.Bm)(n))}},_callee)}))).apply(this,arguments)}function mockPayCallback(e){return _mockPayCallback.apply(this,arguments)}function _mockPayCallback(){return(_mockPayCallback=(0,i.A)((0,t.A)().m(function _callee2(e){var n;return(0,t.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,a.Ay.post("/api/v1/payment/mock-callback",{"payment_no":e});case 1:return n=r.v,r.a(2,(0,a.Bm)(n))}},_callee2)}))).apply(this,arguments)}},"9918":function(e,n,r){r.d(n,{"j":function(){return buildOrderShareAttributionParams}});var t=r(6244);function buildOrderShareAttributionParams(e){var n=function readPositiveIntFromStorage(e){try{var n=(0,t.JF)(e);if(null==n)return;var r=Number(n);if(!Number.isFinite(r)||r<=0)return;return Math.floor(r)}catch(e){return}}("referrer_id");if(!n)return{};var r=null==e?void 0:e.storeId,i=!!r&&Number.isFinite(r)&&r>0;return null!=e&&e.requireStoreId?i?{"sharer_uid":n,"share_store_id":r}:{}:{"sharer_uid":n,"share_store_id":i?r:0}}}}]);