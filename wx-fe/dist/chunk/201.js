"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[201],{"9201":function(e,r,n){n.r(r),n.d(r,{"default":function(){return AfterSalePage}});var t=n(8646),a=n(3561),i=n(6045),l=n(6673),c=n(9866),s=n(7378),u=n(4657),o=n(8785),d=n(2489),f=n(9624),p=n(6287),A=n(5219),h=n(213),y=n(1371),_=n(6106),m={"1":"待付款","2":"待发货","3":"配送中","4":"已完成","5":"已取消"},v={"1":"未付款","2":"已付款","3":"退款中","4":"已退款"};function AfterSalePage(){var e,r=o.Ay.useRouter(),n=(0,s.useState)([]),g=(0,c.A)(n,2),b=g[0],k=g[1],w=(0,s.useState)(!1),O=(0,c.A)(w,2),j=O[0],D=O[1],x=(0,s.useState)(null),S=(0,c.A)(x,2),C=S[0],R=S[1],T=(0,s.useState)(null),E=(0,c.A)(T,2),N=E[0],Y=E[1],I=(0,s.useState)({}),B=(0,c.A)(I,2),z=B[0],F=B[1],L=(0,s.useState)({}),M=(0,c.A)(L,2),P=M[0],$=M[1],q=(0,s.useState)({}),J=(0,c.A)(q,2),W=J[0],K=J[1],V=(0,s.useMemo)(function(){var e,n=null==r||null===(e=r.params)||void 0===e?void 0:e.mock_refund;return"1"===n||"true"===n},[null==r||null===(e=r.params)||void 0===e?void 0:e.mock_refund]);function fetchOrders(){return _fetchOrders.apply(this,arguments)}function _fetchOrders(){return(_fetchOrders=(0,l.A)((0,t.A)().m(function _callee2(){var e,r,n,l;return(0,t.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:return D(!0),t.p=1,t.n=2,(0,p.MV)({"page":1,"limit":20});case 2:e=t.v,r=(null==e?void 0:e.data)||[],k(r),V&&r.length&&(n=r[0],F(function(e){return(0,i.A)((0,i.A)({},e),{},(0,a.A)({},n.id,!0))}),$(function(e){var r;return(0,i.A)((0,i.A)({},e),{},(0,a.A)({},n.id,[{"id":998001,"order_id":n.id,"payment_id":0,"refund_no":"RF-MOCK-AFTERSALE-001","refund_amount":String(null!==(r=n.pay_amount)&&void 0!==r?r:"0"),"refund_reason":"示例退款用于截图展示（售后页）","status":1,"created_at":(new Date).toISOString()}]))})),Y(null),t.n=4;break;case 3:t.p=3,l=t.v,console.error("load orders failed",l),Y((null==l?void 0:l.message)||"订单加载失败");case 4:return t.p=4,D(!1),(0,d.r)(),t.f(4);case 5:return t.a(2)}},_callee2,null,[[1,3,4,5]])}))).apply(this,arguments)}function canPay(e){return 1===Number(e.status)}function canCancel(e){return 1===Number(e.status)}function canConfirm(e){return 3===Number(e.status)}function handleAction(e,r){return _handleAction.apply(this,arguments)}function _handleAction(){return(_handleAction=(0,l.A)((0,t.A)().m(function _callee3(e,r){var n;return(0,t.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:if(R({"id":e.id,"type":r}),t.p=1,"pay"!==r){t.n=3;break}return t.n=2,(0,p.Tg)(e.id);case 2:t.n=6;break;case 3:if("cancel"!==r){t.n=5;break}return t.n=4,(0,p.N4)(e.id,"用户申请取消");case 4:t.n=6;break;case 5:return t.n=6,(0,p.Ad)(e.id);case 6:return(0,f.P0)({"title":"操作成功","icon":"success"}),t.n=7,fetchOrders();case 7:t.n=9;break;case 8:t.p=8,n=t.v,console.error("after-sale action failed",n),(0,f.P0)({"title":"操作失败","icon":"none"});case 9:return t.p=9,R(null),t.f(9);case 10:return t.a(2)}},_callee3,null,[[1,8,9,10]])}))).apply(this,arguments)}function _handleRefundInquiry(){return(_handleRefundInquiry=(0,l.A)((0,t.A)().m(function _callee4(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.p=n.n){case 0:return n.p=0,n.n=1,(0,h.Z)({"type":"refund","source":"miniapp_order","order_id":e.id,"title":"退款进度咨询 ".concat(e.order_no||"").trim(),"content":"请协助查询该订单的退款进度。"});case 1:(0,f.P0)({"title":"已提交退款咨询","icon":"none"}),n.n=3;break;case 2:n.p=2,r=n.v,console.error("refund inquiry failed",r),(0,f.P0)({"title":(null==r?void 0:r.message)||"提交失败，请稍后再试","icon":"none"});case 3:return n.a(2)}},_callee4,null,[[0,2]])}))).apply(this,arguments)}function _toggleRefundTimeline(){return(_toggleRefundTimeline=(0,l.A)((0,t.A)().m(function _callee5(e){var r,n,l;return(0,t.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:if(r=!!z[e.id],n=(0,i.A)((0,i.A)({},z),{},(0,a.A)({},e.id,!r)),F(n),r){t.n=5;break}if(P[e.id]){t.n=5;break}return K(function(r){return(0,i.A)((0,i.A)({},r),{},(0,a.A)({},e.id,!0))}),t.p=1,t.n=2,(0,y.c)({"order_id":e.id,"page":1,"limit":20});case 2:l=t.v,$(function(r){return(0,i.A)((0,i.A)({},r),{},(0,a.A)({},e.id,(null==l?void 0:l.data)||[]))}),t.n=4;break;case 3:t.p=3,t.v;case 4:return t.p=4,K(function(r){return(0,i.A)((0,i.A)({},r),{},(0,a.A)({},e.id,!1))}),t.f(4);case 5:return t.a(2)}},_callee5,null,[[1,3,4,5]])}))).apply(this,arguments)}return(0,s.useEffect)(function(){fetchOrders()},[]),o.Ay.usePullDownRefresh(function(){fetchOrders()}),(0,_.jsxs)(u.Ss,{"style":{"padding":16,"backgroundColor":"#f5f6f8","minHeight":"100vh"},"children":[(0,_.jsx)(u.Ss,{"style":{"marginBottom":12},"children":(0,_.jsx)(u.EY,{"style":{"fontSize":16,"color":"#666"},"children":"可对最近订单执行取消、支付、确认收货等操作。"})}),N&&(0,_.jsx)(u.EY,{"style":{"color":"#ff4d4f","marginBottom":12},"children":N}),!b.length&&!N&&(0,_.jsx)(u.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":16},"children":(0,_.jsx)(u.EY,{"style":{"color":"#999"},"children":j?"加载中...":"暂无订单"})}),b.map(function(e){var r,n,c=(0,A.es)(e.address_info);return(0,_.jsxs)(u.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":16,"marginBottom":12},"children":[(0,_.jsxs)(u.Ss,{"style":{"display":"flex","justifyContent":"space-between"},"children":[(0,_.jsxs)(u.EY,{"style":{"fontWeight":"bold"},"children":["订单号：",e.order_no]}),(0,_.jsx)(u.EY,{"style":{"color":"#1677ff"},"children":(n=Number(e.status),m[n||0]||"状态".concat(null!=n?n:"-"))})]}),(0,_.jsx)(u.Ss,{"style":{"marginTop":6},"children":(0,_.jsxs)(u.EY,{"style":{"color":"#8c8c8c","fontSize":12},"children":["支付状态：",(r=Number(e.pay_status),v[r||0]||"支付状态".concat(null!=r?r:"-"))]})}),c&&(0,_.jsx)(u.EY,{"style":{"color":"#666","marginTop":6},"children":(0,A.M0)(c)}),e.remark&&(0,_.jsxs)(u.EY,{"style":{"color":"#999","fontSize":12},"children":["备注：",e.remark]}),(0,_.jsxs)(u.Ss,{"style":{"display":"flex","gap":8,"marginTop":12,"flexWrap":"wrap"},"children":[canPay(e)&&(0,_.jsx)(u.$n,{"size":"mini","loading":(null==C?void 0:C.id)===e.id&&"pay"===(null==C?void 0:C.type),"onClick":function onClick(){return handleAction(e,"pay")},"children":"去支付"}),canCancel(e)&&(0,_.jsx)(u.$n,{"size":"mini","loading":(null==C?void 0:C.id)===e.id&&"cancel"===(null==C?void 0:C.type),"onClick":function onClick(){return handleAction(e,"cancel")},"children":"取消订单"}),canConfirm(e)&&(0,_.jsx)(u.$n,{"size":"mini","loading":(null==C?void 0:C.id)===e.id&&"receive"===(null==C?void 0:C.type),"onClick":function onClick(){return handleAction(e,"receive")},"children":"确认收货"}),(0,_.jsx)(u.$n,{"size":"mini","onClick":function onClick(){return o.Ay.navigateTo({"url":"/pages/order-detail/index?id=".concat(e.id)})},"children":"查看详情"}),(3===Number(e.pay_status)||4===Number(e.pay_status))&&(0,_.jsxs)(_.Fragment,{"children":[(0,_.jsx)(u.$n,{"size":"mini","type":"warn","onClick":function onClick(){return function handleRefundInquiry(e){return _handleRefundInquiry.apply(this,arguments)}(e)},"children":"退款进度咨询"}),(0,_.jsx)(u.$n,{"size":"mini","onClick":function onClick(){return function toggleRefundTimeline(e){return _toggleRefundTimeline.apply(this,arguments)}(e)},"children":z[e.id]?"收起退款进度":"查看退款进度"})]})]}),z[e.id]&&(0,_.jsxs)(u.Ss,{"style":{"marginTop":10,"padding":10,"backgroundColor":"#fffbe6","borderRadius":8,"border":"1px solid #ffe58f"},"children":[(0,_.jsx)(u.EY,{"style":{"fontWeight":"bold","display":"block"},"children":"退款进度"}),W[e.id]&&(0,_.jsx)(u.EY,{"style":{"color":"#8c8c8c"},"children":"加载中..."}),!W[e.id]&&(!P[e.id]||!P[e.id].length)&&(0,_.jsx)(u.EY,{"style":{"color":"#8c8c8c"},"children":"暂无退款记录"}),!W[e.id]&&P[e.id]&&P[e.id].map(function(e){return(0,_.jsxs)(u.Ss,{"style":{"marginTop":8,"padding":8,"backgroundColor":"#fff","borderRadius":8},"children":[(0,_.jsxs)(u.EY,{"style":{"display":"block"},"children":["退款单号：",e.refund_no]}),(0,_.jsxs)(u.EY,{"style":{"display":"block","marginTop":2},"children":["退款金额：￥",String(e.refund_amount)]}),(0,_.jsxs)(u.EY,{"style":{"display":"block","marginTop":2,"color":"#8c8c8c","fontSize":12},"children":["状态：",1===e.status?"申请中":2===e.status?"退款成功":"退款失败"]}),(0,_.jsxs)(u.EY,{"style":{"display":"block","marginTop":2,"color":"#8c8c8c","fontSize":12},"children":["申请时间：",e.created_at||"-"]}),e.refunded_at&&(0,_.jsxs)(u.EY,{"style":{"display":"block","marginTop":2,"color":"#8c8c8c","fontSize":12},"children":["退款完成时间：",e.refunded_at]}),e.refund_reason&&(0,_.jsxs)(u.EY,{"style":{"display":"block","marginTop":2,"color":"#999"},"children":["原因：",e.refund_reason]})]},e.id)}),(0,_.jsx)(u.Ss,{"style":{"marginTop":8},"children":(0,_.jsx)(u.$n,{"size":"mini","onClick":(0,l.A)((0,t.A)().m(function _callee(){var r;return(0,t.A)().w(function(n){for(;;)switch(n.p=n.n){case 0:return K(function(r){return(0,i.A)((0,i.A)({},r),{},(0,a.A)({},e.id,!0))}),n.p=1,n.n=2,(0,y.c)({"order_id":e.id,"page":1,"limit":20});case 2:r=n.v,$(function(n){return(0,i.A)((0,i.A)({},n),{},(0,a.A)({},e.id,(null==r?void 0:r.data)||[]))}),(0,f.P0)({"title":"已刷新退款记录","icon":"none"}),n.n=4;break;case 3:n.p=3,n.v,(0,f.P0)({"title":"刷新失败","icon":"none"});case 4:return n.p=4,K(function(r){return(0,i.A)((0,i.A)({},r),{},(0,a.A)({},e.id,!1))}),n.f(4);case 5:return n.a(2)}},_callee,null,[[1,3,4,5]])})),"children":"刷新退款记录"})})]})]},e.id)})]})}},"6287":function(e,r,n){n.d(r,{"Ad":function(){return confirmReceive},"MV":function(){return listOrders},"N4":function(){return cancelOrder},"SK":function(){return getAvailableCouponsForOrder},"Tg":function(){return payOrder},"X9":function(){return createOrderFromCart},"r$":function(){return getOrder}});var t=n(8646),a=n(6673),i=n(7356);function createOrderFromCart(e){return _createOrderFromCart.apply(this,arguments)}function _createOrderFromCart(){return(_createOrderFromCart=(0,a.A)((0,t.A)().m(function _callee(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,i.Ay.post("/api/v1/orders/from-cart",e);case 1:return r=n.v,n.a(2,(0,i.Bm)(r))}},_callee)}))).apply(this,arguments)}function listOrders(){return _listOrders.apply(this,arguments)}function _listOrders(){return _listOrders=(0,a.A)((0,t.A)().m(function _callee2(){var e,r,n=arguments;return(0,t.A)().w(function(t){for(;;)switch(t.n){case 0:return e=n.length>0&&void 0!==n[0]?n[0]:{},t.n=1,i.Ay.get("/api/v1/orders",{"params":e});case 1:return r=t.v,t.a(2,(0,i.Bm)(r))}},_callee2)})),_listOrders.apply(this,arguments)}function getOrder(e){return _getOrder.apply(this,arguments)}function _getOrder(){return(_getOrder=(0,a.A)((0,t.A)().m(function _callee3(e){var r,n;return(0,t.A)().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,i.Ay.get("/api/v1/orders/".concat(e));case 1:return r=t.v,n=(0,i.Bm)(r),t.a(2,{"order":null==n?void 0:n.order,"items":Array.isArray(null==n?void 0:n.items)?n.items:[]})}},_callee3)}))).apply(this,arguments)}function cancelOrder(e,r){return _cancelOrder.apply(this,arguments)}function _cancelOrder(){return(_cancelOrder=(0,a.A)((0,t.A)().m(function _callee4(e,r){var n;return(0,t.A)().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,i.Ay.post("/api/v1/orders/".concat(e,"/cancel"),{"reason":r});case 1:n=t.v,(0,i.Bm)(n);case 2:return t.a(2)}},_callee4)}))).apply(this,arguments)}function payOrder(e){return _payOrder.apply(this,arguments)}function _payOrder(){return(_payOrder=(0,a.A)((0,t.A)().m(function _callee5(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,i.Ay.post("/api/v1/orders/".concat(e,"/pay"));case 1:r=n.v,(0,i.Bm)(r);case 2:return n.a(2)}},_callee5)}))).apply(this,arguments)}function confirmReceive(e){return _confirmReceive.apply(this,arguments)}function _confirmReceive(){return(_confirmReceive=(0,a.A)((0,t.A)().m(function _callee6(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,i.Ay.post("/api/v1/orders/".concat(e,"/receive"));case 1:r=n.v,(0,i.Bm)(r);case 2:return n.a(2)}},_callee6)}))).apply(this,arguments)}function getAvailableCouponsForOrder(e){return _getAvailableCouponsForOrder.apply(this,arguments)}function _getAvailableCouponsForOrder(){return(_getAvailableCouponsForOrder=(0,a.A)((0,t.A)().m(function _callee7(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,i.Ay.post("/api/v1/orders/available-coupons",e);case 1:return r=n.v,n.a(2,(0,i.Bm)(r))}},_callee7)}))).apply(this,arguments)}},"1371":function(e,r,n){n.d(r,{"c":function(){return listMyRefunds}});var t=n(8646),a=n(6673),i=n(7356);function listMyRefunds(){return _listMyRefunds.apply(this,arguments)}function _listMyRefunds(){return _listMyRefunds=(0,a.A)((0,t.A)().m(function _callee(){var e,r,n=arguments;return(0,t.A)().w(function(t){for(;;)switch(t.n){case 0:return e=n.length>0&&void 0!==n[0]?n[0]:{},t.n=1,i.Ay.get("/api/v1/refunds",{"params":e});case 1:return r=t.v,t.a(2,(0,i.Bm)(r))}},_callee)})),_listMyRefunds.apply(this,arguments)}},"213":function(e,r,n){n.d(r,{"Z":function(){return createTicket}});var t=n(8646),a=n(6673),i=n(7356);function createTicket(e){return _createTicket.apply(this,arguments)}function _createTicket(){return(_createTicket=(0,a.A)((0,t.A)().m(function _callee(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,i.Ay.post("/api/v1/tickets",e);case 1:return r=n.v,n.a(2,(0,i.Bm)(r))}},_callee)}))).apply(this,arguments)}},"5219":function(e,r,n){n.d(r,{"M0":function(){return formatAddress},"OT":function(){return loadDefaultAddress},"es":function(){return parseAddressInfo},"ns":function(){return saveDefaultAddress}});var t=n(8646),a=n(6045),i=n(6673),l=n(3846),c=n(6244),s=n(7356);function fetchDefaultAddress(){return _fetchDefaultAddress.apply(this,arguments)}function _fetchDefaultAddress(){return(_fetchDefaultAddress=(0,i.A)((0,t.A)().m(function _callee(){var e;return(0,t.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,s.Ay.get("/api/v1/user/default-address");case 1:return e=r.v,r.a(2,(0,s.Bm)(e))}},_callee)}))).apply(this,arguments)}function updateDefaultAddress(e){return _updateDefaultAddress.apply(this,arguments)}function _updateDefaultAddress(){return(_updateDefaultAddress=(0,i.A)((0,t.A)().m(function _callee2(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,s.Ay.put("/api/v1/user/default-address",{"address":e});case 1:return r=n.v,n.a(2,(0,s.Bm)(r))}},_callee2)}))).apply(this,arguments)}var u="tea_default_address";function parseAddressInfo(e){if(!e)return null;var r=e;if("string"==typeof r){var n=r.trim();if(!n)return null;try{r=JSON.parse(n)}catch(e){return{"detail":n,"full":n}}}if("object"===(0,l.A)(r)&&null!==r){var t=r.name||r.contact||r.receiver||r.consignee||r.userName,a=r.phone||r.mobile||r.tel||r.telNumber,i=[r.province,r.city,r.county,r.area,r.street,r.detail,r.detailInfo,r.address,r.full].filter(function(e){return"string"==typeof e&&e.trim().length>0}).map(function(e){return e.trim()}),c=r.detail||r.detailInfo||r.address||i.join(""),s=r.full||c||i.join("");return{"contact":t,"phone":a,"detail":c||s,"full":s||c}}return null}function formatAddress(e){return e?[e.contact,e.phone,e.detail||e.full].filter(function(e){return!!e}).join(" · "):""}function loadLocalDefaultAddress(){return _loadLocalDefaultAddress.apply(this,arguments)}function _loadLocalDefaultAddress(){return(_loadLocalDefaultAddress=(0,i.A)((0,t.A)().m(function _callee(){var e;return(0,t.A)().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,r.n=1,(0,c.c7)({"key":u});case 1:return e=r.v,r.a(2,e.data);case 2:return r.p=2,r.v,r.a(2,null)}},_callee,null,[[0,2]])}))).apply(this,arguments)}function saveLocalDefaultAddress(e){return _saveLocalDefaultAddress.apply(this,arguments)}function _saveLocalDefaultAddress(){return(_saveLocalDefaultAddress=(0,i.A)((0,t.A)().m(function _callee2(e){return(0,t.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,(0,c.cT)({"key":u,"data":e});case 1:return r.a(2)}},_callee2)}))).apply(this,arguments)}function toStoredAddress(e,r){var n=parseAddressInfo(e);if(!n)return null;var t=(0,a.A)((0,a.A)({},n),{},{"full":n.full||n.detail,"detail":n.detail||n.full,"updatedAt":null==r?void 0:r.updatedAt,"timestamp":Date.now(),"source":null==r?void 0:r.source});if(e&&"object"===(0,l.A)(e)){var i=e;i.orderId&&(t.orderId=Number(i.orderId)),i.orderNo&&(t.orderNo=String(i.orderNo))}return t}function fetchRemoteDefaultAddress(){return _fetchRemoteDefaultAddress.apply(this,arguments)}function _fetchRemoteDefaultAddress(){return(_fetchRemoteDefaultAddress=(0,i.A)((0,t.A)().m(function _callee3(){var e;return(0,t.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,fetchDefaultAddress();case 1:if(null!=(e=r.v)&&e.address){r.n=2;break}return r.a(2,null);case 2:return r.a(2,toStoredAddress(e.address,{"updatedAt":e.updated_at||void 0,"source":"server"}))}},_callee3)}))).apply(this,arguments)}function loadDefaultAddress(e){return _loadDefaultAddress.apply(this,arguments)}function _loadDefaultAddress(){return(_loadDefaultAddress=(0,i.A)((0,t.A)().m(function _callee4(e){var r,n;return(0,t.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:if(!1===(null==e?void 0:e.refreshRemote)){t.n=6;break}return t.p=1,t.n=2,fetchRemoteDefaultAddress();case 2:if(!(r=t.v)){t.n=4;break}return t.n=3,saveLocalDefaultAddress(r);case 3:return t.a(2,r);case 4:t.n=6;break;case 5:t.p=5,n=t.v,console.error("load remote default address failed",n);case 6:return t.a(2,loadLocalDefaultAddress())}},_callee4,null,[[1,5]])}))).apply(this,arguments)}function saveDefaultAddress(e,r){return _saveDefaultAddress.apply(this,arguments)}function _saveDefaultAddress(){return(_saveDefaultAddress=(0,i.A)((0,t.A)().m(function _callee5(e,r){var n,i;return(0,t.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:return n=(0,a.A)((0,a.A)({},e),{},{"timestamp":Date.now()}),t.n=1,saveLocalDefaultAddress(n);case 1:if(!1!==(null==r?void 0:r.syncRemote)){t.n=2;break}return t.a(2);case 2:return t.p=2,t.n=3,updateDefaultAddress({"contact":n.contact,"phone":n.phone,"detail":n.detail,"full":n.full,"orderId":n.orderId,"orderNo":n.orderNo,"updatedAt":n.updatedAt||(new Date).toISOString()});case 3:t.n=5;break;case 4:t.p=4,i=t.v,console.error("sync default address to server failed",i);case 5:return t.a(2)}},_callee5,null,[[2,4]])}))).apply(this,arguments)}}}]);