"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[307],{"8870":function(e,n,t){t.d(n,{"I8":function(){return c},"cr":function(){return l},"gT":function(){return i},"i5":function(){return r},"os":function(){return o},"vY":function(){return a}});var r="提示：设为当前门店仅用于筛选/浏览，您暂无门店管理权限",i="当前为只读模式，您暂无门店收款账户权限",o="当前为只读模式，您暂无门店财务权限",a="暂无门店管理权限",c="暂无门店收款账户权限",l="暂无门店财务权限"},"228":function(e,n,t){t.d(n,{"A":function(){return usePermission}});var r=t(8646),i=t(6673),o=t(9866),a=t(7378),c=t(4368);function usePermission(){var e=(0,a.useState)(null),n=(0,o.A)(e,2),t=n[0],l=n[1],s=(0,a.useState)(!0),u=(0,o.A)(s,2),d=u[0],f=u[1],p=(0,a.useCallback)((0,i.A)((0,r.A)().m(function _callee(){var e;return(0,r.A)().w(function(n){for(;;)switch(n.p=n.n){case 0:return f(!0),n.p=1,n.n=2,(0,c.$)();case 2:e=n.v,l((null==e?void 0:e.user)||null),n.n=4;break;case 3:n.p=3,n.v,l(null);case 4:return n.p=4,f(!1),n.f(4);case 5:return n.a(2)}},_callee,null,[[1,3,4,5]])})),[]);(0,a.useEffect)(function(){p()},[p]);var m=((null==t?void 0:t.role)||"").toLowerCase(),v=!!m&&m.includes("admin"),h=!!m&&(m.includes("admin")||m.includes("store:accounts")||m.includes("store")),S=!!m&&(m.includes("admin")||m.includes("store:finance")||m.includes("store"));return{"user":t,"role":m,"loading":d,"isAdmin":v,"allowedStoreMgmt":h||S,"allowedStoreAccounts":h,"allowedStoreFinance":S,"canManageStores":function canManageStores(e){var n=((null==e?void 0:e.role)||m||"").toLowerCase();return!!n&&(n.includes("admin")||n.includes("store"))},"canManageStoreAccounts":function canManageStoreAccounts(e){var n=((null==e?void 0:e.role)||m||"").toLowerCase();return!!n&&(n.includes("admin")||n.includes("store:accounts")||n.includes("store"))},"canManageStoreFinance":function canManageStoreFinance(e){var n=((null==e?void 0:e.role)||m||"").toLowerCase();return!!n&&(n.includes("admin")||n.includes("store:finance")||n.includes("store"))},"refresh":p}}},"5307":function(e,n,t){t.r(n),t.d(n,{"default":function(){return StoreFinancePage}});var r=t(3846),i=t(8646),o=t(6673),a=t(9866),c=t(7378),l=t(4657),s=t(1473),u=t(6244),d=t(9624),f=t(8785),p=t(4088),m=t(228),v=t(8870),h=t(6106);function StoreFinancePage(){var e=(0,c.useState)(void 0),n=(0,a.A)(e,2),t=n[0],S=n[1],y=(0,c.useState)([]),g=(0,a.A)(y,2),A=g[0],_=g[1],x=(0,c.useState)(!1),b=(0,a.A)(x,2),j=b[0],w=b[1],k=(0,c.useState)(void 0),T=(0,a.A)(k,2),C=T[0],E=T[1],F=(0,c.useState)(""),B=(0,a.A)(F,2),Y=B[0],N=B[1],P=(0,c.useState)(""),L=(0,a.A)(P,2),M=L[0],$=L[1],z=(0,c.useState)(1),R=(0,a.A)(z,2),W=R[0],I=R[1],D=(0,c.useState)(20),J=(0,a.A)(D,2),K=J[0],O=(J[1],(0,c.useState)(0)),q=(0,a.A)(O,2),G=q[0],H=q[1],Q=(0,c.useState)(!1),U=(0,a.A)(Q,2),V=U[0],X=U[1],Z=(0,m.A)();(0,c.useEffect)(function(){var e,n=(0,s.nI)().router,t=null==n||null===(e=n.params)||void 0===e?void 0:e.store_id;if(t){var r=Number(t);!Number.isNaN(r)&&r>0&&S(r)}else try{var i=(0,u.JF)("current_store_id"),o=i?Number(i):NaN;!Number.isNaN(o)&&o>0?(S(o),(0,d.P0)({"title":"已使用当前门店","icon":"none"})):(0,d.P0)({"title":"缺少门店信息，请从门店列表进入","icon":"none"})}catch(e){(0,d.P0)({"title":"缺少门店信息，请从门店列表进入","icon":"none"})}},[]);var ee=Z.allowedStoreFinance;function _fetchFinanceRecords(){return _fetchFinanceRecords=(0,o.A)((0,i.A)().m(function _callee2(e,n,t,r){var o,a,c,l,s,u,f=arguments;return(0,i.A)().w(function(i){for(;;)switch(i.p=i.n){case 0:return o=f.length>4&&void 0!==f[4]?f[4]:1,a=f.length>5&&void 0!==f[5]?f[5]:K,w(!0),X(!1),i.p=1,i.n=2,(0,p.FS)(e,{"page":o,"limit":a,"type":n,"start":t,"end":r});case 2:c=i.v,l=Array.isArray(null==c?void 0:c.data)?c.data:[],_(l),H(Number((null==c?void 0:c.total)||l.length||0)),i.n=4;break;case 3:i.p=3,u=i.v,console.error("load store finance records failed",u),404===((null==u||null===(s=u.response)||void 0===s?void 0:s.status)||(null==u?void 0:u.status))?(X(!0),(0,d.P0)({"title":"后端路由未提供","icon":"none"})):(0,d.P0)({"title":"财务流水加载失败","icon":"none"});case 4:return i.p=4,w(!1),i.f(4);case 5:return i.a(2)}},_callee2,null,[[1,3,4,5]])})),_fetchFinanceRecords.apply(this,arguments)}function changeType(e){E(e)}function goToStoresList(){try{f.Ay.navigateTo({"url":"/pages/stores/index"})}catch(e){f.Ay.switchTab({"url":"/pages/index/index"}).catch(function(){})}}function formatAmount(e){if(null==e)return"-";var n=Number(e);return Number.isNaN(n)?String(e):n.toFixed(2)}return(0,c.useEffect)(function(){t&&!ee&&(0,d.P0)({"title":v.cr,"icon":"none"})},[t,ee]),(0,c.useEffect)(function(){if(t){if(!ee)return;!function fetchFinanceRecords(e,n,t,r){return _fetchFinanceRecords.apply(this,arguments)}(t,C,Y||void 0,M||void 0,W,K)}},[t,C,Y,M,ee,W,K]),(0,h.jsxs)(l.Ss,{"style":{"padding":12},"children":[(0,h.jsxs)(l.Ss,{"style":{"display":"flex","alignItems":"center","justifyContent":"space-between"},"children":[(0,h.jsx)(l.EY,{"style":{"fontSize":18,"fontWeight":"bold"},"children":"门店财务流水"}),(0,h.jsxs)(l.Ss,{"style":{"display":"flex","flexDirection":"row","alignItems":"center"},"children":[(0,h.jsx)(l.$n,{"size":"mini","onClick":function goBackToDetail(){try{f.Ay.navigateBack({"delta":1})}catch(e){t?f.Ay.navigateTo({"url":"/pages/store-detail/index?store_id=".concat(t)}).catch(function(){}):f.Ay.switchTab({"url":"/pages/index/index"}).catch(function(){})}},"children":"返回门店详情"}),(0,h.jsx)(l.$n,{"size":"mini","style":{"marginLeft":8},"onClick":goToStoresList,"children":"回到门店列表"})]})]}),(0,h.jsx)(l.EY,{"style":{"color":"#999","marginTop":6,"display":"block"},"children":"提示：可通过右上角返回门店详情或回到门店列表"}),!ee&&(0,h.jsx)(l.EY,{"style":{"color":"#999","marginTop":8},"children":v.os}),ee&&V&&(0,h.jsx)(l.EY,{"style":{"color":"#999","marginTop":8},"children":"后端路由未提供（请升级后端版本以提供 /api/v1/stores/:id/finance/transactions）"}),(0,h.jsxs)(l.Ss,{"style":{"marginTop":12,"marginBottom":8,"display":"flex","flexDirection":"row","alignItems":"center","flexWrap":"wrap"},"children":[(0,h.jsx)(l.EY,{"children":"起始日期："}),(0,h.jsx)(l.LC,{"mode":"date","value":Y,"onChange":function handleStartChange(e){var n,t=null==e||null===(n=e.detail)||void 0===n?void 0:n.value;N(t||"")},"disabled":!ee,"children":(0,h.jsx)(l.Ss,{"style":{"padding":4,"borderWidth":1,"borderStyle":"solid","borderColor":"#ddd","minWidth":120,"marginRight":8},"children":(0,h.jsx)(l.EY,{"children":Y||"不限"})})}),(0,h.jsx)(l.EY,{"children":"结束日期："}),(0,h.jsx)(l.LC,{"mode":"date","value":M,"onChange":function handleEndChange(e){var n,t=null==e||null===(n=e.detail)||void 0===n?void 0:n.value;$(t||"")},"disabled":!ee,"children":(0,h.jsx)(l.Ss,{"style":{"padding":4,"borderWidth":1,"borderStyle":"solid","borderColor":"#ddd","minWidth":120},"children":(0,h.jsx)(l.EY,{"children":M||"不限"})})})]}),(0,h.jsxs)(l.Ss,{"style":{"marginTop":8,"marginBottom":12,"display":"flex","flexDirection":"row"},"children":[(0,h.jsx)(l.$n,{"size":"mini","disabled":!ee,"onClick":function onClick(){return changeType(void 0)},"children":"全部"}),(0,h.jsx)(l.$n,{"size":"mini","disabled":!ee,"onClick":function onClick(){return changeType("payment")},"style":{"marginLeft":8},"children":"收款"}),(0,h.jsx)(l.$n,{"size":"mini","disabled":!ee,"onClick":function onClick(){return changeType("refund")},"style":{"marginLeft":8},"children":"退款"}),(0,h.jsx)(l.$n,{"size":"mini","disabled":!ee,"onClick":function onClick(){return changeType("withdraw")},"style":{"marginLeft":8},"children":"提现"}),(0,h.jsx)(l.$n,{"size":"mini","disabled":!ee||V,"style":{"marginLeft":8},"onClick":(0,o.A)((0,i.A)().m(function _callee(){var e;return(0,i.A)().w(function(n){for(;;)switch(n.p=n.n){case 0:if(t){n.n=1;break}return n.a(2);case 1:return n.p=1,n.n=2,(0,p.jE)(t,{"type":C,"start":Y||void 0,"end":M||void 0});case 2:(0,d.P0)({"title":"已发起导出","icon":"none"}),n.n=4;break;case 3:n.p=3,e=n.v,console.error("export finance failed",e),(0,d.P0)({"title":"导出失败","icon":"none"});case 4:return n.a(2)}},_callee,null,[[1,3]])})),"children":"导出"})]}),j&&(0,h.jsx)(l.EY,{"children":"加载中..."}),!j&&ee&&V&&(0,h.jsx)(l.EY,{"style":{"color":"#999","marginTop":8},"children":"后端路由未提供，无法展示财务流水"}),!j&&ee&&!V&&!A.length&&(0,h.jsx)(l.EY,{"children":"暂无财务流水"}),!j&&ee&&!V&&A.map(function(e){return(0,h.jsxs)(l.Ss,{"style":{"marginBottom":12,"paddingBottom":8,"borderBottomWidth":1,"borderStyle":"solid","borderColor":"#eee"},"children":[(0,h.jsx)(l.Ss,{"style":{"marginBottom":4},"children":(0,h.jsxs)(l.EY,{"children":[(t=e.type,"payment"===t?"收款":"refund"===t?"退款":"withdraw"===t?"提现":t)," · ",(n=e.direction,"in"===n?"收入":"out"===n?"支出":n)]})}),(0,h.jsx)(l.Ss,{"style":{"marginBottom":2},"children":(0,h.jsxs)(l.EY,{"children":["金额：¥",formatAmount(e.amount)]})}),e.fee&&Number(e.fee)>0&&(0,h.jsx)(l.Ss,{"style":{"marginBottom":2},"children":(0,h.jsxs)(l.EY,{"children":["手续费：¥",formatAmount(e.fee)]})}),e.related_no&&(0,h.jsx)(l.Ss,{"style":{"marginBottom":2},"children":(0,h.jsxs)(l.EY,{"children":["关联单号：",e.related_no]})}),e.remark&&(0,h.jsx)(l.Ss,{"style":{"marginBottom":2},"children":(0,h.jsxs)(l.EY,{"children":["备注：",e.remark]})}),function(){try{var n=e.remark?JSON.parse(e.remark):null;if(!n||"object"!==(0,r.A)(n))return null;var t=n.phase,i=n.currency,o=n.amount_cents,a=n.fee_cents,c=n.net_cents,s=n.withdraw_no||e.related_no,u=[];return null!=t&&u.push({"label":"阶段","value":t}),null!=s&&u.push({"label":"提现单号","value":s}),null!=i&&u.push({"label":"币种","value":i}),null!=o&&u.push({"label":"金额(分)","value":o}),null!=a&&u.push({"label":"手续费(分)","value":a}),null!=c&&u.push({"label":"实付(分)","value":c}),u.length?(0,h.jsx)(l.Ss,{"style":{"marginTop":2,"marginBottom":2},"children":u.map(function(e){return(0,h.jsx)(l.Ss,{"style":{"marginBottom":2},"children":(0,h.jsxs)(l.EY,{"children":[e.label,"：",String(e.value)]})},String(e.label))})}):null}catch(e){return null}}(),e.created_at&&(0,h.jsx)(l.Ss,{"children":(0,h.jsxs)(l.EY,{"children":["时间：",e.created_at]})})]},"".concat(e.type,"-").concat(e.id));var n,t}),!j&&ee&&!V&&(0,h.jsxs)(l.Ss,{"style":{"marginTop":8,"display":"flex","flexDirection":"row","alignItems":"center"},"children":[(0,h.jsxs)(l.EY,{"children":["共 ",G," 条 · 每页 ",K," 条 · 第 ",W," 页"]}),(0,h.jsx)(l.$n,{"size":"mini","disabled":!ee||W<=1,"style":{"marginLeft":8},"onClick":function onClick(){return I(function(e){return Math.max(1,e-1)})},"children":"上一页"}),(0,h.jsx)(l.$n,{"size":"mini","disabled":!ee||A.length<K||W*K>=G,"style":{"marginLeft":8},"onClick":function onClick(){return I(function(e){return e+1})},"children":"下一页"})]}),!j&&(0,h.jsx)(l.Ss,{"style":{"marginTop":16,"display":"flex","justifyContent":"center"},"children":(0,h.jsx)(l.$n,{"size":"mini","onClick":goToStoresList,"children":"回到门店列表"})})]})}},"4368":function(e,n,t){t.d(n,{"$":function(){return getMeSummary}});var r=t(8646),i=t(3846),o=t(6673),a=t(7356);function getMeSummary(){return _getMeSummary.apply(this,arguments)}function _getMeSummary(){return(_getMeSummary=(0,o.A)((0,r.A)().m(function _callee(){var e,n,t,o,c,l,s,u,d,f,p,m,v,h,S,y,g,A,_,x,b,j;return(0,r.A)().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,r.n=1,a.Ay.get("/api/v1/users/me/summary");case 1:if(e=r.v,!(n=(0,a.Bm)(e))||"object"!==(0,i.A)(n)){r.n=6;break}if(!n.user||"object"!==(0,i.A)(n.user)){r.n=2;break}return r.a(2,n);case 2:if(void 0===(c=null!==(t=null!==(o=n.user_id)&&void 0!==o?o:n.uid)&&void 0!==t?t:n.id)){r.n=3;break}return u={"id":Number(c)||0,"nickname":null!==(l=null!==(s=n.nickname)&&void 0!==s?s:n.name)&&void 0!==l?l:"","phone":n.phone,"avatar":n.avatar,"role":n.role||"user"},d=n.wallet_balance,f={"balance_cents":"number"==typeof d?Math.round(100*d):void 0},p={"balance":"number"==typeof n.points?n.points:void 0},m={"available_count":"number"==typeof n.coupons?n.coupons:void 0},r.a(2,{"user":u,"wallet":f,"points":p,"coupons":m});case 3:return r.p=3,r.n=4,a.Ay.get("/api/v1/user/info");case 4:return g=r.v,A=(0,a.Bm)(g),_={"id":Number(null!==(v=null!==(h=A.id)&&void 0!==h?h:A.uid)&&void 0!==v?v:0)||0,"nickname":null!==(S=null!==(y=A.nickname)&&void 0!==y?y:A.name)&&void 0!==S?S:"","phone":A.phone,"avatar":A.avatar,"role":A.role||"user"},r.a(2,{"user":_});case 5:r.p=5,r.v;case 6:return r.a(2,n);case 7:return r.p=7,j=r.v,r.p=8,r.n=9,a.Ay.get("/api/v1/user/info");case 9:return x=r.v,b=(0,a.Bm)(x),r.a(2,{"user":{"id":null==b?void 0:b.id,"uid":null==b?void 0:b.uid,"open_id":null==b?void 0:b.open_id,"nickname":null==b?void 0:b.nickname,"avatar":null==b?void 0:b.avatar,"phone":null==b?void 0:b.phone,"gender":null==b?void 0:b.gender,"balance":null==b?void 0:b.balance,"points":null==b?void 0:b.points,"role":null==b?void 0:b.role},"wallet":{"balance_cents":"number"==typeof(null==b?void 0:b.balance)?Math.round(100*b.balance):void 0},"points":{"balance":null==b?void 0:b.points}});case 10:throw r.p=10,r.v,j;case 11:return r.a(2)}},_callee,null,[[8,10],[3,5],[0,7]])}))).apply(this,arguments)}},"4088":function(e,n,t){t.d(n,{"EC":function(){return listStoreAccounts},"FS":function(){return listStoreFinanceTransactions},"KA":function(){return getStore},"KW":function(){return updateStoreAccount},"Rr":function(){return listStores},"gg":function(){return deleteStoreAccount},"iR":function(){return listStoreExclusiveProducts},"jE":function(){return exportStoreFinanceTransactions},"n9":function(){return createStoreAccount}});var r=t(8646),i=t(6673),o=t(7356);function listStores(){return _listStores.apply(this,arguments)}function _listStores(){return _listStores=(0,i.A)((0,r.A)().m(function _callee(){var e,n,t=arguments;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return e=t.length>0&&void 0!==t[0]?t[0]:{},r.n=1,o.Ay.get("/api/v1/stores",{"params":e});case 1:return n=r.v,r.a(2,(0,o.Bm)(n))}},_callee)})),_listStores.apply(this,arguments)}function getStore(e){return _getStore.apply(this,arguments)}function _getStore(){return(_getStore=(0,i.A)((0,r.A)().m(function _callee2(e){var n;return(0,r.A)().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,o.Ay.get("/api/v1/stores/".concat(e));case 1:return n=t.v,t.a(2,(0,o.Bm)(n))}},_callee2)}))).apply(this,arguments)}function listStoreExclusiveProducts(e){return _listStoreExclusiveProducts.apply(this,arguments)}function _listStoreExclusiveProducts(){return _listStoreExclusiveProducts=(0,i.A)((0,r.A)().m(function _callee3(e){var n,t,i=arguments;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},r.n=1,o.Ay.get("/api/v1/stores/".concat(e,"/exclusive-products"),{"params":n});case 1:return t=r.v,r.a(2,(0,o.Bm)(t))}},_callee3)})),_listStoreExclusiveProducts.apply(this,arguments)}function listStoreAccounts(e){return _listStoreAccounts.apply(this,arguments)}function _listStoreAccounts(){return(_listStoreAccounts=(0,i.A)((0,r.A)().m(function _callee4(e){var n;return(0,r.A)().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,o.Ay.get("/api/v1/stores/".concat(e,"/accounts"));case 1:return n=t.v,t.a(2,(0,o.Bm)(n))}},_callee4)}))).apply(this,arguments)}function createStoreAccount(e,n){return _createStoreAccount.apply(this,arguments)}function _createStoreAccount(){return(_createStoreAccount=(0,i.A)((0,r.A)().m(function _callee5(e,n){var t;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,o.Ay.post("/api/v1/stores/".concat(e,"/accounts"),n);case 1:return t=r.v,r.a(2,(0,o.Bm)(t))}},_callee5)}))).apply(this,arguments)}function updateStoreAccount(e,n,t){return _updateStoreAccount.apply(this,arguments)}function _updateStoreAccount(){return(_updateStoreAccount=(0,i.A)((0,r.A)().m(function _callee6(e,n,t){var i;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,o.Ay.put("/api/v1/stores/".concat(e,"/accounts/").concat(n),t);case 1:return i=r.v,r.a(2,(0,o.Bm)(i))}},_callee6)}))).apply(this,arguments)}function deleteStoreAccount(e,n){return _deleteStoreAccount.apply(this,arguments)}function _deleteStoreAccount(){return(_deleteStoreAccount=(0,i.A)((0,r.A)().m(function _callee7(e,n){var t;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,o.Ay.delete("/api/v1/stores/".concat(e,"/accounts/").concat(n));case 1:return t=r.v,r.a(2,(0,o.Bm)(t))}},_callee7)}))).apply(this,arguments)}function listStoreFinanceTransactions(e){return _listStoreFinanceTransactions.apply(this,arguments)}function _listStoreFinanceTransactions(){return _listStoreFinanceTransactions=(0,i.A)((0,r.A)().m(function _callee8(e){var n,t,i=arguments;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},r.n=1,o.Ay.get("/api/v1/stores/".concat(e,"/finance/transactions"),{"params":n});case 1:return t=r.v,r.a(2,(0,o.Bm)(t))}},_callee8)})),_listStoreFinanceTransactions.apply(this,arguments)}function exportStoreFinanceTransactions(e){return _exportStoreFinanceTransactions.apply(this,arguments)}function _exportStoreFinanceTransactions(){return _exportStoreFinanceTransactions=(0,i.A)((0,r.A)().m(function _callee9(e){var n,t=arguments;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return n=t.length>1&&void 0!==t[1]?t[1]:{},r.n=1,o.Ay.get("/api/v1/stores/".concat(e,"/finance/transactions/export"),{"params":n,"responseType":"blob"});case 1:return r.a(2)}},_callee9)})),_exportStoreFinanceTransactions.apply(this,arguments)}}}]);