"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[587],{"8870":function(e,n,t){t.d(n,{"I8":function(){return i},"cr":function(){return s},"gT":function(){return c},"i5":function(){return r},"os":function(){return o},"vY":function(){return a}});var r="提示：设为当前门店仅用于筛选/浏览，您暂无门店管理权限",c="当前为只读模式，您暂无门店收款账户权限",o="当前为只读模式，您暂无门店财务权限",a="暂无门店管理权限",i="暂无门店收款账户权限",s="暂无门店财务权限"},"228":function(e,n,t){t.d(n,{"A":function(){return usePermission}});var r=t(8646),c=t(6673),o=t(9866),a=t(7378),i=t(4368);function usePermission(){var e=(0,a.useState)(null),n=(0,o.A)(e,2),t=n[0],s=n[1],u=(0,a.useState)(!0),l=(0,o.A)(u,2),d=l[0],p=l[1],f=(0,a.useCallback)((0,c.A)((0,r.A)().m(function _callee(){var e;return(0,r.A)().w(function(n){for(;;)switch(n.p=n.n){case 0:return p(!0),n.p=1,n.n=2,(0,i.$)();case 2:e=n.v,s((null==e?void 0:e.user)||null),n.n=4;break;case 3:n.p=3,n.v,s(null);case 4:return n.p=4,p(!1),n.f(4);case 5:return n.a(2)}},_callee,null,[[1,3,4,5]])})),[]);(0,a.useEffect)(function(){f()},[f]);var h=((null==t?void 0:t.role)||"").toLowerCase(),m=!!h&&h.includes("admin"),v=!!h&&(h.includes("admin")||h.includes("store:accounts")||h.includes("store")),A=!!h&&(h.includes("admin")||h.includes("store:finance")||h.includes("store"));return{"user":t,"role":h,"loading":d,"isAdmin":m,"allowedStoreMgmt":v||A,"allowedStoreAccounts":v,"allowedStoreFinance":A,"canManageStores":function canManageStores(e){var n=((null==e?void 0:e.role)||h||"").toLowerCase();return!!n&&(n.includes("admin")||n.includes("store"))},"canManageStoreAccounts":function canManageStoreAccounts(e){var n=((null==e?void 0:e.role)||h||"").toLowerCase();return!!n&&(n.includes("admin")||n.includes("store:accounts")||n.includes("store"))},"canManageStoreFinance":function canManageStoreFinance(e){var n=((null==e?void 0:e.role)||h||"").toLowerCase();return!!n&&(n.includes("admin")||n.includes("store:finance")||n.includes("store"))},"refresh":f}}},"1587":function(e,n,t){t.r(n),t.d(n,{"default":function(){return StoreAccountsPage}});var r=t(8646),c=t(6673),o=t(9866),a=t(7378),i=t(4657),s=t(1473),u=t(9624),l=t(4088),d=t(228),p=t(8870),f=t(6106);function StoreAccountsPage(){var e,n=(0,s.nI)(),t=null==n||null===(e=n.router)||void 0===e||null===(e=e.params)||void 0===e?void 0:e.store_id,h=t?Number(t):NaN,m=(0,a.useState)(Number.isFinite(h)&&h>0?h:null),v=(0,o.A)(m,2),A=v[0],S=(v[1],(0,a.useState)([])),_=(0,o.A)(S,2),y=_[0],g=_[1],x=(0,a.useState)(!1),b=(0,o.A)(x,2),w=b[0],j=b[1],k=(0,a.useState)(!1),E=(0,o.A)(k,2),B=E[0],P=E[1],F=(0,a.useState)(null),C=(0,o.A)(F,2),T=C[0],I=C[1],Y=(0,a.useState)("bank"),M=(0,o.A)(Y,2),D=M[0],N=M[1],$=(0,a.useState)(""),z=(0,o.A)($,2),R=z[0],W=z[1],L=(0,a.useState)(""),K=(0,o.A)(L,2),J=K[0],O=K[1],q=(0,a.useState)(""),G=(0,o.A)(q,2),H=G[0],Q=G[1],U=(0,a.useState)(!1),V=(0,o.A)(U,2),X=V[0],Z=V[1],ee=(0,d.A)();(0,a.useEffect)(function(){A?fetchAccounts(A):(0,u.P0)({"title":"缺少门店信息，请从首页进入","icon":"none"})},[A]);var ne=ee.allowedStoreAccounts;function fetchAccounts(e){return _fetchAccounts.apply(this,arguments)}function _fetchAccounts(){return(_fetchAccounts=(0,c.A)((0,r.A)().m(function _callee(e){var n,t;return(0,r.A)().w(function(r){for(;;)switch(r.p=r.n){case 0:return j(!0),r.p=1,r.n=2,(0,l.EC)(e);case 2:n=r.v,g(n||[]),r.n=4;break;case 3:r.p=3,t=r.v,console.error("load store accounts failed",t),(0,u.P0)({"title":"加载收款账户失败","icon":"none"});case 4:return r.p=4,j(!1),r.f(4);case 5:return r.a(2)}},_callee,null,[[1,3,4,5]])}))).apply(this,arguments)}function resetForm(){I(null),N("bank"),W(""),O(""),Q(""),Z(!1)}function _handleSubmit(){return(_handleSubmit=(0,c.A)((0,r.A)().m(function _callee2(){var e,n;return(0,r.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:if(A){t.n=1;break}return(0,u.P0)({"title":"缺少门店信息","icon":"none"}),t.a(2);case 1:if(ne){t.n=2;break}return(0,u.P0)({"title":p.I8,"icon":"none"}),t.a(2);case 2:if(R&&J){t.n=3;break}return(0,u.P0)({"title":"请填写账户名和账号","icon":"none"}),t.a(2);case 3:if(e={"account_type":D,"account_name":R,"account_no":J,"bank_name":H,"is_default":X},t.p=4,!T){t.n=6;break}return t.n=5,(0,l.KW)(A,T.id,e);case 5:(0,u.P0)({"title":"已更新","icon":"success"}),t.n=8;break;case 6:return t.n=7,(0,l.n9)(A,e);case 7:(0,u.P0)({"title":"已新增","icon":"success"});case 8:resetForm(),fetchAccounts(A),t.n=10;break;case 9:t.p=9,n=t.v,console.error("submit account failed",n),(0,u.P0)({"title":"保存失败","icon":"none"});case 10:return t.a(2)}},_callee2,null,[[4,9]])}))).apply(this,arguments)}function _handleDelete(){return(_handleDelete=(0,c.A)((0,r.A)().m(function _callee3(e){var n;return(0,r.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:if(A){t.n=1;break}return t.a(2);case 1:if(ne){t.n=2;break}return(0,u.P0)({"title":p.I8,"icon":"none"}),t.a(2);case 2:return t.n=3,(0,u.to)({"title":"确认删除","content":"删除后将无法恢复，确认删除该收款账户吗？"});case 3:if(t.v.confirm){t.n=4;break}return t.a(2);case 4:return t.p=4,t.n=5,(0,l.gg)(A,e.id);case 5:(0,u.P0)({"title":"已删除","icon":"success"}),T&&T.id===e.id&&resetForm(),fetchAccounts(A),t.n=7;break;case 6:t.p=6,n=t.v,console.error("delete account failed",n),(0,u.P0)({"title":"删除失败","icon":"none"});case 7:return t.a(2)}},_callee3,null,[[4,6]])}))).apply(this,arguments)}return(0,f.jsxs)(i.Ss,{"style":{"padding":12},"children":[(0,f.jsx)(i.Ss,{"style":{"marginBottom":12},"children":(0,f.jsx)(i.EY,{"style":{"fontSize":18,"fontWeight":"bold"},"children":"门店收款账户设置"})}),(0,f.jsxs)(i.Ss,{"style":{"marginBottom":12,"display":"flex","flexDirection":"row","alignItems":"center"},"children":[(0,f.jsx)(i.EY,{"style":{"marginRight":8},"children":"只看默认账户"}),(0,f.jsx)(i.dO,{"checked":B,"onChange":function onChange(e){return P(!!e.detail.value)}})]}),w&&(0,f.jsx)(i.EY,{"children":"加载中..."}),!w&&(B?0===y.filter(function(e){return e.is_default}).length:0===y.length)&&(0,f.jsx)(i.EY,{"children":"暂未配置收款账户"}),!w&&(B?y.filter(function(e){return e.is_default}):y).length>0&&(0,f.jsx)(i.Ss,{"style":{"marginBottom":16},"children":(B?y.filter(function(e){return e.is_default}):y).map(function renderAccountItem(e){return(0,f.jsxs)(i.Ss,{"style":{"padding":12,"marginBottom":8,"borderWidth":1,"borderStyle":"solid","borderColor":"#eee","borderRadius":4},"children":[(0,f.jsxs)(i.Ss,{"style":{"marginBottom":4,"display":"flex","flexDirection":"row","justifyContent":"space-between"},"children":[(0,f.jsxs)(i.EY,{"children":[e.account_name," (",e.account_type||"bank",")"]}),e.is_default&&(0,f.jsx)(i.EY,{"style":{"color":"#07c160"},"children":"默认"})]}),(0,f.jsx)(i.Ss,{"style":{"marginBottom":4},"children":(0,f.jsxs)(i.EY,{"children":["账号：",e.account_no]})}),e.bank_name&&(0,f.jsx)(i.Ss,{"style":{"marginBottom":4},"children":(0,f.jsxs)(i.EY,{"children":["银行/渠道：",e.bank_name]})}),(0,f.jsxs)(i.Ss,{"style":{"display":"flex","flexDirection":"row"},"children":[(0,f.jsx)(i.$n,{"size":"mini","disabled":!ne,"onClick":function onClick(){return function startEdit(e){ne?(I(e),N(e.account_type||"bank"),W(e.account_name||""),O(e.account_no||""),Q(e.bank_name||""),Z(!!e.is_default)):(0,u.P0)({"title":p.I8,"icon":"none"})}(e)},"children":"编辑"}),(0,f.jsx)(i.Ss,{"style":{"width":8}}),(0,f.jsx)(i.$n,{"size":"mini","type":"warn","disabled":!ne,"onClick":function onClick(){return function handleDelete(e){return _handleDelete.apply(this,arguments)}(e)},"children":"删除"})]})]},e.id)})}),(0,f.jsxs)(i.Ss,{"style":{"marginTop":12,"paddingTop":12,"borderTopWidth":1,"borderStyle":"solid","borderColor":"#eee"},"children":[(0,f.jsx)(i.EY,{"style":{"fontSize":16,"marginBottom":8},"children":T?"编辑收款账户":"新增收款账户"}),!ne&&(0,f.jsx)(i.EY,{"style":{"color":"#999","marginBottom":8},"children":p.gT}),(0,f.jsxs)(i.Ss,{"style":{"marginBottom":8},"children":[(0,f.jsx)(i.EY,{"children":"账户类型（bank / alipay / wechat）"}),(0,f.jsx)(i.pd,{"type":"text","value":D,"onInput":function onInput(e){return N(e.detail.value)},"placeholder":"bank / alipay / wechat"})]}),(0,f.jsxs)(i.Ss,{"style":{"marginBottom":8},"children":[(0,f.jsx)(i.EY,{"children":"账户名"}),(0,f.jsx)(i.pd,{"type":"text","value":R,"onInput":function onInput(e){return W(e.detail.value)},"placeholder":"请输入账户开户名"})]}),(0,f.jsxs)(i.Ss,{"style":{"marginBottom":8},"children":[(0,f.jsx)(i.EY,{"children":"账号 / 收款号"}),(0,f.jsx)(i.pd,{"type":"text","value":J,"onInput":function onInput(e){return O(e.detail.value)},"placeholder":"银行卡号 / 支付宝账号等"})]}),(0,f.jsxs)(i.Ss,{"style":{"marginBottom":8},"children":[(0,f.jsx)(i.EY,{"children":"银行名称 / 渠道名称（可选）"}),(0,f.jsx)(i.pd,{"type":"text","value":H,"onInput":function onInput(e){return Q(e.detail.value)},"placeholder":"如 中国银行杭州分行 / 支付宝"})]}),(0,f.jsxs)(i.Ss,{"style":{"marginBottom":12,"display":"flex","flexDirection":"row","alignItems":"center"},"children":[(0,f.jsx)(i.EY,{"style":{"marginRight":8},"children":"设为默认账户"}),(0,f.jsx)(i.dO,{"checked":X,"onChange":function onChange(e){return Z(!!e.detail.value)}})]}),(0,f.jsx)(i.$n,{"type":"primary","disabled":!ne,"onClick":function handleSubmit(){return _handleSubmit.apply(this,arguments)},"children":T?"保存修改":"新增账户"}),T&&(0,f.jsx)(i.Ss,{"style":{"marginTop":8},"children":(0,f.jsx)(i.$n,{"size":"mini","onClick":resetForm,"children":"取消编辑"})})]})]})}},"4368":function(e,n,t){t.d(n,{"$":function(){return getMeSummary}});var r=t(8646),c=t(3846),o=t(6673),a=t(7356);function getMeSummary(){return _getMeSummary.apply(this,arguments)}function _getMeSummary(){return(_getMeSummary=(0,o.A)((0,r.A)().m(function _callee(){var e,n,t,o,i,s,u,l,d,p,f,h,m,v,A,S,_,y,g,x,b,w;return(0,r.A)().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,r.n=1,a.Ay.get("/api/v1/users/me/summary");case 1:if(e=r.v,!(n=(0,a.Bm)(e))||"object"!==(0,c.A)(n)){r.n=6;break}if(!n.user||"object"!==(0,c.A)(n.user)){r.n=2;break}return r.a(2,n);case 2:if(void 0===(i=null!==(t=null!==(o=n.user_id)&&void 0!==o?o:n.uid)&&void 0!==t?t:n.id)){r.n=3;break}return l={"id":Number(i)||0,"nickname":null!==(s=null!==(u=n.nickname)&&void 0!==u?u:n.name)&&void 0!==s?s:"","phone":n.phone,"avatar":n.avatar,"role":n.role||"user"},d=n.wallet_balance,p={"balance_cents":"number"==typeof d?Math.round(100*d):void 0},f={"balance":"number"==typeof n.points?n.points:void 0},h={"available_count":"number"==typeof n.coupons?n.coupons:void 0},r.a(2,{"user":l,"wallet":p,"points":f,"coupons":h});case 3:return r.p=3,r.n=4,a.Ay.get("/api/v1/user/info");case 4:return _=r.v,y=(0,a.Bm)(_),g={"id":Number(null!==(m=null!==(v=y.id)&&void 0!==v?v:y.uid)&&void 0!==m?m:0)||0,"nickname":null!==(A=null!==(S=y.nickname)&&void 0!==S?S:y.name)&&void 0!==A?A:"","phone":y.phone,"avatar":y.avatar,"role":y.role||"user"},r.a(2,{"user":g});case 5:r.p=5,r.v;case 6:return r.a(2,n);case 7:return r.p=7,w=r.v,r.p=8,r.n=9,a.Ay.get("/api/v1/user/info");case 9:return x=r.v,b=(0,a.Bm)(x),r.a(2,{"user":{"id":null==b?void 0:b.id,"uid":null==b?void 0:b.uid,"open_id":null==b?void 0:b.open_id,"nickname":null==b?void 0:b.nickname,"avatar":null==b?void 0:b.avatar,"phone":null==b?void 0:b.phone,"gender":null==b?void 0:b.gender,"balance":null==b?void 0:b.balance,"points":null==b?void 0:b.points,"role":null==b?void 0:b.role},"wallet":{"balance_cents":"number"==typeof(null==b?void 0:b.balance)?Math.round(100*b.balance):void 0},"points":{"balance":null==b?void 0:b.points}});case 10:throw r.p=10,r.v,w;case 11:return r.a(2)}},_callee,null,[[8,10],[3,5],[0,7]])}))).apply(this,arguments)}},"4088":function(e,n,t){t.d(n,{"EC":function(){return listStoreAccounts},"FS":function(){return listStoreFinanceTransactions},"KA":function(){return getStore},"KW":function(){return updateStoreAccount},"Rr":function(){return listStores},"gg":function(){return deleteStoreAccount},"iR":function(){return listStoreExclusiveProducts},"jE":function(){return exportStoreFinanceTransactions},"n9":function(){return createStoreAccount}});var r=t(8646),c=t(6673),o=t(7356);function listStores(){return _listStores.apply(this,arguments)}function _listStores(){return _listStores=(0,c.A)((0,r.A)().m(function _callee(){var e,n,t=arguments;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return e=t.length>0&&void 0!==t[0]?t[0]:{},r.n=1,o.Ay.get("/api/v1/stores",{"params":e});case 1:return n=r.v,r.a(2,(0,o.Bm)(n))}},_callee)})),_listStores.apply(this,arguments)}function getStore(e){return _getStore.apply(this,arguments)}function _getStore(){return(_getStore=(0,c.A)((0,r.A)().m(function _callee2(e){var n;return(0,r.A)().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,o.Ay.get("/api/v1/stores/".concat(e));case 1:return n=t.v,t.a(2,(0,o.Bm)(n))}},_callee2)}))).apply(this,arguments)}function listStoreExclusiveProducts(e){return _listStoreExclusiveProducts.apply(this,arguments)}function _listStoreExclusiveProducts(){return _listStoreExclusiveProducts=(0,c.A)((0,r.A)().m(function _callee3(e){var n,t,c=arguments;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return n=c.length>1&&void 0!==c[1]?c[1]:{},r.n=1,o.Ay.get("/api/v1/stores/".concat(e,"/exclusive-products"),{"params":n});case 1:return t=r.v,r.a(2,(0,o.Bm)(t))}},_callee3)})),_listStoreExclusiveProducts.apply(this,arguments)}function listStoreAccounts(e){return _listStoreAccounts.apply(this,arguments)}function _listStoreAccounts(){return(_listStoreAccounts=(0,c.A)((0,r.A)().m(function _callee4(e){var n;return(0,r.A)().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,o.Ay.get("/api/v1/stores/".concat(e,"/accounts"));case 1:return n=t.v,t.a(2,(0,o.Bm)(n))}},_callee4)}))).apply(this,arguments)}function createStoreAccount(e,n){return _createStoreAccount.apply(this,arguments)}function _createStoreAccount(){return(_createStoreAccount=(0,c.A)((0,r.A)().m(function _callee5(e,n){var t;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,o.Ay.post("/api/v1/stores/".concat(e,"/accounts"),n);case 1:return t=r.v,r.a(2,(0,o.Bm)(t))}},_callee5)}))).apply(this,arguments)}function updateStoreAccount(e,n,t){return _updateStoreAccount.apply(this,arguments)}function _updateStoreAccount(){return(_updateStoreAccount=(0,c.A)((0,r.A)().m(function _callee6(e,n,t){var c;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,o.Ay.put("/api/v1/stores/".concat(e,"/accounts/").concat(n),t);case 1:return c=r.v,r.a(2,(0,o.Bm)(c))}},_callee6)}))).apply(this,arguments)}function deleteStoreAccount(e,n){return _deleteStoreAccount.apply(this,arguments)}function _deleteStoreAccount(){return(_deleteStoreAccount=(0,c.A)((0,r.A)().m(function _callee7(e,n){var t;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,o.Ay.delete("/api/v1/stores/".concat(e,"/accounts/").concat(n));case 1:return t=r.v,r.a(2,(0,o.Bm)(t))}},_callee7)}))).apply(this,arguments)}function listStoreFinanceTransactions(e){return _listStoreFinanceTransactions.apply(this,arguments)}function _listStoreFinanceTransactions(){return _listStoreFinanceTransactions=(0,c.A)((0,r.A)().m(function _callee8(e){var n,t,c=arguments;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return n=c.length>1&&void 0!==c[1]?c[1]:{},r.n=1,o.Ay.get("/api/v1/stores/".concat(e,"/finance/transactions"),{"params":n});case 1:return t=r.v,r.a(2,(0,o.Bm)(t))}},_callee8)})),_listStoreFinanceTransactions.apply(this,arguments)}function exportStoreFinanceTransactions(e){return _exportStoreFinanceTransactions.apply(this,arguments)}function _exportStoreFinanceTransactions(){return _exportStoreFinanceTransactions=(0,c.A)((0,r.A)().m(function _callee9(e){var n,t=arguments;return(0,r.A)().w(function(r){for(;;)switch(r.n){case 0:return n=t.length>1&&void 0!==t[1]?t[1]:{},r.n=1,o.Ay.get("/api/v1/stores/".concat(e,"/finance/transactions/export"),{"params":n,"responseType":"blob"});case 1:return r.a(2)}},_callee9)})),_exportStoreFinanceTransactions.apply(this,arguments)}}}]);