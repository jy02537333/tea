"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[858],{"5858":function(n,e,t){t.r(e),t.d(e,{"default":function(){return LoginPage}});var r=t(8646),o=t(6673),i=t(9866),a=t(7378),l=t(4657),c=t(1473),u=t(8785),s=t(5103),f=t(9624),d=t(3312),p=t(7356),g=t(6106);function LoginPage(){var n=(0,a.useState)(""),e=(0,i.A)(n,2),t=e[0],h=e[1],y=(0,a.useState)(!1),v=(0,i.A)(y,2),m=v[0],x=v[1],A=(0,a.useState)(null),b=(0,i.A)(A,2),k=b[0],_=b[1],j=(0,a.useState)(!1),w=(0,i.A)(j,2),P=w[0],T=w[1],L=(0,a.useState)("phone"),S=(0,i.A)(L,2),C=S[0],I=S[1],E=(0,a.useState)("18985121575"),D=(0,i.A)(E,2),W=D[0],R=D[1],U=(0,a.useState)("000000"),Y=(0,i.A)(U,2),B=Y[0],$=Y[1];function getRedirectTarget(){try{var n,e=(0,c.nI)().router,t=null==e||null===(n=e.params)||void 0===n?void 0:n.redirect;if(!t)return"";var r=function(){try{return decodeURIComponent(String(t))}catch(n){return String(t)}}(),o=r.startsWith("/")?r:"/".concat(r);return o.startsWith("/pages/")?o:""}catch(n){return""}}function navigateAfterLogin(){return _navigateAfterLogin.apply(this,arguments)}function _navigateAfterLogin(){return(_navigateAfterLogin=(0,o.A)((0,r.A)().m(function _callee(){var n,e;return(0,r.A)().w(function(t){for(;;)switch(t.n){case 0:if(!(n=getRedirectTarget())){t.n=4;break}if(e=n.split("?")[0]||n,!("/pages/index/index"===e||"/pages/cart/index"===e||"/pages/profile/index"===e)){t.n=2;break}return t.n=1,u.Ay.switchTab({"url":e});case 1:case 3:case 5:return t.a(2);case 2:return t.n=3,u.Ay.redirectTo({"url":n});case 4:return t.n=5,u.Ay.switchTab({"url":"/pages/index/index"}).catch(function(){return u.Ay.redirectTo({"url":"/pages/index/index"})})}},_callee)}))).apply(this,arguments)}function fetchProfile(){return _fetchProfile.apply(this,arguments)}function _fetchProfile(){return(_fetchProfile=(0,o.A)((0,r.A)().m(function _callee2(){var n;return(0,r.A)().w(function(e){for(;;)switch(e.p=e.n){case 0:return T(!0),e.p=1,e.n=2,(0,d.ug)();case 2:n=e.v,_(n),e.n=4;break;case 3:e.p=3,e.v,_(null);case 4:return e.p=4,T(!1),e.f(4);case 5:return e.a(2)}},_callee2,null,[[1,3,4,5]])}))).apply(this,arguments)}function _handleWxLogin(){return(_handleWxLogin=(0,o.A)((0,r.A)().m(function _callee3(){var n,e;return(0,r.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:return x(!0),t.p=1,t.n=2,(0,s.iD)();case 2:if((n=t.v).code){t.n=3;break}throw new Error("未获取到微信 code");case 3:return t.n=4,(0,d.iD)({"wechat_code":n.code});case 4:return t.n=5,fetchProfile();case 5:(0,f.P0)({"title":"登录成功","icon":"success","duration":1200}),setTimeout(function(){navigateAfterLogin()},500),t.n=7;break;case 6:t.p=6,e=t.v,(0,f.P0)({"title":(null==e?void 0:e.message)||"登录失败","icon":"none","duration":1500});case 7:return t.p=7,x(!1),t.f(7);case 8:return t.a(2)}},_callee3,null,[[1,6,7,8]])}))).apply(this,arguments)}function _handlePhoneLogin(){return(_handlePhoneLogin=(0,o.A)((0,r.A)().m(function _callee4(){var n;return(0,r.A)().w(function(e){for(;;)switch(e.p=e.n){case 0:if(W&&B){e.n=1;break}return(0,f.P0)({"title":"请输入手机号与验证码","icon":"none"}),e.a(2);case 1:return x(!0),e.p=2,e.n=3,(0,d.iD)({"phone":W,"code":B});case 3:return e.n=4,fetchProfile();case 4:(0,f.P0)({"title":"登录成功","icon":"success","duration":1200}),setTimeout(function(){navigateAfterLogin()},500),e.n=6;break;case 5:e.p=5,n=e.v,(0,f.P0)({"title":(null==n?void 0:n.message)||"登录失败","icon":"none","duration":1500});case 6:return e.p=6,x(!1),e.f(6);case 7:return e.a(2)}},_callee4,null,[[2,5,6,7]])}))).apply(this,arguments)}function _handleDevLogin(){return(_handleDevLogin=(0,o.A)((0,r.A)().m(function _callee5(){var n;return(0,r.A)().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t){e.n=1;break}return(0,f.P0)({"title":"请输入 openid","icon":"none"}),e.a(2);case 1:return x(!0),e.p=2,e.n=3,(0,d.iD)({"openid":t});case 3:return e.n=4,fetchProfile();case 4:(0,f.P0)({"title":"Dev 登录成功","icon":"success","duration":1200}),setTimeout(function(){navigateAfterLogin()},300),e.n=6;break;case 5:e.p=5,n=e.v,(0,f.P0)({"title":(null==n?void 0:n.message)||"Dev 登录失败","icon":"none"});case 6:return e.p=6,x(!1),e.f(6);case 7:return e.a(2)}},_callee5,null,[[2,5,6,7]])}))).apply(this,arguments)}return(0,a.useEffect)(function(){fetchProfile()},[]),(0,g.jsxs)(l.Ss,{"style":{"minHeight":"100vh","padding":24,"backgroundColor":"#f5f6f8"},"children":[(0,g.jsxs)(l.Ss,{"style":{"marginBottom":24,"textAlign":"center"},"children":[(0,g.jsx)(l._V,{"src":(null==k?void 0:k.avatar)||"https://dummyimage.com/120x120/EEEEEE/333333&text=Tea","style":{"width":120,"height":120,"borderRadius":60,"margin":"0 auto 12px"}}),(0,g.jsx)(l.EY,{"style":{"fontSize":20,"fontWeight":"bold"},"children":k?k.nickname||"微信用户":"请登录"}),(null==k?void 0:k.phone)&&(0,g.jsx)(l.EY,{"style":{"display":"block","marginTop":6,"color":"#666"},"children":k.phone})]}),(0,g.jsxs)(l.Ss,{"style":{"display":"flex","gap":8,"marginBottom":12},"children":[(0,g.jsx)(l.$n,{"style":{"flex":1,"backgroundColor":"phone"===C?"#1677ff":"#f2f3f5","color":"phone"===C?"#fff":"#333"},"onClick":function onClick(){return I("phone")},"children":"手机号登录"}),(0,g.jsx)(l.$n,{"style":{"flex":1,"backgroundColor":"wx"===C?"#07c160":"#f2f3f5","color":"wx"===C?"#fff":"#333"},"onClick":function onClick(){return I("wx")},"children":"微信登录"})]}),"phone"===C&&(0,g.jsxs)(l.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":20,"marginBottom":20},"children":[(0,g.jsx)(l.EY,{"style":{"fontSize":16,"fontWeight":"bold"},"children":"手机号 + 验证码登录"}),(0,g.jsx)(l.EY,{"style":{"display":"block","marginTop":6,"color":"#666"},"children":"在桌面浏览器无法获取微信 code 时使用"}),(0,g.jsx)(l.pd,{"type":"number","placeholder":"请输入手机号","value":W,"onInput":function onInput(n){return R(n.detail.value)},"style":{"marginTop":12,"backgroundColor":"#f7f7f7","borderRadius":6,"padding":8}}),(0,g.jsx)(l.pd,{"type":"number","placeholder":"请输入验证码","value":B,"onInput":function onInput(n){return $(n.detail.value)},"style":{"marginTop":12,"backgroundColor":"#f7f7f7","borderRadius":6,"padding":8}}),(0,g.jsx)(l.Ss,{"style":{"marginTop":8,"color":"#999"},"children":(0,g.jsx)(l.EY,{"children":"默认示例：手机号 18985121575 验证码 000000"})}),(0,g.jsx)(l.$n,{"style":{"marginTop":12,"backgroundColor":"#1677ff","color":"#fff"},"loading":m,"onClick":function handlePhoneLogin(){return _handlePhoneLogin.apply(this,arguments)},"children":"使用手机号登录"})]}),"wx"===C&&(0,g.jsxs)(l.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":20,"marginBottom":20},"children":[(0,g.jsx)(l.EY,{"style":{"fontSize":16,"fontWeight":"bold"},"children":"微信一键登录"}),(0,g.jsx)(l.EY,{"style":{"display":"block","marginTop":6,"color":"#666"},"children":"授权后即可同步订单、优惠券等数据"}),(0,g.jsx)(l.$n,{"style":{"marginTop":16,"backgroundColor":"#07c160","color":"#fff"},"loading":m,"onClick":function handleWxLogin(){return _handleWxLogin.apply(this,arguments)},"children":"使用微信授权登录"})]}),(0,g.jsxs)(l.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":20,"marginBottom":20},"children":[(0,g.jsx)(l.EY,{"style":{"fontSize":16,"fontWeight":"bold"},"children":"开发者 OpenID 登录"}),(0,g.jsx)(l.pd,{"type":"text","placeholder":"admin_openid","value":t,"onInput":function onInput(n){return h(n.detail.value)},"style":{"marginTop":12,"backgroundColor":"#f7f7f7","borderRadius":6,"padding":8}}),(0,g.jsx)(l.$n,{"style":{"marginTop":12},"loading":m,"onClick":function handleDevLogin(){return _handleDevLogin.apply(this,arguments)},"children":"使用 OpenID 登录"})]}),k&&(0,g.jsxs)(l.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":20},"children":[(0,g.jsx)(l.EY,{"style":{"fontSize":16,"fontWeight":"bold"},"children":"已登录"}),(0,g.jsxs)(l.EY,{"style":{"display":"block","marginTop":8},"children":["用户ID：",k.id]}),(0,g.jsx)(l.$n,{"style":{"marginTop":16},"onClick":function handleLogout(){(0,p.WG)(null),_(null),(0,f.P0)({"title":"已退出","icon":"none"})},"children":"退出登录"})]}),!k&&!P&&(0,g.jsx)(l.EY,{"style":{"display":"block","textAlign":"center","marginTop":12,"color":"#888"},"children":"登录后可继续访问商城"})]})}},"3312":function(n,e,t){t.d(e,{"bu":function(){return updateUserInfo},"iD":function(){return login},"ug":function(){return getUserInfo}});var r=t(8646),o=t(6673),i=t(7356);function login(n){return _login.apply(this,arguments)}function _login(){return(_login=(0,o.A)((0,r.A)().m(function _callee(n){var e,t,o,a;return(0,r.A)().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,r.n=1,i.Ay.post("/api/v1/auth/login",n);case 1:return e=r.v,null!=(t=(0,i.Bm)(e))&&t.token&&(0,i.WG)(t.token),r.a(2,t);case 2:return r.p=2,r.v,r.n=3,i.Ay.post("/api/v1/user/login",n);case 3:return o=r.v,null!=(a=(0,i.Bm)(o))&&a.token&&(0,i.WG)(a.token),r.a(2,a)}},_callee,null,[[0,2]])}))).apply(this,arguments)}function getUserInfo(){return _getUserInfo.apply(this,arguments)}function _getUserInfo(){return(_getUserInfo=(0,o.A)((0,r.A)().m(function _callee2(){var n,e,t,o,a;return(0,r.A)().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,r.n=1,i.Ay.get("/api/v1/users/me/summary");case 1:if(e=r.v,t=(0,i.Bm)(e),!(o=(null==t?void 0:t.user)||(null==t||null===(n=t.data)||void 0===n?void 0:n.user))){r.n=2;break}return r.a(2,o);case 2:r.n=4;break;case 3:r.p=3,r.v;case 4:return r.n=5,i.Ay.get("/api/v1/user/info");case 5:return a=r.v,r.a(2,(0,i.Bm)(a))}},_callee2,null,[[0,3]])}))).apply(this,arguments)}function updateUserInfo(n){return _updateUserInfo.apply(this,arguments)}function _updateUserInfo(){return(_updateUserInfo=(0,o.A)((0,r.A)().m(function _callee3(n){var e;return(0,r.A)().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,i.Ay.put("/api/v1/user/info",n);case 1:return e=t.v,t.a(2,(0,i.Bm)(e))}},_callee3)}))).apply(this,arguments)}}}]);