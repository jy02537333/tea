"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[89],{"1089":function(e,r,n){n.r(r),n.d(r,{"default":function(){return AddressManagerPage}});var t=n(6045),a=n(8646),s=n(6673),l=n(9866),o=n(7378),u=n(4657),c=n(8785),d=n(2489),i=n(9624),f=n(4847),p=n(6287),A=n(5219),h=n(6106);function AddressManagerPage(){var e=(0,o.useState)([]),r=(0,l.A)(e,2),n=r[0],_=r[1],v=(0,o.useState)(null),y=(0,l.A)(v,2),m=y[0],g=y[1],D=(0,o.useState)(!1),w=(0,l.A)(D,2),b=w[0],O=w[1],k=(0,o.useState)(null),j=(0,l.A)(k,2),S=j[0],C=j[1];function _bootstrap(){return(_bootstrap=(0,s.A)((0,a.A)().m(function _callee(){return(0,a.A)().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,Promise.all([loadAddresses(),refreshDefaultAddress()]);case 1:return e.a(2)}},_callee)}))).apply(this,arguments)}function refreshDefaultAddress(){return _refreshDefaultAddress.apply(this,arguments)}function _refreshDefaultAddress(){return(_refreshDefaultAddress=(0,s.A)((0,a.A)().m(function _callee2(){var e;return(0,a.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,(0,A.OT)({"refreshRemote":!0});case 1:e=r.v,g(e);case 2:return r.a(2)}},_callee2)}))).apply(this,arguments)}function loadAddresses(){return _loadAddresses.apply(this,arguments)}function _loadAddresses(){return _loadAddresses=(0,s.A)((0,a.A)().m(function _callee3(){var e,r,n,s,l,o,u,c=arguments;return(0,a.A)().w(function(a){for(;;)switch(a.p=a.n){case 0:if(e=c.length>0&&void 0!==c[0]&&c[0],!b||e){a.n=1;break}return a.a(2);case 1:return O(!0),a.p=2,a.n=3,(0,p.MV)({"page":1,"limit":50});case 3:r=a.v,n=(null==r?void 0:r.data)||[],s=n.map(function(e){var r=(0,A.es)(e.address_info);return r?(0,t.A)((0,t.A)({},r),{},{"full":r.full||(0,A.M0)(r),"orderId":e.id,"orderNo":e.order_no,"updatedAt":(null==e?void 0:e.updated_at)||(null==e?void 0:e.created_at)}):null}).filter(Boolean),l=new Map,s.forEach(function(e){var r="".concat(e.full||e.detail||"","-").concat(e.phone||"");l.has(r)||l.set(r,e)}),o=Array.from(l.values()),_(o),C(o.length?null:"暂无可回收的地址，完成一次配送订单即可沉淀地址信息"),a.n=5;break;case 4:a.p=4,u=a.v,console.error("load addresses failed",u),C((null==u?void 0:u.message)||"加载失败");case 5:return a.p=5,O(!1),(0,d.r)(),a.f(5);case 6:return a.a(2)}},_callee3,null,[[2,4,5,6]])})),_loadAddresses.apply(this,arguments)}function _handleSetDefault(){return(_handleSetDefault=(0,s.A)((0,a.A)().m(function _callee4(e){var r;return(0,a.A)().w(function(n){for(;;)switch(n.p=n.n){case 0:return n.p=0,n.n=1,(0,A.ns)(e);case 1:return n.n=2,refreshDefaultAddress();case 2:(0,i.P0)({"title":"默认地址已更新","icon":"success"}),n.n=4;break;case 3:n.p=3,r=n.v,console.error("save default address failed",r),(0,i.P0)({"title":"保存失败，请稍后再试","icon":"none"});case 4:return n.a(2)}},_callee4,null,[[0,3]])}))).apply(this,arguments)}function _handleCopy(){return(_handleCopy=(0,s.A)((0,a.A)().m(function _callee5(e){var r,n;return(0,a.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:if(t.p=0,r=e.full||(0,A.M0)(e)){t.n=1;break}return(0,i.P0)({"title":"地址为空","icon":"none"}),t.a(2);case 1:return t.n=2,(0,f.j)({"data":r});case 2:(0,i.P0)({"title":"已复制","icon":"success"}),t.n=4;break;case 3:t.p=3,n=t.v,console.error("copy address failed",n);case 4:return t.a(2)}},_callee5,null,[[0,3]])}))).apply(this,arguments)}return(0,o.useEffect)(function(){!function bootstrap(){return _bootstrap.apply(this,arguments)}()},[]),c.Ay.usePullDownRefresh(function(){Promise.all([loadAddresses(!0),refreshDefaultAddress()])}),(0,h.jsxs)(u.Ss,{"style":{"padding":16,"backgroundColor":"#f5f6f8","minHeight":"100vh"},"children":[(0,h.jsxs)(u.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":16},"children":[(0,h.jsx)(u.EY,{"style":{"fontSize":18,"fontWeight":"bold"},"children":"默认收货地址"}),m?(0,h.jsxs)(u.Ss,{"style":{"marginTop":12},"children":[(0,h.jsx)(u.EY,{"style":{"display":"block","fontSize":16},"children":(0,A.M0)(m)}),(0,h.jsxs)(u.EY,{"style":{"display":"block","color":"#999","marginTop":4},"children":["最近同步：",m.updatedAt||"未知"]})]}):(0,h.jsx)(u.EY,{"style":{"display":"block","color":"#999","marginTop":12},"children":"尚未设置默认地址，可从下方历史地址选择"})]}),(0,h.jsxs)(u.Ss,{"style":{"backgroundColor":"#fff","borderRadius":12,"padding":16,"marginTop":16},"children":[(0,h.jsxs)(u.Ss,{"style":{"display":"flex","justifyContent":"space-between","alignItems":"center"},"children":[(0,h.jsx)(u.EY,{"style":{"fontSize":18,"fontWeight":"bold"},"children":"历史地址"}),(0,h.jsx)(u.$n,{"size":"mini","loading":b,"onClick":function onClick(){return loadAddresses(!0)},"children":"刷新"})]}),S&&(0,h.jsx)(u.EY,{"style":{"color":"#ff4d4f","display":"block","marginTop":12},"children":S}),!S&&!n.length&&(0,h.jsx)(u.EY,{"style":{"color":"#999","display":"block","marginTop":12},"children":"暂无数据"}),n.map(function(e){return(0,h.jsxs)(u.Ss,{"style":{"marginTop":12,"borderTop":"1px solid #f0f0f0","paddingTop":12},"children":[(0,h.jsx)(u.EY,{"style":{"display":"block","fontSize":16},"children":(0,A.M0)(e)}),(0,h.jsxs)(u.EY,{"style":{"color":"#999","fontSize":12},"children":["来源订单 #",e.orderNo]}),(0,h.jsxs)(u.Ss,{"style":{"display":"flex","marginTop":8,"gap":8},"children":[(0,h.jsx)(u.$n,{"size":"mini","onClick":function onClick(){return function handleSetDefault(e){return _handleSetDefault.apply(this,arguments)}(e)},"children":"设为默认"}),(0,h.jsx)(u.$n,{"size":"mini","onClick":function onClick(){return function handleCopy(e){return _handleCopy.apply(this,arguments)}(e)},"children":"复制"})]})]},"".concat(e.orderId,"-").concat(e.detail))})]}),(0,h.jsx)(u.Ss,{"style":{"marginTop":24},"children":(0,h.jsx)(u.$n,{"type":"primary","onClick":function onClick(){return c.Ay.navigateTo({"url":"/pages/checkout/index"})},"children":"去下单填写新地址"})})]})}},"6287":function(e,r,n){n.d(r,{"Ad":function(){return confirmReceive},"MV":function(){return listOrders},"N4":function(){return cancelOrder},"SK":function(){return getAvailableCouponsForOrder},"Tg":function(){return payOrder},"X9":function(){return createOrderFromCart},"r$":function(){return getOrder}});var t=n(8646),a=n(6673),s=n(7356);function createOrderFromCart(e){return _createOrderFromCart.apply(this,arguments)}function _createOrderFromCart(){return(_createOrderFromCart=(0,a.A)((0,t.A)().m(function _callee(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,s.Ay.post("/api/v1/orders/from-cart",e);case 1:return r=n.v,n.a(2,(0,s.Bm)(r))}},_callee)}))).apply(this,arguments)}function listOrders(){return _listOrders.apply(this,arguments)}function _listOrders(){return _listOrders=(0,a.A)((0,t.A)().m(function _callee2(){var e,r,n=arguments;return(0,t.A)().w(function(t){for(;;)switch(t.n){case 0:return e=n.length>0&&void 0!==n[0]?n[0]:{},t.n=1,s.Ay.get("/api/v1/orders",{"params":e});case 1:return r=t.v,t.a(2,(0,s.Bm)(r))}},_callee2)})),_listOrders.apply(this,arguments)}function getOrder(e){return _getOrder.apply(this,arguments)}function _getOrder(){return(_getOrder=(0,a.A)((0,t.A)().m(function _callee3(e){var r,n;return(0,t.A)().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,s.Ay.get("/api/v1/orders/".concat(e));case 1:return r=t.v,n=(0,s.Bm)(r),t.a(2,{"order":null==n?void 0:n.order,"items":Array.isArray(null==n?void 0:n.items)?n.items:[]})}},_callee3)}))).apply(this,arguments)}function cancelOrder(e,r){return _cancelOrder.apply(this,arguments)}function _cancelOrder(){return(_cancelOrder=(0,a.A)((0,t.A)().m(function _callee4(e,r){var n;return(0,t.A)().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,s.Ay.post("/api/v1/orders/".concat(e,"/cancel"),{"reason":r});case 1:n=t.v,(0,s.Bm)(n);case 2:return t.a(2)}},_callee4)}))).apply(this,arguments)}function payOrder(e){return _payOrder.apply(this,arguments)}function _payOrder(){return(_payOrder=(0,a.A)((0,t.A)().m(function _callee5(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,s.Ay.post("/api/v1/orders/".concat(e,"/pay"));case 1:r=n.v,(0,s.Bm)(r);case 2:return n.a(2)}},_callee5)}))).apply(this,arguments)}function confirmReceive(e){return _confirmReceive.apply(this,arguments)}function _confirmReceive(){return(_confirmReceive=(0,a.A)((0,t.A)().m(function _callee6(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,s.Ay.post("/api/v1/orders/".concat(e,"/receive"));case 1:r=n.v,(0,s.Bm)(r);case 2:return n.a(2)}},_callee6)}))).apply(this,arguments)}function getAvailableCouponsForOrder(e){return _getAvailableCouponsForOrder.apply(this,arguments)}function _getAvailableCouponsForOrder(){return(_getAvailableCouponsForOrder=(0,a.A)((0,t.A)().m(function _callee7(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,s.Ay.post("/api/v1/orders/available-coupons",e);case 1:return r=n.v,n.a(2,(0,s.Bm)(r))}},_callee7)}))).apply(this,arguments)}},"5219":function(e,r,n){n.d(r,{"M0":function(){return formatAddress},"OT":function(){return loadDefaultAddress},"es":function(){return parseAddressInfo},"ns":function(){return saveDefaultAddress}});var t=n(8646),a=n(6045),s=n(6673),l=n(3846),o=n(6244),u=n(7356);function fetchDefaultAddress(){return _fetchDefaultAddress.apply(this,arguments)}function _fetchDefaultAddress(){return(_fetchDefaultAddress=(0,s.A)((0,t.A)().m(function _callee(){var e;return(0,t.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,u.Ay.get("/api/v1/user/default-address");case 1:return e=r.v,r.a(2,(0,u.Bm)(e))}},_callee)}))).apply(this,arguments)}function updateDefaultAddress(e){return _updateDefaultAddress.apply(this,arguments)}function _updateDefaultAddress(){return(_updateDefaultAddress=(0,s.A)((0,t.A)().m(function _callee2(e){var r;return(0,t.A)().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,u.Ay.put("/api/v1/user/default-address",{"address":e});case 1:return r=n.v,n.a(2,(0,u.Bm)(r))}},_callee2)}))).apply(this,arguments)}var c="tea_default_address";function parseAddressInfo(e){if(!e)return null;var r=e;if("string"==typeof r){var n=r.trim();if(!n)return null;try{r=JSON.parse(n)}catch(e){return{"detail":n,"full":n}}}if("object"===(0,l.A)(r)&&null!==r){var t=r.name||r.contact||r.receiver||r.consignee||r.userName,a=r.phone||r.mobile||r.tel||r.telNumber,s=[r.province,r.city,r.county,r.area,r.street,r.detail,r.detailInfo,r.address,r.full].filter(function(e){return"string"==typeof e&&e.trim().length>0}).map(function(e){return e.trim()}),o=r.detail||r.detailInfo||r.address||s.join(""),u=r.full||o||s.join("");return{"contact":t,"phone":a,"detail":o||u,"full":u||o}}return null}function formatAddress(e){return e?[e.contact,e.phone,e.detail||e.full].filter(function(e){return!!e}).join(" · "):""}function loadLocalDefaultAddress(){return _loadLocalDefaultAddress.apply(this,arguments)}function _loadLocalDefaultAddress(){return(_loadLocalDefaultAddress=(0,s.A)((0,t.A)().m(function _callee(){var e;return(0,t.A)().w(function(r){for(;;)switch(r.p=r.n){case 0:return r.p=0,r.n=1,(0,o.c7)({"key":c});case 1:return e=r.v,r.a(2,e.data);case 2:return r.p=2,r.v,r.a(2,null)}},_callee,null,[[0,2]])}))).apply(this,arguments)}function saveLocalDefaultAddress(e){return _saveLocalDefaultAddress.apply(this,arguments)}function _saveLocalDefaultAddress(){return(_saveLocalDefaultAddress=(0,s.A)((0,t.A)().m(function _callee2(e){return(0,t.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,(0,o.cT)({"key":c,"data":e});case 1:return r.a(2)}},_callee2)}))).apply(this,arguments)}function toStoredAddress(e,r){var n=parseAddressInfo(e);if(!n)return null;var t=(0,a.A)((0,a.A)({},n),{},{"full":n.full||n.detail,"detail":n.detail||n.full,"updatedAt":null==r?void 0:r.updatedAt,"timestamp":Date.now(),"source":null==r?void 0:r.source});if(e&&"object"===(0,l.A)(e)){var s=e;s.orderId&&(t.orderId=Number(s.orderId)),s.orderNo&&(t.orderNo=String(s.orderNo))}return t}function fetchRemoteDefaultAddress(){return _fetchRemoteDefaultAddress.apply(this,arguments)}function _fetchRemoteDefaultAddress(){return(_fetchRemoteDefaultAddress=(0,s.A)((0,t.A)().m(function _callee3(){var e;return(0,t.A)().w(function(r){for(;;)switch(r.n){case 0:return r.n=1,fetchDefaultAddress();case 1:if(null!=(e=r.v)&&e.address){r.n=2;break}return r.a(2,null);case 2:return r.a(2,toStoredAddress(e.address,{"updatedAt":e.updated_at||void 0,"source":"server"}))}},_callee3)}))).apply(this,arguments)}function loadDefaultAddress(e){return _loadDefaultAddress.apply(this,arguments)}function _loadDefaultAddress(){return(_loadDefaultAddress=(0,s.A)((0,t.A)().m(function _callee4(e){var r,n;return(0,t.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:if(!1===(null==e?void 0:e.refreshRemote)){t.n=6;break}return t.p=1,t.n=2,fetchRemoteDefaultAddress();case 2:if(!(r=t.v)){t.n=4;break}return t.n=3,saveLocalDefaultAddress(r);case 3:return t.a(2,r);case 4:t.n=6;break;case 5:t.p=5,n=t.v,console.error("load remote default address failed",n);case 6:return t.a(2,loadLocalDefaultAddress())}},_callee4,null,[[1,5]])}))).apply(this,arguments)}function saveDefaultAddress(e,r){return _saveDefaultAddress.apply(this,arguments)}function _saveDefaultAddress(){return(_saveDefaultAddress=(0,s.A)((0,t.A)().m(function _callee5(e,r){var n,s;return(0,t.A)().w(function(t){for(;;)switch(t.p=t.n){case 0:return n=(0,a.A)((0,a.A)({},e),{},{"timestamp":Date.now()}),t.n=1,saveLocalDefaultAddress(n);case 1:if(!1!==(null==r?void 0:r.syncRemote)){t.n=2;break}return t.a(2);case 2:return t.p=2,t.n=3,updateDefaultAddress({"contact":n.contact,"phone":n.phone,"detail":n.detail,"full":n.full,"orderId":n.orderId,"orderNo":n.orderNo,"updatedAt":n.updatedAt||(new Date).toISOString()});case 3:t.n=5;break;case 4:t.p=4,s=t.v,console.error("sync default address to server failed",s);case 5:return t.a(2)}},_callee5,null,[[2,4]])}))).apply(this,arguments)}}}]);