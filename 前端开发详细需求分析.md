
**前端开发详细需求分析（Admin-FE 与 WX-FE）**

说明：本文件逐页列出 UI 布局、组件、与 `tea-api` 的接口对接参数、页面内交互与跳转逻辑，供前端开发与联调使用。

**通用约定**
- 全局 axios（或 Taro/uni-app 请求封装）配置：
  - `baseURL`：环境变量 `VITE_API_BASE_URL` 或小程序环境配置
  - 请求拦截器：如果存在 `token`（存于 `localStorage` / 小程序 `storage`），自动注入 `Authorization: Bearer <token>`。
  - 响应拦截器：统一处理 401（清理 token 并跳转登录）、500 显示通用错误弹窗。
- 分页：参数 `page`（默认 1）、`limit`（默认 20）；响应使用统一分页格式：{ data: [...], total: N, page: P, limit: L } 或后端返回的成功/分页字段。
- 时间格式：后端使用 `YYYY-MM-DD` 或完整时间 `YYYY-MM-DD HH:mm:ss`，前端按需格式化。
- 错误提示：统一使用 `Message`/`Toast` 展示 `error.message` 或后端返回 `message`。
- 权限控制：admin-fe 内部按后端 `GET /api/v1/admin/rbac/user-permissions?user_id=` 获取权限列表，基于权限渲染按钮/路由。

**共享组件（建议实现）**
- `AppLayout`：左侧导航 + 顶部栏 + 内容区（用于 admin-fe）
- `DataTable`：封装表格、分页、筛选、批量选择、导出按钮
- `CrudModal`：通用新建/编辑 Modal（表单验证）
- `Uploader`：图片/资源上传（返回 URL），支持多图
- `SearchFilter`：统一的筛选栏（文本/下拉/日期/范围）
- `EntityCard` / `ProductCard`：商品卡片（wx-fe 列表、admin 快速预览）

**Admin-FE 页面详细需求**

**登录页** `#/login`
- 布局：居中卡片，表单（账号/密码 或 dev-login openid 字段备用）
- 字段：
  - `username` (string)
  - `password` (string)
  - `openid` (仅开发选项)
- 接口：
  - `POST /api/v1/user/login`：支持 `{ code }` / `{ username,password }` / `{ openid }`，建议前端先尝试 `code`（微信登录），否则 prompt 用户走用户名密码或 dev 登录（仅 dev 环境）。
  - `POST /api/v1/user/dev-login`：dev 环境直接通过 openid 登录
- 交互：
  - 成功存 `token` 并跳转到 `#/dashboard`。
  - 登录失败显示错误。

**仪表盘** `#/dashboard`
- 布局：顶部统计卡（record_count / user_count / total_interest）、折线/柱状图（近 7/30 天），最近任务列表、快速操作按钮（触发计提、导出）
- 接口：
  - `GET /api/v1/admin/accrual/summary?start=YYYY-MM-DD&end=YYYY-MM-DD` -> 返回汇总数据
  - 触发计提按钮 -> `POST /api/v1/admin/accrual/run`（body 可选 date/rate），请求后展示进度或成功提示
- 导航：点击报表跳 `#/accrual`，点击用户卡跳 `#/users?user_id=...`

**计提 / 报表页** `#/accrual`
- 布局：筛选栏（日期区间、user_id、format 选择），主区域为表格/导出按钮
- 接口：
  - `GET /api/v1/admin/accrual/summary?start=&end=`（展示汇总）
  - `GET /api/v1/admin/accrual/export?start=&end=&format=csv|xlsx&lang=zh|en&zip=1`（导出，前端需使用 `responseType: 'blob'`）
  - `POST /api/v1/admin/accrual/run`（触发计提）
- 交互：
  - 导出：请求下载并提示完成；支持选择字段（fields 参数）
  - 运行：确认弹窗 -> POST -> 显示运行结果数字

**用户管理** `#/users`
- 布局：表格（头像、id、昵称、手机号、注册时间、角色）、右侧/弹窗查看用户详情
- 接口：
  - `GET /api/v1/admin/users?page=&limit=&user_id=` -> 分页或精确查询
  - `GET /api/v1/user/:id` -> 用户详情（兼容 public）
  - 若需编辑/禁用用户：调用相应后端服务（如不存在需后端补充）
- 交互与权限：仅 admin 可访问此页，支持按 `user_id` 精确查找（Admin-FE 登录后 token 中 user_id 可用于权限校验）。

**RBAC 管理** `#/rbac`
- 布局：左侧角色列表，右侧权限树与已分配权限，顶部操作按钮（新建角色、删除、分配权限）
- 接口：
  - `GET /api/v1/admin/rbac/roles`
  - `GET /api/v1/admin/rbac/permissions`
  - `GET /api/v1/admin/rbac/role-permissions?role_id=`
  - `GET /api/v1/admin/rbac/user-permissions?user_id=`
  - `POST /api/v1/admin/rbac/role` {name, display_name}
  - `POST /api/v1/admin/rbac/role/assign-permissions` { role_id, permission_ids }
  - `POST /api/v1/admin/rbac/user/assign-role` { user_id, role_id }
- 交互：
  - 选择角色后加载权限树与已选项，支持批量分配权限 -> 提交 assign-permissions
  - 分配角色到用户：在用户详情页内可选择角色并调用 assign-role

**商品分类管理** `#/categories`
- 布局：表格或树形视图（支持父子关系），`新建`/`编辑`/`删除`按钮
- 接口：
  - `GET /api/v1/categories?parent_id=&status=`
  - `POST /api/v1/categories` { name, description, sort, parent_id, image, status }
  - `PUT /api/v1/categories/:id` 更新
  - `DELETE /api/v1/categories/:id`
- 交互：
  - 新建成功后刷新列表；删除需二次确认

**商品管理** `#/products`
- 布局：表格（图片、名称、分类、价格、库存、状态、操作），支持批量上下架/删除、搜索、筛选
- 列表接口：
  - `GET /api/v1/products?page=&limit=&category_id=&status=&keyword=&store_id=`（支持 store_id 获取门店覆盖价）
- 新建/编辑：
  - `POST /api/v1/products` body: name, category_id, price, original_price, images, stock, status, sort, is_hot, is_new, is_recommend
  - `PUT /api/v1/products/:id` 更新
  - `PUT /api/v1/products/:id/stock` 更新库存 { stock, action: add|sub|set }
- 商品详情页/Modal：展示完整字段和销售记录（如后端提供）
- 交互：图片上传使用 `Uploader`，价格字段支持字符串或数字输入（兼容后端解析），保存成功刷新列表。

**门店管理** `#/stores`
- 布局：表格 + 地图小预览（可选），字段：id、名称、地址、电话、经纬度、营业时间、状态
- 接口：
  - `GET /api/v1/stores?page=&limit=&lat=&lng=&status=`
  - `GET /api/v1/stores/:id`
  - `POST /api/v1/stores` { name, address, phone, latitude, longitude, business_hours, images, status }
  - `PUT /api/v1/stores/:id`
  - `DELETE /api/v1/stores/:id`
- 交互：创建/编辑表单需要经纬度输入校验（浮点数范围），删除需确认。

**管理端订单** `#/orders`（Admin）
- 布局：筛选栏（日期区间、status、store_id、keyword），表格，详情 Slide-over
- 接口：
  - `GET /api/v1/admin/orders?page=&limit=&status=&store_id=`
  - `GET /api/v1/admin/orders/export?status=&store_id=` -> 返回 CSV（下载）
  - `GET /api/v1/admin/orders/:id` -> 详情
  - 管理操作：`POST /api/v1/orders/:id/deliver|complete|admin-cancel|refund|refund/start|refund/confirm`（需权限）
- 交互：导出使用 blob 下载；管理操作弹出确认并记录操作日志（前端可在成功后刷新列表与详情）。

**操作日志 / 访问日志** `#/logs`
- 布局：筛选（用户、模块、operation、时间范围、关键字），表格、导出
- 接口：
  - `GET /api/v1/admin/logs/operations?page=&limit=&...`
  - `GET /api/v1/admin/logs/operations/export`（下载）
  - `GET /api/v1/admin/logs/access` / `export`

**退款 / 财务 / 提现管理**
- 布局与交互：列表 + 详情 + 批量导出 + 审核（approve/complete/reject）操作
- 关键接口参考：
  - `GET /api/v1/admin/refunds`、`/export`
  - `GET /api/v1/admin/payments`、`/export`
  - `GET /api/v1/admin/withdraws`、`POST /api/v1/admin/withdraws/:id/approve|complete|reject`

**Wx-FE 页面详细需求（小程序/跨端）**

注意：优先实现购物流程（浏览 -> 加入购物车 -> 结算 -> 下单 -> 支付确认），保持简单明了的 UX。

**首页** `pages/index`
- 布局：顶部搜索栏，分类横滑卡片，推荐商品区（轮播/卡片），门店附近推荐
- 接口：
  - `GET /api/v1/categories`（用于顶部分类）
  - `GET /api/v1/products?page=&limit=&keyword=&category_id=&store_id=`（商品数据）
  - `GET /api/v1/stores?lat=&lng=&page=&limit=`（附近门店）
- 交互：搜索跳转到 `pages/products?keyword=...`；点击商品进入 `pages/product?id=`；点击门店改变当前 `store_id` 并刷新商品。

**分类 / 商品列表** `pages/category`, `pages/products`
- 布局：筛选栏（分类/价格区间/排序），商品网格（ProductCard）
- 接口：`GET /api/v1/products`（支持 `category_id`, `keyword`, `store_id`, `page`, `limit`）
- 交互：点击商品进入详情；长列表支持下拉加载（分页）并有空状态提示。

**商品详情** `pages/product?id=`
- 布局：图片轮播、标题/价格/原价、库存、规格（若有）、加入购物车/立即购买按钮、商品详情富文本
- 接口：
  - `GET /api/v1/products/:id?store_id=` -> 返回商品详情（若传 store_id 则含门店库存/覆盖价）
  - `POST /api/v1/cart/items` -> { product_id, sku_id, quantity }
- 交互：
  - 点击加入购物车 -> 请求添加；成功后显示浮层并更新右上角购物车徽章
  - 立即购买 -> 跳转 `pages/checkout` 并携带选中商品信息

**购物车** `pages/cart`
- 布局：条目列表（图片 + 标题 + 数量选择器 + 删除），底部合计与结算按钮
- 接口：
  - `GET /api/v1/cart` -> 列表
  - `PUT /api/v1/cart/items/:id` -> 更新数量 { quantity }
  - `DELETE /api/v1/cart/items/:id` -> 删除
  - `DELETE /api/v1/cart/clear` -> 清空
- 交互：选择多个条目结算 -> 跳转 `pages/checkout` 携带选中条目 id 列表

**结算 / 下单** `pages/checkout`
- 布局：收货地址组件（或自取门店选择）、商品清单、优惠券选择、备注、支付按钮
- 接口：
  - `POST /api/v1/orders/from-cart` -> { delivery_type, address_info, remark, user_coupon_id, store_id, order_type }
  - 支付：`POST /api/v1/payment/intents`（创建支付 intent，若使用第三方则在后端完成）
- 交互：
  - 提交订单后跳转 `pages/order-detail?id=` 并显示支付/待支付状态
  - 若后端返回需要模拟支付，调用 `POST /api/v1/orders/:id/pay` 或 `payment/intents` 并根据返回展示结果

**我的 / 订单列表 / 订单详情** `pages/profile`, `pages/orders`, `pages/order-detail?id=`
- 布局：个人资料、订单状态快捷入口、订单列表按状态分组
- 接口：
  - `GET /api/v1/orders?page=&limit=&status=&store_id=` -> 用户订单列表
  - `GET /api/v1/orders/:id` -> 订单详情
  - 订单操作：取消 `/api/v1/orders/:id/cancel`、确认收货 `/api/v1/orders/:id/receive`、支付 `/api/v1/orders/:id/pay`
- 交互：订单详情显示商品与物流/备注，支持再次购买/售后入口（若后端支持）

**优惠券** `pages/coupons`
- 布局：可用优惠券与已领优惠券，两栏展示
- 接口：
  - `GET /api/v1/coupons` -> 可用优惠券
  - `POST /api/v1/coupons/grant` -> 领取（需要登录）
  - `GET /api/v1/user/coupons` -> 我的优惠券

**辅助页面**
- 健康检查：`GET /api/v1/health`（UI 调试或监控短链）
- 模型生成（如果启用）：`POST /api/v1/model/generate`（受限，带限流）

**页面间跳转逻辑（概要）**
- 未登录用户访问需要登录的页面（如 `cart/checkout/profile/orders`）时：
  - 检查本地 token；若不存在，导航至 `#/login`（admin）或小程序授权页；登录成功后回跳到原页面（使用 redirect 参数）。
- 典型流程（wx-fe）：`index` -> 点击商品 -> `product` -> 加入购物车 -> `cart` -> 勾选商品 -> `checkout` -> 下单 -> `order-detail` -> `orders`。
- 管理端典型流程：登录 -> `dashboard` -> 点击统计项/报表 -> `accrual`/`orders` -> 进入 `orders/:id` 执行管理操作 -> 返回并刷新列表。

**接口字段与前端校验规则（关键项）**
- 登录：`code` 或 `username/password` 或 `openid`，username/password 非空，password 长度 >= 6（前端可提示）
- 商品：`name` 必填、`price` 数字或字符串可解析为两位小数、`category_id` 必填且为正整数
- 购物车：`product_id` 必填，`quantity` >=1
- 下单：`delivery_type` 必填（1 或 2），若 `delivery_type=2` 则 `address_info` 必填
- 门店经纬度：`latitude` (-90~90), `longitude` (-180~180)

**前端测试 / Mock 建议**
- 使用 MSW（mock service worker）或本地 mock-server 在前期开发时返回典型响应，方便离线开发。
- 为导出/文件流接口使用 mock 返回小 CSV/xlsx 文件便于 UI 验证下载流程。

**联调与验收要点**
- 列出必须联调的接口（登录、商品列表/详情、购物车、下单、支付、订单列表/详情、用户 info、RBAC 列表/权限）并逐个确认请求/响应字段与错误码
- 在 PR 合并前确保关键流程 E2E 覆盖（登录 -> 下单 -> 支付 -> 订单确认；Admin: 登录 -> 查看订单 -> 导出）

---
此文档为详细需求层级的第一版；我可以：
- 将每个页面的 request/response 示例生成为 TypeScript `services/*.ts` 模板；或
- 把每个页面拆成任务卡（含完成标准）方便分配开发与 QA。

如需我继续：请选择要执行的下步（生成 services 模板 / 生成任务卡 / 立即 scaffold admin-fe/wx-fe）。

## 页面布局示例（线框 + 组件映射 + 样式建议）

以下为针对 Admin-FE 与 WX-FE 的视觉线框（ASCII）、组件映射与样式建议，便于前端快速实现页面骨架。

### Admin-FE 全局结构（线框）
```
+---------------------------------------------------------------------+
| TOP BAR: Logo | Search  | QuickActions | Notifications | Avatar ▼   |
+---------------------------------------------------------------------+
| SIDER (240px) | BREADCRUMB / PAGE TITLE                            |
| - Dashboard    | ------------------------------------------------  |
| - Users        | | CARD: KPIs (3-4 cards)                         | |
| - Products     | |------------------------------------------------| |
| - Orders       | | MAIN: Table / Charts / Filters                 | |
| - RBAC         | |                                                | |
|                | ------------------------------------------------  |
+---------------------------------------------------------------------+
```

- 组件映射：Ant Design `Layout`（`Sider` + `Header` + `Content`）、`Menu`、`Breadcrumb`。
- 样式建议：侧栏宽度 220-260px；主内容区最大宽度 1200-1400px；全局间距 16/24px。

### Admin 仪表盘（线框）
```
[Page Title: 仪表盘]
[Top row: 卡片 x4]  -> record_count / user_count / total_interest / 今日订单
[Mid: 图表 (折线/柱状) 左  |  最近任务/日志 右]
[Bottom: 快速操作按钮：触发计提 / 导出报表 / 新建商品]
```

- 推荐组件：`Card`, `Row`/`Col`, `Statistic`, ECharts/AntD Charts。
- 关键交互：卡片点击跳转到对应报表页，快速操作弹出确认框。

### 通用列表页（线框）
```
[Page Title] [搜索栏/筛选栏]
[操作按钮: 新建 / 导出 / 批量操作]
[Table: 列 (checkbox, id, name, category, price, stock, status, actions)]
[分页]
```

- 推荐组件：AntD `Table`（`rowSelection`）、`Form`（筛选）、`Modal` / `Drawer`（编辑/详情）。
- 行操作：查看（Drawer）/ 编辑（Modal）/ 删除（确认）/ 批量导出。

### RBAC 管理（线框）
```
[Left: Role List]  [Right Top: Permission Tree]  [Right Bottom: Role -> Permission Table]
[Buttons: 新建角色 / 删除角色 / 分配权限 / 导出]
```

- 推荐组件：`Tree`（权限树）、`Transfer` 或自定义复选树用于分配权限。

### 导出文件处理（前端实现要点）
- axios 请求需设置 `responseType: 'blob'`。
- 后端返回 CSV 或 XLSX，前端创建 Blob 并触发下载：
  - const url = window.URL.createObjectURL(blob)
  - 创建 a 链接设置 `href`/`download` 并 click，然后 revokeObjectURL。

---

### 微信端（WX-FE）全局结构（线框）
```
+----------------------------+
| NAV BAR: logo | search     |
+----------------------------+
| Content (scrollable)       |
| - Banner / Swiper          |
| - Category chips (h-scroll)|
| - Product grid (2-col)     |
|                            |
+----------------------------+
| TAB BAR: Home | Category | Cart | Profile |
+----------------------------+
```

- 设计基准：移动端以 375px 宽为参考（iPhone 8/11 基准），按钮高度 44px，主字体 14-16px。

### 首页线框
```
[NavBar: 搜索框]
[Banner 轮播]
[Category 横滑列表（小圆卡）]
[推荐商品（Section: 热销/新品） -> ProductCard 网格]
[门店推荐/附近门店列表]
```

- 推荐组件：Vant `Swiper`, `Grid`, `Search`；自定义 `ProductCard`（图片 + 标题 + 价格）。

### 商品详情（移动端）
```
[Swiper 图片]
[Title]
[Price] [OriginalPrice]
[库存/销量] [规格选择]
[数量选择器] [加入购物车][立即购买]
[商品详情富文本]
```

- 关键交互：加入购物车 -> 更新购物车徽章；立即购买 -> 进入结算页面并携带商品信息。

### 购物车与结算（移动端要点）
- 购物车：列表支持 Checkbox/选择、多项结算、删除交互（SwipeCell 或 长按），底部浮动结算条。
- 结算：支持选择地址或自取门店、优惠券选择、展示运费/优惠后价格。
- 下单成功后跳转 `order-detail` 并显示支付按钮或支付结果。

---

如需，我可以把以上线框转换为：
- 可复制的 React + AntD 页面骨架（`pages/Dashboard.tsx`, `pages/Products.tsx` 等），含基本样式与占位组件；或
- Taro 小程序页面骨架（`pages/index/index.tsx`, `pages/product/index.tsx`），含 Vant 组件调用示例。

请告诉我你想要的输出格式（React 模板 / Taro 模板 / 仅 MD 线框），我会把对应文件生成到项目中。

